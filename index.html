<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">

<meta name="theme-color" content="#000000"><meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Isa Paes"><link rel="manifest" href="/inverno-2026/manifest.json">
<link rel="apple-touch-icon" href="icon-192.png"><title>Isa Paes</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#000;--card:#111;--card2:#1a1a1a;--accent:#e94560;--green:#00d9a5;--warn:#ffc107;--red:#ff4757;--txt:#fff;--txt2:#777;--brd:#222}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh}

/* SPLASH */
.splash{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:40px 20px;box-sizing:border-box}
.splash.fade-out{opacity:0;pointer-events:none;transition:opacity .3s ease}
.splash-logo{width:200px;height:auto;opacity:0.9;object-fit:contain;flex-shrink:0}
.splash-logo.first-visit{animation:splashLogoZoom 1.2s cubic-bezier(0.7,0,1,0.5) forwards;animation-delay:var(--splash-icons-end, 2.4s)}
.splash-logo.revisit{opacity:0.9}
.splash-icons{margin-top:32px;display:flex;gap:20px;font-size:24px}
.splash-icon{opacity:0.3}
.first-visit ~ .splash-icons .splash-icon:nth-child(1){animation:splashIcon 0.8s ease-in-out forwards}
.first-visit ~ .splash-icons .splash-icon:nth-child(2){animation:splashIcon 0.8s ease-in-out 0.3s forwards}
.first-visit ~ .splash-icons .splash-icon:nth-child(3){animation:splashIcon 0.8s ease-in-out 0.6s forwards}
.first-visit ~ .splash-icons .splash-icon:nth-child(4){animation:splashIcon 0.8s ease-in-out 0.9s forwards}
.first-visit ~ .splash-icons .splash-icon:nth-child(5){animation:splashIcon 0.8s ease-in-out 1.2s forwards}
.revisit ~ .splash-icons .splash-icon:nth-child(1){animation:splashIcon 0.6s ease-in-out forwards}
.revisit ~ .splash-icons .splash-icon:nth-child(2){animation:splashIcon 0.6s ease-in-out 0.15s forwards}
.revisit ~ .splash-icons .splash-icon:nth-child(3){animation:splashIcon 0.6s ease-in-out 0.3s forwards}
.revisit ~ .splash-icons .splash-icon:nth-child(4){animation:splashIcon 0.6s ease-in-out 0.45s forwards}
.revisit ~ .splash-icons .splash-icon:nth-child(5){animation:splashIcon 0.6s ease-in-out 0.6s forwards}
@keyframes splashLogoZoom{0%{opacity:0.9;transform:scale(1)}100%{opacity:0;transform:scale(30)}}
@keyframes splashIcon{0%{opacity:0.3;transform:scale(1)}40%{opacity:1;transform:scale(1.2)}80%{opacity:0.3;transform:scale(1)}100%{opacity:0;transform:scale(0.8)}}

/* WELCOME SCREEN */
.welcome-screen{position:fixed;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9998;opacity:0;transition:opacity .5s ease;overflow:hidden}
.welcome-screen.active{display:flex;opacity:1}
.welcome-screen.fade-out{opacity:0}

/* Céu Noturno - Estrelas */
.welcome-screen.night{background:linear-gradient(to bottom,#0a0a1a 0%,#1a1a3a 50%,#2a2a4a 100%)}
.stars{position:absolute;top:0;left:0;width:200%;height:100%;background-image:radial-gradient(2px 2px at 20px 30px,#fff,transparent),radial-gradient(2px 2px at 40px 70px,rgba(255,255,255,0.8),transparent),radial-gradient(1px 1px at 90px 40px,#fff,transparent),radial-gradient(2px 2px at 160px 120px,rgba(255,255,255,0.9),transparent),radial-gradient(1px 1px at 230px 80px,#fff,transparent),radial-gradient(2px 2px at 300px 150px,rgba(255,255,255,0.7),transparent),radial-gradient(1px 1px at 370px 50px,#fff,transparent),radial-gradient(2px 2px at 450px 180px,rgba(255,255,255,0.8),transparent),radial-gradient(1px 1px at 520px 90px,#fff,transparent),radial-gradient(2px 2px at 600px 130px,#fff,transparent),radial-gradient(1px 1px at 680px 60px,rgba(255,255,255,0.9),transparent),radial-gradient(2px 2px at 750px 170px,#fff,transparent);background-size:800px 200px;animation:starsMove 60s linear infinite}
@keyframes starsMove{from{transform:translateX(0)}to{transform:translateX(-50%)}}

/* Céu Diurno - Sol e Nuvens */
.welcome-screen.morning{background:linear-gradient(to bottom,#87CEEB 0%,#B0E0E6 50%,#E0F6FF 100%)}
.clouds{position:absolute;top:0;left:0;width:200%;height:100%}
.cloud{position:absolute;background:#fff;border-radius:50px;opacity:0.9;box-shadow:0 8px 16px rgba(0,0,0,0.1)}
.cloud::before,.cloud::after{content:'';position:absolute;background:#fff;border-radius:50%}
.cloud-1{width:100px;height:40px;top:15%;left:10%;animation:cloudsMove 40s linear infinite}
.cloud-1::before{width:50px;height:50px;top:-25px;left:15px}
.cloud-1::after{width:35px;height:35px;top:-15px;left:55px}
.cloud-2{width:80px;height:32px;top:25%;left:60%;animation:cloudsMove 50s linear infinite;animation-delay:-20s}
.cloud-2::before{width:40px;height:40px;top:-20px;left:12px}
.cloud-2::after{width:28px;height:28px;top:-12px;left:44px}
.cloud-3{width:120px;height:48px;top:35%;left:30%;animation:cloudsMove 45s linear infinite;animation-delay:-10s}
.cloud-3::before{width:60px;height:60px;top:-30px;left:18px}
.cloud-3::after{width:42px;height:42px;top:-18px;left:66px}
.sun{position:absolute;top:10%;right:15%;width:80px;height:80px;background:radial-gradient(circle,#FFD700 0%,#FFA500 100%);border-radius:50%;box-shadow:0 0 60px #FFD700,0 0 100px rgba(255,215,0,0.5);animation:sunGlow 3s ease-in-out infinite}
@keyframes cloudsMove{from{transform:translateX(0)}to{transform:translateX(-50%)}}
@keyframes sunGlow{0%,100%{box-shadow:0 0 60px #FFD700,0 0 100px rgba(255,215,0,0.5)}50%{box-shadow:0 0 80px #FFD700,0 0 120px rgba(255,215,0,0.6)}}

/* Céu Tarde - Pôr do Sol */
.welcome-screen.afternoon{background:linear-gradient(to bottom,#FF6B6B 0%,#FF8E53 30%,#FFA07A 50%,#FFB347 70%,#9B59B6 100%)}
.sunset-clouds{position:absolute;top:0;left:0;width:200%;height:100%}
.sunset-cloud{position:absolute;background:linear-gradient(to bottom,rgba(255,150,100,0.8),rgba(255,100,100,0.6));border-radius:50px;filter:blur(2px)}
.sunset-cloud-1{width:150px;height:30px;top:40%;left:5%;animation:cloudsMove 55s linear infinite}
.sunset-cloud-2{width:200px;height:40px;top:50%;left:40%;animation:cloudsMove 45s linear infinite;animation-delay:-15s}
.sunset-cloud-3{width:120px;height:25px;top:60%;left:70%;animation:cloudsMove 50s linear infinite;animation-delay:-25s}
.sunset-sun{position:absolute;bottom:20%;left:50%;transform:translateX(-50%);width:100px;height:100px;background:radial-gradient(circle,#FFD700 0%,#FF6347 60%,#FF4500 100%);border-radius:50%;box-shadow:0 0 80px rgba(255,99,71,0.8),0 0 150px rgba(255,69,0,0.4);animation:sunsetGlow 4s ease-in-out infinite}
@keyframes sunsetGlow{0%,100%{box-shadow:0 0 80px rgba(255,99,71,0.8),0 0 150px rgba(255,69,0,0.4)}50%{box-shadow:0 0 100px rgba(255,99,71,0.9),0 0 180px rgba(255,69,0,0.5)}}

/* Céu Nublado */
.welcome-screen.cloudy-day{background:linear-gradient(to bottom,#87CEEB 0%,#B0C4DE 50%,#C5D5E5 100%)}
.welcome-screen.cloudy-night{background:linear-gradient(to bottom,#1a1a2e 0%,#2d2d44 50%,#3d3d5c 100%)}
.heavy-clouds{position:absolute;top:0;left:0;width:200%;height:100%}
.heavy-cloud{position:absolute;background:#fff;border-radius:50px;opacity:0.95;box-shadow:0 8px 32px rgba(0,0,0,0.1)}
.heavy-cloud::before,.heavy-cloud::after{content:'';position:absolute;background:#fff;border-radius:50%}
.heavy-cloud-1{width:180px;height:70px;top:10%;left:5%;animation:cloudsMove 35s linear infinite}
.heavy-cloud-1::before{width:90px;height:90px;top:-45px;left:30px}
.heavy-cloud-1::after{width:70px;height:70px;top:-30px;left:100px}
.heavy-cloud-2{width:220px;height:80px;top:22%;left:40%;animation:cloudsMove 40s linear infinite;animation-delay:-10s}
.heavy-cloud-2::before{width:100px;height:100px;top:-50px;left:40px}
.heavy-cloud-2::after{width:80px;height:80px;top:-35px;left:120px}
.heavy-cloud-3{width:160px;height:60px;top:38%;left:15%;animation:cloudsMove 38s linear infinite;animation-delay:-20s}
.heavy-cloud-3::before{width:80px;height:80px;top:-40px;left:25px}
.heavy-cloud-3::after{width:60px;height:60px;top:-25px;left:85px}
.heavy-cloud-4{width:200px;height:75px;top:50%;left:60%;animation:cloudsMove 42s linear infinite;animation-delay:-5s}
.heavy-cloud-4::before{width:95px;height:95px;top:-48px;left:35px}
.heavy-cloud-4::after{width:75px;height:75px;top:-32px;left:110px}
.cloudy-night .heavy-cloud{background:rgba(60,60,80,0.8);box-shadow:none}
.cloudy-night .heavy-cloud::before,.cloudy-night .heavy-cloud::after{background:rgba(60,60,80,0.8)}

/* Chuva */
.welcome-screen.rainy-day{background:linear-gradient(to bottom,#4A5568 0%,#5A6A7A 50%,#6B7B8C 100%)}
.welcome-screen.rainy-night{background:linear-gradient(to bottom,#0d1117 0%,#1a1f2e 50%,#252d3d 100%)}
.rain{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none}
.rain-drop{position:absolute;width:2px;background:linear-gradient(to bottom,transparent,rgba(174,194,224,0.6),rgba(174,194,224,0.3));animation:rainFall linear infinite}
@keyframes rainFall{0%{transform:translateY(-100vh)}100%{transform:translateY(100vh)}}

/* Tempestade */
.welcome-screen.storm{background:linear-gradient(to bottom,#1a1a2e 0%,#2d2d44 30%,#1a1a2e 100%)}
.lightning{position:absolute;top:0;left:0;width:100%;height:100%;background:transparent;animation:lightningFlash 4s infinite;pointer-events:none}
@keyframes lightningFlash{0%,95%,100%{background:transparent}96%,98%{background:rgba(255,255,255,0.3)}}

/* Neve */
.welcome-screen.snowy-day{background:linear-gradient(to bottom,#B8C6D6 0%,#D4E0ED 50%,#E8F0F8 100%)}
.welcome-screen.snowy-night{background:linear-gradient(to bottom,#1a2030 0%,#2a3040 50%,#3a4050 100%)}
.snow{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none}
.snowflake{position:absolute;color:#fff;font-size:1em;animation:snowFall linear infinite}
@keyframes snowFall{0%{transform:translateY(-10vh) rotate(0deg)}100%{transform:translateY(100vh) rotate(360deg)}}

/* Neblina */
.welcome-screen.foggy{background:linear-gradient(to bottom,#8a9aa8 0%,#a5b5c2 50%,#c0d0dd 100%)}
.fog{position:absolute;top:0;left:0;width:200%;height:100%;background:linear-gradient(to right,rgba(255,255,255,0.1),rgba(255,255,255,0.4),rgba(255,255,255,0.1));animation:fogMove 20s linear infinite}
@keyframes fogMove{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

.welcome-greeting{font-size:28px;font-weight:400;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.3);opacity:0;transform:translateY(20px);animation:welcomeSlideUp 1s ease .2s forwards;z-index:1;transition:margin-top .3s ease}
.welcome-name{font-size:44px;font-weight:600;color:#fff;text-shadow:0 2px 15px rgba(0,0,0,0.4);margin-top:8px;opacity:0;transform:translateY(20px);animation:welcomeSlideUp 1s ease .5s forwards;z-index:1}
.welcome-screen.text-bottom{justify-content:flex-end;padding-bottom:15vh}

/* Esconder todos os elementos climáticos por padrão */
.stars,.clouds,.sun,.sunset-clouds,.sunset-sun,.heavy-clouds,.rain,.lightning,.snow,.fog{display:none}
@keyframes welcomeSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes welcomeFadeIn{from{opacity:0}to{opacity:1}}

/* INITIAL LOGIN */
.initial-login{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9997;padding:40px 20px;box-sizing:border-box}
.initial-login.active{display:flex}
.initial-login-logo{display:block;width:200px;height:auto;margin-bottom:40px}
.initial-login-box{width:100%;max-width:320px}
.initial-login-title{font-size:14px;color:var(--txt2);text-align:center;margin-bottom:24px}

/* PHOTO MODAL */
.photo-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10000;padding:20px;opacity:0;transition:opacity .3s ease;touch-action:none;-webkit-touch-callout:none}
.photo-modal.active{display:flex;opacity:1}
.photo-modal-close{position:absolute;top:20px;right:20px;width:40px;height:40px;background:var(--card);border:1px solid var(--brd);border-radius:50%;color:var(--txt);font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10001}
.photo-modal-img-wrap{position:relative;max-width:100%;max-height:80vh;overflow:hidden;display:flex;align-items:center;justify-content:center}
.photo-modal-img{max-width:100%;max-height:80vh;border-radius:12px;object-fit:contain;transform-origin:center center;transition:transform 0.1s ease-out;touch-action:none;user-select:none;-webkit-user-select:none}
.photo-modal-info{margin-top:16px;text-align:center}
.photo-modal-ref{font-size:18px;font-weight:600;color:var(--txt)}
.photo-modal-desc{font-size:14px;color:var(--txt2);margin-top:4px}
.photo-modal-noimg{color:var(--txt2);font-size:16px;text-align:center}

/* HOME */
@keyframes skeletonPulse{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton{background:linear-gradient(90deg,#1e1e2a 25%,#2a2a3a 50%,#1e1e2a 75%);background-size:200% 100%;border-radius:12px;animation:skeletonPulse 2s ease-in-out infinite;border:1px solid rgba(255,255,255,0.06)}
.skeleton-card{height:140px;margin-bottom:12px}
.skeleton-stat{height:80px}
.skeleton-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.skeleton-progress{height:40px;margin-bottom:16px}
.skeleton-title{height:20px;width:150px;margin-bottom:12px}
.home{height:100vh;height:100dvh;display:none;flex-direction:column;align-items:center;justify-content:center;padding:16px 20px;position:relative;overflow:hidden;box-sizing:border-box}
.home::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:url('bg-home.jpg') 0% center/auto 100% no-repeat;opacity:0.38;pointer-events:none;z-index:0;animation:homePan 25s ease-in-out infinite alternate}
.home>*{position:relative;z-index:1}
.home.visible{display:flex}
.home.hidden{display:none}
.home-logo{width:90px;margin-bottom:24px;opacity:0.85;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3))}

/* Debug Panel */
.debug-panel{position:fixed;bottom:50px;left:10px;right:10px;height:30vh;background:rgba(0,0,0,0.95);z-index:99999;display:none;flex-direction:column;font-family:monospace;font-size:11px;border-radius:12px;border:1px solid #333;box-shadow:0 4px 20px rgba(0,0,0,0.5);resize:vertical;overflow:hidden;min-height:100px;max-height:70vh}
.debug-panel.active{display:flex}
.debug-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#1a1a1a;border-bottom:1px solid #333;cursor:move;touch-action:none;user-select:none}
.debug-header span{color:#0f0;font-weight:bold}
.debug-header-buttons{display:flex;gap:8px}
.debug-header button{background:#e94560;color:#fff;border:none;padding:4px 12px;border-radius:4px;font-size:11px}
.debug-header button.close-btn{background:#666;padding:4px 8px}
.debug-logs{flex:1;overflow-y:auto;padding:8px}
.debug-log{padding:4px 8px;border-bottom:1px solid #222;color:#ccc;word-break:break-all}
.debug-log.error{color:#f66}
.debug-log.warn{color:#fa0}
.debug-log.info{color:#6cf}
.debug-toggle{position:fixed;bottom:10px;left:10px;width:40px;height:40px;background:#e94560;color:#fff;border:none;border-radius:50%;font-size:16px;z-index:99998;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:none}
.debug-toggle.visible{display:flex;align-items:center;justify-content:center}
.modules{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px}
.mod-btn{background:rgba(12,12,10,0.45);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(180,160,120,0.15);border-radius:16px;padding:20px 14px 16px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:all .25s ease;text-align:center;position:relative;overflow:hidden}
.mod-btn::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(200,175,120,0.3),transparent)}
.mod-btn:active{transform:scale(0.96);background:rgba(12,12,10,0.65);border-color:rgba(200,175,120,0.3)}
.mod-btn.full-width{grid-column:1/-1;flex-direction:row;padding:14px 18px;gap:12px;text-align:left}
.mod-btn.full-width .mod-info{align-items:flex-start}
.mod-btn.full-width .mod-icon{width:42px;height:42px;font-size:22px}
.mod-icon{font-size:26px;width:48px;height:48px;background:linear-gradient(135deg,rgba(180,160,120,0.12),rgba(180,160,120,0.04));border:1px solid rgba(180,160,120,0.1);border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .25s ease}
.mod-btn:active .mod-icon{background:linear-gradient(135deg,rgba(180,160,120,0.2),rgba(180,160,120,0.08));border-color:rgba(200,175,120,0.25)}
.mod-info{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.mod-name{font-size:12px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.9)}
.mod-desc{font-size:10px;color:rgba(255,255,255,0.4);letter-spacing:0.3px;line-height:1.3}
.mod-arrow{display:none}
.mod-soon{position:absolute;top:8px;right:8px;font-size:8px;color:rgba(200,175,120,0.6);background:rgba(200,175,120,0.08);border:1px solid rgba(200,175,120,0.12);padding:2px 7px;border-radius:8px;white-space:nowrap;letter-spacing:0.5px;text-transform:uppercase}
.home-footer{position:absolute;bottom:12px;left:0;right:0;text-align:center;font-size:8px;color:rgba(180,160,120,0.3);letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:12px}
.install-banner{display:none;width:100%;max-width:340px;margin-top:12px;background:rgba(12,12,10,0.45);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(180,160,120,0.15);border-radius:16px;padding:12px 16px;text-align:center;cursor:pointer;transition:all .25s ease;grid-column:1/-1;position:relative;overflow:hidden}
.install-banner::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(200,175,120,0.3),transparent)}
.install-banner:active{transform:scale(0.98);background:rgba(12,12,10,0.65)}
.install-banner.visible{display:block}
.install-title{font-size:11px;font-weight:500;color:rgba(200,175,120,0.8);letter-spacing:1.5px;text-transform:uppercase}
.install-desc{font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;letter-spacing:0.3px}

/* DEV SCREEN */
.dev-screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center;position:relative}
.dev-screen.active{display:flex}
.dev-icon{font-size:64px;margin-bottom:20px}
.dev-title{font-size:20px;font-weight:600;margin-bottom:8px}
.dev-text{font-size:14px;color:var(--txt2);line-height:1.6;max-width:280px}
.dev-back{position:absolute;top:16px;left:16px;background:rgba(12,12,10,0.45);border:1px solid rgba(180,160,120,0.15);color:rgba(200,175,120,0.7);font-size:18px;cursor:pointer;width:38px;height:38px;border-radius:50%;z-index:10;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:0;transition:all .2s}
.dev-back:active{background:var(--card2)}
.compras-kpi{background:var(--card);border:1px solid var(--brd);border-radius:8px;padding:8px 4px;text-align:center}
.compras-kpi-val{font-size:18px;font-weight:700;color:var(--txt)}
.compras-kpi-lbl{font-size:9px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.compras-tab{flex:1;padding:8px;border:1px solid var(--brd);background:var(--card);color:var(--txt2);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
.compras-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.compras-tab:active{transform:scale(0.97)}
.compras-forn-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.compras-forn-card:active{transform:scale(0.98);background:var(--card2)}
.compras-forn-header{display:flex;align-items:center;gap:10px}
.compras-forn-avatar{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.compras-forn-avatar.tc{background:rgba(59,130,246,0.15);color:#3b82f6}
.compras-forn-avatar.av{background:rgba(234,179,8,0.15);color:#eab308}
.compras-forn-avatar.misto{background:rgba(168,85,247,0.15);color:#a855f7}
.compras-forn-avatar.outros{background:var(--card2);color:var(--txt2)}
.compras-forn-name{font-size:13px;font-weight:600;color:var(--txt);line-height:1.2;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.compras-forn-tipo{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;letter-spacing:.5px}
.compras-forn-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.compras-forn-stat{text-align:center;padding:6px 2px;background:var(--bg);border-radius:6px}
.compras-forn-stat-val{font-size:14px;font-weight:700}
.compras-forn-stat-lbl{font-size:9px;color:var(--txt2);margin-top:1px}
.compras-forn-valor{font-size:11px;color:var(--txt2);margin-top:8px;display:flex;justify-content:space-between;align-items:center}
.compras-section-title{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:1px;padding:12px 0 6px;margin-top:4px;border-top:1px solid var(--brd);display:flex;align-items:center;gap:6px}
.compras-section-title:first-child{border-top:none;margin-top:0}
.compras-badge{font-size:10px;background:var(--card2);color:var(--txt2);padding:1px 6px;border-radius:8px}
.compras-pedido-card{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:6px}
.compras-pedido-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.compras-pedido-num{font-size:12px;font-weight:700;color:var(--txt)}
.compras-pedido-status{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:600}
.compras-pedido-status.aberto{background:rgba(234,179,8,0.15);color:#eab308}
.compras-pedido-status.parcial{background:rgba(249,115,22,0.15);color:#f97316}
.compras-pedido-status.atrasado{background:rgba(239,68,68,0.15);color:#ef4444}
.compras-pedido-status.recebido{background:rgba(16,185,129,0.15);color:#10b981}
.compras-pedido-info{font-size:11px;color:var(--txt2);display:flex;gap:12px;flex-wrap:wrap}
.compras-pedido-items{margin-top:8px;border-top:1px solid var(--brd);padding-top:6px}
.compras-pedido-item{font-size:11px;color:var(--txt);padding:3px 0;display:flex;justify-content:space-between}
.compras-pedido-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px}
.compras-pedido-item-qty{color:var(--txt2);flex-shrink:0}
.compras-empty{text-align:center;padding:30px;color:var(--txt2);font-size:13px}
.compras-back-header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--brd);padding:12px 16px;display:flex;align-items:center;gap:12px}
.compras-back-btn{background:var(--card);border:1px solid var(--brd);color:var(--txt);width:32px;height:32px;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* LOGIN */
.login-screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
.login-screen.active{display:flex}
.login-box{width:100%;max-width:320px}
.login-icon{font-size:48px;text-align:center;margin-bottom:8px}
.login-title{font-size:20px;font-weight:600;text-align:center;margin-bottom:4px}
.login-subtitle{font-size:12px;color:var(--txt2);text-align:center;margin-bottom:32px}
.login-field{margin-bottom:16px;position:relative}
.login-label{font-size:12px;color:var(--txt2);margin-bottom:6px;display:block}
.login-input{width:100%;background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 40px 14px 16px;color:var(--txt);font-size:14px;outline:none}
.login-input:focus{border-color:var(--accent)}
.login-input::placeholder{color:#444}
.show-pw-btn{position:absolute;right:12px;bottom:10px;background:none;border:none;color:var(--txt2);font-size:16px;cursor:pointer;padding:4px;opacity:0.5;transition:opacity .2s;width:24px;height:24px;display:flex;align-items:center;justify-content:center}
.show-pw-btn:hover,.show-pw-btn:active{opacity:0.8}
.show-pw-btn svg{width:18px;height:18px;fill:currentColor}
.login-btn{width:100%;padding:14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:8px}
.login-btn:active{opacity:0.85}
.login-error{font-size:12px;color:var(--red);text-align:center;margin-top:12px;min-height:18px}
.login-back{position:absolute;top:16px;left:16px;background:rgba(12,12,10,0.45);border:1px solid rgba(180,160,120,0.15);color:rgba(200,175,120,0.7);font-size:18px;cursor:pointer;width:38px;height:38px;border-radius:50%;z-index:10;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:0;transition:all .2s}

/* SUBMENU */
.submenu-screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
.submenu-screen.active{display:flex}
.submenu-title{font-size:20px;font-weight:600;margin-bottom:6px}
.submenu-desc{font-size:12px;color:var(--txt2);margin-bottom:16px}
.submenu-total-produzido{display:none;font-size:13px;font-weight:600;color:var(--accent);background:var(--card);border:1px solid var(--brd);border-radius:20px;padding:8px 16px;margin-bottom:16px;text-align:center}
.submenu-total-produzido.visible{display:inline-block}
.exp-update-date{font-size:11px;color:var(--accent);margin-bottom:24px;padding:8px 16px;background:var(--card);border-radius:8px;display:inline-block}
.submenu-grid{display:flex;flex-direction:column;gap:14px;width:100%;max-width:360px}
.sub-btn{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:20px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:all .15s}
.sub-btn-highlight{background:linear-gradient(135deg,rgba(236,72,153,0.1),rgba(59,130,246,0.1));border-color:var(--accent)}
.sub-btn:active{transform:scale(0.98);background:var(--card2)}
.sub-btn.disabled{opacity:0.4;cursor:default}
.sub-btn.disabled:active{transform:none}
.sub-icon{font-size:24px;width:44px;height:44px;background:var(--card2);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sub-info{flex:1}
.sub-name{font-size:15px;font-weight:600}
.sub-desc{font-size:11px;color:var(--txt2);margin-top:2px}
.sub-arrow{color:var(--txt2);font-size:18px}
.sub-soon{font-size:10px;color:var(--txt2);background:var(--card2);border:1px solid var(--brd);padding:4px 10px;border-radius:10px;white-space:nowrap}
.submenu-back{position:absolute;top:16px;left:16px;background:rgba(12,12,10,0.45);border:1px solid rgba(180,160,120,0.15);color:rgba(200,175,120,0.7);font-size:18px;cursor:pointer;width:38px;height:38px;border-radius:50%;z-index:10;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:0;transition:all .2s}
.submenu-year-note{font-size:10px;color:#444;letter-spacing:1px;text-transform:uppercase;margin-top:-8px;margin-bottom:24px}

/* EXPEDIÇÃO */
.exp-total-stats{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.exp-stat{flex:1;min-width:80px;text-align:center;padding:10px;background:var(--card2);border-radius:10px;transition:all .2s ease}
.exp-stat.exp-stat-clickable{border:2px solid transparent;-webkit-tap-highlight-color:transparent}
.exp-stat.exp-stat-clickable:not(.active):hover{background:var(--card)}
.exp-stat.exp-stat-clickable:active{transform:scale(0.98)}
@media (hover:none){.exp-stat.exp-stat-clickable:not(.active):hover{background:var(--card2)}}
.exp-stat.exp-stat-clickable.active{background:var(--accent);border-color:var(--accent);box-shadow:0 0 15px rgba(233,69,96,0.5);transform:scale(1.02)}
.exp-stat.exp-stat-clickable.active .exp-stat-value{color:#fff;font-size:22px}
.exp-stat.exp-stat-clickable.active .exp-stat-label{color:rgba(255,255,255,0.9)}
.exp-stat-value{font-size:18px;font-weight:700}
.exp-stat-label{font-size:10px;color:var(--txt2);margin-top:2px}
.exp-cores-list{display:none;padding:8px 16px;gap:6px;flex-wrap:wrap}
.exp-cores-list.visible{display:flex}
.exp-cor-pill{padding:6px 12px;border-radius:20px;background:var(--card2);color:var(--txt);font-size:12px;cursor:pointer;border:2px solid transparent;transition:all .2s;-webkit-tap-highlight-color:transparent}
.exp-cor-pill:active{transform:scale(0.96)}
.exp-cor-pill.active{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 10px rgba(233,69,96,0.4)}
.exp-cor-pill .cor-count{color:var(--txt2);font-size:10px;margin-left:4px}
.exp-cor-pill.active .cor-count{color:rgba(255,255,255,0.8)}
.exp-progress-section{margin-top:12px}
.exp-progress-row{margin-bottom:12px}
.exp-progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.exp-progress-label{font-size:12px;color:var(--txt2)}
.exp-progress-value{font-size:12px;font-weight:600}
.exp-progress-bar{height:10px;background:#1a1a1a;border-radius:5px;overflow:hidden}
.exp-progress-fill{height:100%;border-radius:5px;transition:width .3s ease}
.exp-progress-fill.green{background:linear-gradient(90deg,#00d9a5,#00f5b8)}
.exp-progress-fill.blue{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.exp-progress-fill.purple{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.exp-progress-fill.pink{background:linear-gradient(90deg,#ec4899,#f472b6)}
.exp-canais-resumo{background:var(--card);border-radius:12px;padding:14px;margin-top:12px;border:1px solid var(--brd)}
.exp-canais-title{font-size:12px;font-weight:600;color:var(--txt2);margin-bottom:12px}
.exp-canais-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.exp-canal-item{display:flex;align-items:center;gap:8px;background:var(--bg);padding:10px 12px;border-radius:8px}
.exp-canal-icon{font-size:16px}
.exp-canal-nome{flex:1;font-size:12px;color:var(--txt2)}
.exp-canal-valor{font-size:14px;font-weight:700;color:var(--txt)}
.exp-canal-destaque{display:flex;align-items:center;gap:10px;background:var(--card2);padding:12px;border-radius:10px;flex:1;min-width:0;overflow:hidden}
.exp-canal-destaque.clickable{cursor:pointer;transition:transform 0.2s, background 0.2s;-webkit-tap-highlight-color:transparent}
.exp-canal-destaque.clickable:hover{background:var(--card)}
.exp-canal-destaque.clickable:active{transform:scale(0.98)}
@media (hover:none){.exp-canal-destaque.clickable:hover{background:var(--card2)}}
.exp-canal-destaque.devolucao{background:var(--card2)}
.exp-canal-arrow{font-size:18px;color:var(--txt2);margin-left:auto;flex-shrink:0}
.exp-canal-row{display:flex;gap:8px}
.exp-canal-icon-lg{font-size:24px;flex-shrink:0}
.exp-canal-info{display:flex;flex-direction:column;gap:2px;min-width:0}
.exp-canal-nome-lg{font-size:12px;color:var(--txt2)}
.exp-canal-valor-lg{font-size:18px;font-weight:700;color:var(--txt)}
.exp-resumo-card{background:var(--card);border-radius:12px;padding:16px;margin-top:12px;border:1px solid var(--brd);cursor:pointer;transition:all .2s}
.exp-resumo-card:active{transform:scale(0.98);background:var(--card2)}
.exp-resumo-card-header{display:flex;align-items:center;justify-content:space-between}
.exp-resumo-card-title{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:600;color:var(--txt)}
.exp-resumo-card-arrow{font-size:18px;color:var(--txt2)}
.resumo-dia-content{width:100%;max-width:400px;margin-top:24px}
#resumo-dia-screen{justify-content:flex-start;padding-top:80px}
.resumo-dia-date-picker{display:flex;align-items:center;gap:12px;margin-top:16px;margin-bottom:8px}
.resumo-dia-nav-btn{background:var(--card);border:1px solid var(--brd);color:var(--txt);width:40px;height:40px;border-radius:10px;font-size:20px;cursor:pointer;transition:all 0.2s}
.resumo-dia-nav-btn:active{transform:scale(0.95);background:var(--bg2)}
.resumo-dia-date-display{flex:1;background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s}
.resumo-dia-date-display:active{background:var(--bg2)}
.resumo-dia-date-icon{font-size:18px}
.resumo-dia-date-text{flex:1;font-size:14px;color:var(--txt)}
.resumo-dia-date-arrow{font-size:10px;color:var(--txt2)}
.resumo-dia-loading{text-align:center;color:var(--txt2);padding:40px 0}
.resumo-dia-total{background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:16px;padding:24px;margin-bottom:20px;text-align:center}
.resumo-dia-total-label{font-size:14px;color:rgba(255,255,255,0.8);margin-bottom:4px}
.resumo-dia-total-valor{font-size:48px;font-weight:700;color:#fff}
.resumo-dia-total-unidade{font-size:14px;color:rgba(255,255,255,0.8);margin-top:4px}
.resumo-dia-canais{display:flex;flex-direction:column;gap:12px}
.resumo-dia-canal{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:16px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:transform 0.2s}
.resumo-dia-canal:active{transform:scale(0.98)}
.resumo-dia-canal.devolucao{background:rgba(255,71,87,0.1);border-color:rgba(255,71,87,0.3)}
.resumo-dia-canal-icon{font-size:28px}
.resumo-dia-canal-info{flex:1}
.resumo-dia-canal-nome{font-size:14px;font-weight:600;color:var(--txt)}
.resumo-dia-canal-desc{font-size:11px;color:var(--txt2);margin-top:2px}
.resumo-dia-canal-valor{font-size:20px;font-weight:700;color:var(--txt)}
.resumo-dia-total.clickable{cursor:pointer;transition:transform 0.2s, box-shadow 0.2s}
.resumo-dia-total.clickable:active{transform:scale(0.98)}
.resumo-dia-total-hint{font-size:11px;color:rgba(255,255,255,0.6);margin-top:8px}
.resumo-dia-canal{cursor:pointer;transition:transform 0.2s}
.resumo-dia-canal:active{transform:scale(0.98)}

/* Modal de detalhes de envios */
.envios-detalhes-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;flex-direction:column;overflow:hidden}
.envios-detalhes-content{flex:1;display:flex;flex-direction:column;max-width:500px;margin:0 auto;width:100%;height:100%;overflow:hidden}
.envios-detalhes-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--brd);flex-shrink:0}
.envios-detalhes-title{font-size:16px;font-weight:600;color:var(--txt)}
.envios-detalhes-close{background:none;border:none;color:var(--txt2);font-size:20px;cursor:pointer;padding:8px}
.envios-detalhes-summary{display:flex;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--brd);font-size:13px;color:var(--txt2);flex-shrink:0}
.envios-detalhes-list{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch}
.envio-item{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:10px}
.envio-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.envio-item-ref{font-size:13px;font-weight:600;color:var(--accent)}
.envio-item-total{font-size:14px;font-weight:700;color:var(--txt)}
.envio-item-desc{font-size:12px;color:var(--txt);margin-bottom:4px}
.envio-item-cor{font-size:11px;color:var(--txt2);margin-bottom:6px}
.envio-item-tamanhos{display:flex;gap:8px;flex-wrap:wrap}
.envio-tam{font-size:11px;background:var(--bg2);padding:3px 8px;border-radius:4px;color:var(--txt)}
.exp-item{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--brd);cursor:pointer}
.exp-item-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.exp-item-ref{font-size:11px;color:var(--accent);font-weight:600}
.exp-item-name{font-size:13px;margin-top:2px;line-height:1.3}
.exp-item-cor{font-size:11px;color:var(--txt);margin-top:4px;font-weight:500}
.exp-item-badge{font-size:12px;font-weight:700}
.exp-tamanhos-grid{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.exp-tam-row{display:flex;align-items:center;gap:8px}
.exp-tam-label{font-size:11px;font-weight:600;width:20px;color:var(--txt2)}
.exp-tam-bar{flex:1;height:8px;background:var(--bg2);border-radius:4px;overflow:hidden}
.exp-tam-fill{height:100%;border-radius:4px;transition:width 0.3s}
.exp-tam-fill.green{background:var(--green)}
.exp-tam-fill.blue{background:var(--accent)}
.exp-tam-val{font-size:10px;color:var(--txt2);width:50px;text-align:right;font-family:monospace}
.exp-item-progress{margin-top:8px}

/* APP */
.app-screen{display:none}.app-screen.active{display:block}
#app-expedicao{display:none;height:100vh;height:100dvh;flex-direction:column;overflow:hidden}#app-expedicao.active{display:flex}
.header{background:var(--card);padding:16px;position:sticky;top:0;z-index:100;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:12px;flex-shrink:0}
.back-btn{background:none;border:none;color:var(--txt);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:8px}
.back-btn:active{background:rgba(255,255,255,0.05)}
.header-info h1{font-size:16px;font-weight:600}.header-info .sub{font-size:11px;color:var(--txt2);margin-top:2px}
.nav{display:flex;gap:8px;padding:12px 16px;background:var(--bg);overflow-x:auto;scrollbar-width:none}.nav::-webkit-scrollbar{display:none}
.nav-btn{flex-shrink:0;padding:10px 16px;border-radius:20px;border:none;background:var(--card);color:var(--txt2);font-size:13px;font-weight:500;cursor:pointer}.nav-btn.active{background:var(--accent);color:#fff}
.content{padding:16px;padding-bottom:40px}.screen{display:none}.screen.active{display:block;animation:fadeIn .3s ease}
#exp-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid var(--brd)}
.card-title{font-size:12px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.card-value{font-size:28px;font-weight:700}.card-value.sm{font-size:22px}.card-change{font-size:12px;margin-top:4px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.progress-container{margin-top:12px}.progress-bar{height:8px;background:#1a1a1a;border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px}.progress-fill.yellow{background:linear-gradient(90deg,var(--warn),#ffda44)}
.progress-labels{display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--txt2)}
.metric-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--brd)}.metric-row:last-child{border-bottom:none}
.metric-label{font-size:13px;color:var(--txt2)}.metric-value{font-size:14px;font-weight:600}
.product-item{background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--brd)}
.product-item.card-excelente{background:rgba(0,217,165,.12);border-color:rgba(0,217,165,.3)}
.product-item.card-bom{background:rgba(255,193,7,.12);border-color:rgba(255,193,7,.3)}
.product-item.card-regular{background:rgba(255,165,0,.12);border-color:rgba(255,165,0,.3)}
.product-item.card-fraco{background:rgba(255,71,87,.12);border-color:rgba(255,71,87,.3)}
.product-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.product-ref{font-size:11px;color:var(--accent);font-weight:600}.product-name{font-size:13px;margin-top:2px;line-height:1.3}
.product-price{font-size:14px;font-weight:700;color:var(--green)}
.product-stats{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap}.product-stat{font-size:11px}
.product-stat-label{color:var(--txt2)}.product-stat-value{font-weight:600}
.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase}
.status-excelente{background:rgba(0,217,165,.15);color:var(--green)}.status-bom{background:rgba(255,193,7,.15);color:var(--warn)}
.status-regular{background:rgba(255,107,107,.15);color:var(--red)}.status-fraco{background:rgba(255,71,87,.2);color:#ff4757}
.status-fotos{background:rgba(147,51,234,.15);color:#a78bfa}
.section-title{font-size:16px;font-weight:600;margin:20px 0 12px}.section-title:first-child{margin-top:0}
.ref-search-container{position:relative;margin-bottom:12px}
.ref-search-input{width:100%;padding:12px 40px 12px 16px;background:var(--card);border:1px solid var(--brd);border-radius:12px;color:var(--txt);font-size:14px;outline:none;box-sizing:border-box}
.ref-search-input:focus{border-color:var(--accent)}
.ref-search-input::placeholder{color:var(--txt2)}
.ref-search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--txt2);font-size:16px;cursor:pointer;padding:8px;display:none}
.ref-search-clear.visible{display:block}
.ref-item.highlight,.exp-item.highlight{animation:refHighlight 2s ease-out}
@keyframes refHighlight{0%{background:rgba(233,69,96,0.3)}100%{background:transparent}}
.rank-number{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.rank-1{background:linear-gradient(135deg,#FFD700,#FFA500);color:#000}.rank-2{background:linear-gradient(135deg,#C0C0C0,#A0A0A0);color:#000}
.rank-3{background:linear-gradient(135deg,#CD7F32,#8B4513);color:#fff}.rank-default{background:var(--card2);color:var(--txt2)}
.search-box{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.search-box input{flex:1;background:none;border:none;color:var(--txt);font-size:14px;outline:none}.search-box input::placeholder{color:var(--txt2)}
.filter-pills{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.filter-pill{flex-shrink:0;padding:8px 14px;border-radius:16px;border:1px solid var(--brd);background:var(--card);color:var(--txt2);font-size:12px;cursor:pointer}
.filter-pill.active{background:var(--accent);border-color:var(--accent);color:#fff}
.summary-row{display:flex;gap:8px;margin-bottom:12px}
.summary-card{flex:1;background:var(--card);border-radius:12px;padding:12px;text-align:center;border:1px solid var(--brd)}
.summary-card-value{font-size:16px;font-weight:700}.summary-card-label{font-size:10px;color:var(--txt2);margin-top:2px}
.info-banner{background:linear-gradient(135deg,var(--accent),#ff6b6b);border-radius:12px;padding:14px 16px;margin-bottom:16px}
.info-banner-title{font-size:12px;font-weight:600;color:rgba(255,255,255,.9)}.info-banner-value{font-size:14px;font-weight:700;color:#fff;margin-top:4px}

/* GESTÃO DE USUÁRIOS */
.users-screen{display:none;min-height:100vh;flex-direction:column;background:var(--bg)}
.users-screen.active{display:flex}
.users-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--card);border-bottom:1px solid var(--brd);position:sticky;top:0;z-index:10}
.users-back{width:36px;height:36px;background:var(--card2);border:1px solid var(--brd);border-radius:50%;color:var(--txt);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.users-title{font-size:16px;font-weight:600;color:var(--txt)}
.users-add-btn{width:36px;height:36px;background:var(--accent);border:none;border-radius:50%;color:#fff;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.users-list{flex:1;padding:16px 20px;overflow-y:auto}
.users-loading{text-align:center;color:var(--txt2);padding:40px}
.user-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:16px;margin-bottom:12px}
.user-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.user-card-info{flex:1}
.user-card-nome{font-size:16px;font-weight:600;color:var(--txt)}
.user-card-id{font-size:12px;color:var(--txt2);margin-top:2px}
.user-card-badge{font-size:10px;font-weight:600;padding:4px 8px;border-radius:12px}
.user-card-badge.admin{background:rgba(233,69,96,0.2);color:var(--accent)}
.user-card-badge.user{background:rgba(0,217,165,0.2);color:var(--green)}
.user-card-access{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.user-card-tag{font-size:10px;background:var(--card2);color:var(--txt2);padding:4px 8px;border-radius:6px}
.user-card-actions{display:flex;gap:8px;justify-content:flex-end}
.user-card-btn{padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer}
.user-card-btn.edit{background:var(--card2);color:var(--txt)}
.user-card-btn.delete{background:rgba(255,71,87,0.2);color:var(--red)}
.user-card-btn.kick{background:rgba(255,165,0,0.2);color:#ffa500}
.user-online-badge{font-size:11px;color:#22c55e;margin-left:8px}
.user-offline-badge{font-size:11px;color:#666;margin-left:8px}

/* MODAL FORMULÁRIO USUÁRIO */
.user-form-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.user-form-modal.active{display:flex}
.user-form-content{background:var(--card);border-radius:16px;width:100%;max-width:400px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.user-form-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--brd)}
.user-form-title{font-size:16px;font-weight:600;color:var(--txt)}
.user-form-close{width:32px;height:32px;background:var(--card2);border:1px solid var(--brd);border-radius:50%;color:var(--txt);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.user-form-body{padding:20px;overflow-y:auto;flex:1}
.user-form-field{margin-bottom:20px}
.user-form-field label{display:block;font-size:12px;color:var(--txt2);margin-bottom:8px;font-weight:600}
.user-form-field input[type="text"],.user-form-field input[type="password"]{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--brd);border-radius:10px;color:var(--txt);font-size:14px}
.user-form-field input::placeholder{color:var(--txt2)}
.user-form-radio-group{display:flex;gap:16px}
.user-form-radio{display:flex;align-items:center;gap:8px;cursor:pointer}
.user-form-radio input{width:18px;height:18px;accent-color:var(--accent)}
.user-form-radio span{font-size:14px;color:var(--txt)}
.user-form-checks{display:flex;flex-direction:column;gap:10px}
.user-form-check{display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 12px;background:var(--bg);border-radius:8px}
.user-form-check input{width:18px;height:18px;accent-color:var(--green)}
.user-form-check span{font-size:13px;color:var(--txt)}
.user-form-error{color:var(--red);font-size:12px;text-align:center;margin-bottom:16px;min-height:16px}
.user-form-actions{display:flex;gap:12px}
.user-form-btn{flex:1;padding:14px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer}
.user-form-btn.primary{background:var(--accent);color:#fff}
.user-form-btn.secondary{background:var(--card2);color:var(--txt)}

/* CHANGE PASSWORD */
.changepw-screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
.changepw-screen.active{display:flex}
.settings-menu{display:flex;flex-direction:column;gap:8px;margin:20px 0}
.settings-menu-btn{display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;background:var(--card2);border:1px solid var(--brd);border-radius:12px;color:var(--txt);font-size:14px;cursor:pointer;text-align:left;transition:all .2s}
.settings-menu-btn:active{background:var(--card);transform:scale(0.98)}
.settings-menu-icon{font-size:20px}
.settings-menu-text{flex:1}
.settings-menu-arrow{color:var(--txt2);font-size:18px}
.settings-menu-badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;background:rgba(233,69,96,0.2);color:var(--accent)}
.changepw-box{width:100%;max-width:320px}
.changepw-icon{font-size:48px;text-align:center;margin-bottom:8px}
.changepw-title{font-size:20px;font-weight:600;text-align:center;margin-bottom:4px}
.changepw-subtitle{font-size:12px;color:var(--txt2);text-align:center;margin-bottom:32px}
.changepw-field{margin-bottom:16px;position:relative}
.changepw-label{font-size:12px;color:var(--txt2);margin-bottom:6px;display:block}
.changepw-input{width:100%;background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px 40px 14px 16px;color:var(--txt);font-size:14px;outline:none}
.changepw-input:focus{border-color:var(--accent)}
.changepw-input::placeholder{color:#444}
.changepw-btn{width:100%;padding:14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:8px}
.changepw-btn:active{opacity:0.85}
.changepw-btn.secondary{background:var(--card);color:var(--txt);border:1px solid var(--brd);margin-top:16px}
.changepw-btn.danger{background:#c0392b;margin-top:12px}
.changepw-divider{height:1px;background:var(--brd);margin:24px 0}
.changepw-section-title{font-size:12px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.bio-status{font-size:13px;color:var(--txt2);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.changepw-msg{font-size:12px;text-align:center;margin-top:12px;min-height:18px}
.changepw-msg.error{color:var(--red)}
.changepw-msg.success{color:var(--green)}
.changepw-back{position:absolute;top:16px;left:16px;background:rgba(12,12,10,0.45);border:1px solid rgba(180,160,120,0.15);color:rgba(200,175,120,0.7);font-size:18px;cursor:pointer;width:38px;height:38px;border-radius:50%;z-index:10;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:0;transition:all .2s}
.settings-btn{position:absolute;bottom:12px;right:16px;background:rgba(12,12,10,0.35);border:1px solid rgba(180,160,120,0.12);border-radius:50%;padding:0;width:34px;height:34px;color:rgba(180,160,120,0.4);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:100000}
.settings-btn:active{background:rgba(12,12,10,0.55);transform:scale(0.95)}

/* GEOLOCATOR */
.geo-screen{display:none;height:100vh;flex-direction:column;background:#000}
.geo-screen.active{display:flex}
.geo-header{background:var(--card);padding:16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:12px}
.geo-header h1{font-size:16px;font-weight:600;flex:1}
.geo-body{display:flex;flex:1;flex-direction:column}
@media(min-width:768px){.geo-body{flex-direction:row}}
.geo-sidebar{background:var(--card);padding:16px;display:flex;flex-direction:column;gap:16px;border-bottom:1px solid var(--brd)}
@media(min-width:768px){.geo-sidebar{width:340px;border-bottom:none;border-right:1px solid var(--brd);max-height:calc(100vh - 60px);overflow-y:auto}}
.geo-settings{background:var(--card2);border-radius:12px;padding:14px}
.geo-settings-title{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.geo-settings-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.geo-settings-row label{font-size:13px}
.geo-dist-group{display:flex;align-items:center;gap:6px}
.geo-dist-input{width:60px;padding:8px 10px;background:var(--bg);border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:13px;text-align:center}
.geo-dist-input:focus{outline:none;border-color:var(--accent)}
.geo-unit{font-size:11px;color:var(--txt2)}
.geo-toggle-row{display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--brd)}
.geo-toggle-label{font-size:12px;color:var(--txt2)}
.geo-toggle{position:relative;width:40px;height:22px;background:var(--bg);border-radius:11px;cursor:pointer;transition:background .3s}
.geo-toggle.active{background:var(--accent)}
.geo-toggle-knob{position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .3s}
.geo-toggle.active .geo-toggle-knob{transform:translateX(18px)}
.geo-input-section{display:flex;flex-direction:column;gap:10px}
.geo-input-wrap{position:relative}
.geo-address-input{width:100%;padding:14px 16px;background:#1a1a1a;border:2px solid #444;border-radius:12px;color:#fff;font-size:14px;font-weight:500}
.geo-address-input::placeholder{color:#888;font-weight:400}
.geo-address-input:focus{outline:none;border-color:var(--accent);background:#222}
.geo-input-section .geo-address-input{padding-right:75px}
.geo-search-btn{position:absolute;right:5px;top:50%;transform:translateY(-50%);padding:8px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.geo-search-btn:hover{opacity:.9}
.geo-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--brd);border-radius:10px;margin-top:4px;max-height:200px;overflow-y:auto;z-index:100;display:none}
.geo-suggestions.active{display:block}
.geo-suggestion-item{padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--brd);transition:background .2s}
.geo-suggestion-item:last-child{border-bottom:none}
.geo-suggestion-item:hover{background:var(--card2)}
.geo-suggestion-item strong{color:var(--accent)}
.geo-suggestion-item small{color:var(--txt2)}
.geo-verify-section{background:#0d0d0d;border:1px solid #333;border-radius:12px;padding:16px;margin-top:12px}
.geo-verify-title{font-size:13px;color:var(--accent);margin-bottom:12px;font-weight:600}
.geo-verify-section .geo-input-wrap{margin-bottom:10px}
.geo-verify-btn{position:absolute;right:5px;top:50%;transform:translateY(-50%);padding:8px 14px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.geo-verify-btn:hover{opacity:.9}
.geo-verify-btn:disabled{opacity:.5;cursor:not-allowed}
.geo-verify-section .geo-address-input{padding-right:90px}
.geo-verify-result{font-size:12px;line-height:1.5}
.geo-verify-result.success{color:#00d9a5}
.geo-verify-result.warning{color:#ffc107}
.geo-verify-result.error{color:#ff4757}
.geo-verify-result .nearby-list{margin-top:8px;padding:10px;background:var(--bg);border-radius:8px}
.geo-verify-result .nearby-item{padding:6px 0;border-bottom:1px solid var(--brd)}
.geo-verify-result .nearby-item:last-child{border-bottom:none}
.geo-clear-verify-btn{width:100%;padding:10px;background:var(--card);border:1px solid var(--brd);border-radius:8px;color:var(--txt2);font-size:12px;cursor:pointer;margin-top:10px;transition:all .2s}
.geo-clear-verify-btn:hover{border-color:var(--accent);color:var(--accent)}
.geo-btn-row{display:flex;gap:8px}
.geo-show-all-btn{flex:1;padding:12px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.geo-show-all-btn:active{transform:scale(0.98)}
.geo-clear-btn{flex:1;padding:12px;background:transparent;border:1px solid var(--red);border-radius:10px;color:var(--red);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.geo-clear-btn:hover{background:rgba(255,71,87,.1)}
.geo-filter-section{background:var(--card2);border-radius:12px;padding:12px;margin-top:10px}
.geo-filter-title{font-size:11px;color:var(--txt2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
.geo-filter-row{display:flex;gap:8px;margin-bottom:8px}
.geo-filter-row:last-child{margin-bottom:0}
.geo-filter-select{flex:1;padding:10px;background:var(--bg);border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:12px;cursor:pointer}
.geo-filter-select:focus{outline:none;border-color:var(--accent)}
.geo-locs-section{flex:1;display:flex;flex-direction:column;gap:10px;min-height:0}
.geo-locs-header{display:flex;align-items:center;justify-content:space-between}
.geo-locs-title{font-size:11px;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px}
.geo-locs-count{font-size:11px;color:var(--accent);background:rgba(233,69,96,.1);padding:3px 8px;border-radius:10px}
.geo-locs-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;max-height:300px}
@media(min-width:768px){.geo-locs-list{max-height:none}}
.geo-loc-card{background:var(--card2);border-radius:12px;padding:12px;display:flex;align-items:flex-start;gap:10px;animation:geoSlide .3s ease;border:1px solid transparent}
.geo-loc-card.valid{border-color:#50c878;background:rgba(80,200,120,.1)}
.geo-loc-card.valid .geo-loc-name{color:#50c878}
.geo-loc-card.valid .geo-loc-marker{background:#50c878}
.geo-loc-card.valid .geo-loc-status{color:#50c878}
.geo-loc-card:hover{opacity:.9;transform:translateX(2px)}
.geo-loc-dist{text-align:right;font-size:11px;min-width:60px}
.geo-loc-dist-value{font-weight:600;color:var(--txt)}
.geo-loc-dist-status{font-size:10px}
.geo-loc-dist-status.valid{color:#50c878}
.geo-loc-dist-status.conflict{color:#cc2936}
.geo-loc-card.warning{border-color:var(--warn);background:rgba(255,193,7,.05)}
.geo-loc-card.conflict{border-color:#cc2936;background:rgba(204,41,54,.1)}
@keyframes geoSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.geo-loc-marker{width:28px;height:28px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;color:#fff}
.geo-loc-info{flex:1;min-width:0}
.geo-loc-address{font-size:12px;line-height:1.4;word-break:break-word}
.geo-loc-name{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:2px}
.geo-loc-coords{font-size:10px;color:var(--txt2);margin-top:2px}
.geo-loc-status{font-size:10px;margin-top:4px;padding:2px 6px;border-radius:4px;display:inline-block}
.geo-loc-status.ok{background:rgba(0,217,165,.1);color:var(--green)}
.geo-loc-status.conflict{background:rgba(255,71,87,.1);color:var(--red)}
.geo-loc-status.bypassed{background:rgba(255,193,7,.1);color:var(--warn)}
.geo-loc-actions{display:flex;flex-direction:column;gap:4px}
.geo-action-btn{width:26px;height:26px;background:var(--bg);border:1px solid var(--brd);border-radius:6px;color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .2s}
.geo-action-btn:active{transform:scale(0.95)}
.geo-action-btn.delete:hover{border-color:var(--red);color:var(--red)}
.geo-action-btn.bypass.active{background:var(--warn);border-color:var(--warn);color:#000}
.geo-map-section{flex:1;position:relative;min-height:400px;height:100%}
#geoMap{width:100%;height:100%;min-height:400px;background:#1a1a1a}
.geo-fullscreen-btn{position:absolute;top:10px;right:10px;width:40px;height:40px;background:rgba(0,0,0,.7);border:none;border-radius:8px;color:#fff;font-size:20px;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;transition:all .2s}
.geo-fullscreen-btn:hover{background:rgba(0,0,0,.9)}
.geo-map-section.fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;min-height:100vh}
.geo-map-section.fullscreen #geoMap{min-height:100vh}
.geo-map-section.fullscreen .geo-fullscreen-btn{top:20px;right:20px}
.geo-map-section.fullscreen .geo-legend{bottom:20px}
.geo-map-section.fullscreen .geo-stats{top:20px;left:20px;transform:none;flex-wrap:nowrap}
.geo-stats{position:absolute;top:12px;left:12px;right:auto;display:flex;gap:8px;z-index:10;flex-wrap:nowrap}
.geo-stat{background:rgba(0,0,0,.85);backdrop-filter:blur(8px);border:1px solid var(--brd);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px}
.geo-stat-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.geo-stat-icon.total{background:rgba(233,69,96,.1);color:var(--accent)}
.geo-stat-icon.valid{background:rgba(0,217,165,.1);color:var(--green)}
.geo-stat-icon.conflicts{background:rgba(255,71,87,.1);color:var(--red)}
.geo-stat-value{font-size:16px;font-weight:700}
.geo-stat-label{font-size:10px;color:var(--txt2);text-transform:uppercase}
.geo-legend{position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);border:1px solid var(--brd);border-radius:10px;padding:10px 14px;display:flex;gap:14px;z-index:10}
.geo-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--txt2)}
.geo-legend-dot{width:10px;height:10px;border-radius:50%}
.geo-legend-dot.valid{background:var(--green)}
.geo-legend-dot.conflict{background:var(--red)}
.geo-legend-dot.bypassed{background:var(--warn)}
.geo-legend-dot.radius{background:rgba(233,69,96,.3);border:2px solid var(--accent)}
.geo-empty{text-align:center;padding:30px 16px;color:var(--txt2)}
.geo-empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}
.geo-empty p{font-size:13px}
.geo-toast-container{position:fixed;bottom:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:1000}
.geo-toast{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:8px;animation:geoToastIn .3s ease;max-width:300px}
.geo-toast.error{border-color:var(--red)}
.geo-toast.success{border-color:var(--green)}
.geo-toast.warning{border-color:var(--warn)}
@keyframes geoToastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes homePan{0%{background-position:0% center}100%{background-position:100% center}}
.geo-toast-icon{font-size:16px}
.geo-toast.error .geo-toast-icon{color:var(--red)}
.geo-toast.success .geo-toast-icon{color:var(--green)}
.geo-toast.warning .geo-toast-icon{color:var(--warn)}
.geo-toast-msg{font-size:12px;line-height:1.3}
.geo-api-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1001;padding:20px}
.geo-api-modal.hidden{display:none}
.geo-api-box{background:#111;border:1px solid #333;border-radius:16px;padding:24px;max-width:400px;width:100%}
.geo-api-box h2{font-size:18px;margin-bottom:6px;color:#fff}
.geo-api-box p{font-size:13px;color:#888;margin-bottom:16px;line-height:1.5}
.geo-api-input{width:100%;padding:12px 14px;background:#000;border:1px solid #333;border-radius:10px;color:#fff;font-size:13px;margin-bottom:12px}
.geo-api-input:focus{outline:none;border-color:#e94560}
.geo-api-btn{width:100%;padding:12px;background:#e94560;border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:600;cursor:pointer}
.geo-api-btn:active{opacity:.85}
.geo-api-note{margin-top:12px;padding:10px;background:rgba(255,193,7,.1);border-radius:8px;font-size:11px;color:#ffc107}
.geo-api-note a{color:#e94560;text-decoration:none}

/* LOADING OVERLAY - Carregamento API */
.api-loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9997;opacity:0;pointer-events:none;transition:opacity .3s ease}
.api-loading-overlay.active{opacity:1;pointer-events:auto}
.api-loading-spinner{width:50px;height:50px;border:3px solid #222;border-top-color:#e94560;border-radius:50%;animation:loadingSpin 1s linear infinite}
@keyframes loadingSpin{to{transform:rotate(360deg)}}
.api-loading-text{margin-top:24px;font-size:15px;color:#fff;text-align:center;font-weight:500}
.api-loading-subtext{margin-top:8px;font-size:12px;color:#666;text-align:center;max-width:280px;line-height:1.5}
.api-loading-progress{margin-top:20px;width:200px;height:4px;background:#222;border-radius:2px;overflow:hidden}
.api-loading-progress-bar{height:100%;background:linear-gradient(90deg,#e94560,#ff6b8a);width:0%;transition:width .3s ease;animation:loadingPulse 1.5s ease-in-out infinite}
@keyframes loadingPulse{0%,100%{opacity:1}50%{opacity:0.6}}
.api-loading-status{margin-top:16px;font-size:11px;color:#555;text-align:center}

/* Pull to Refresh */
html, body { overscroll-behavior-y: contain; }
.ptr-container{position:relative;flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain}
.ptr-indicator{position:absolute;top:-50px;left:50%;transform:translateX(-50%);width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;transition:top .2s ease,transform .2s ease;z-index:10}
.ptr-indicator.pulling{top:10px}
.ptr-indicator.refreshing{top:10px;animation:ptrSpin 1s linear infinite}
@keyframes ptrSpin{from{transform:translateX(-50%) rotate(0deg)}to{transform:translateX(-50%) rotate(360deg)}}
.ptr-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#4caf50;color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s ease;pointer-events:none}
.ptr-toast.show{opacity:1}
.ptr-toast.warning{background:#ff9800}

/* Splash Refresh Global */
.splash-refresh{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .3s ease}
.splash-refresh.active{opacity:1;pointer-events:auto}
.splash-refresh .splash-logo{width:120px;opacity:0.9}
.splash-refresh .splash-icons{display:none}
.splash-refresh-text{margin-top:20px;color:#666;font-size:12px}
.splash-refresh-progress{margin-top:16px;width:200px;height:4px;background:#222;border-radius:2px;overflow:hidden}
.splash-refresh-progress-bar{height:100%;background:linear-gradient(90deg,#e94560,#ff6b8a);width:0%;position:relative}
.splash-refresh-progress-bar::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:progressShine 1.5s infinite}
.splash-refresh-percent{margin-top:12px;font-size:16px;color:#e94560;font-weight:700}
@keyframes progressShine{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

/* Modal Biometria */
.bio-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;opacity:0;pointer-events:none;transition:opacity .3s ease}
.bio-modal.active{opacity:1;pointer-events:auto}
.bio-modal-content{background:#1a1a1a;border-radius:16px;padding:30px;text-align:center;max-width:300px;margin:20px}
.bio-modal-icon{font-size:48px;margin-bottom:16px}
.bio-modal-title{font-size:18px;font-weight:600;margin-bottom:12px;color:#fff}
.bio-modal-text{font-size:14px;color:#888;margin-bottom:24px;line-height:1.5}
.bio-modal-btns{display:flex;gap:12px}
.bio-modal-btn{flex:1;padding:14px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer}
.bio-modal-btn.primary{background:#e94560;color:#fff}
.bio-modal-btn.secondary{background:#333;color:#fff}
</style></head><body>

<!-- SPLASH -->
<div class="splash" id="splash">
    <img src="data:image/png;base64,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" class="splash-logo" alt="Isa Paes">
    <div class="splash-icons">
        <span class="splash-icon">👗</span>
        <span class="splash-icon">✂️</span>
        <span class="splash-icon">🧵</span>
        <span class="splash-icon">🪡</span>
        <span class="splash-icon">👘</span>
    </div>
</div>

<!-- API LOADING OVERLAY -->
<div class="api-loading-overlay" id="api-loading">
    <div class="api-loading-spinner"></div>
    <div class="api-loading-text">Carregando dados em tempo real</div>
    <div class="api-loading-subtext">Conectando ao TOTVS Moda para buscar informações atualizadas da expedição...</div>
    <div class="api-loading-progress"><div class="api-loading-progress-bar" id="api-loading-bar"></div></div>
    <div class="api-loading-status" id="api-loading-status">Verificando cápsulas disponíveis...</div>
</div>

<!-- INITIAL LOGIN -->
<div class="initial-login" id="initial-login">
    <img src="data:image/png;base64,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" class="initial-login-logo" alt="Isa Paes">
    <div class="initial-login-box">
        <div class="initial-login-title">Faça login para continuar</div>
        <!-- Honeypot fields para confundir autofill -->
        <input type="text" name="email" style="display:none!important" tabindex="-1" autocomplete="email">
        <input type="password" name="password" style="display:none!important" tabindex="-1" autocomplete="current-password">
        <div class="login-field">
            <label class="login-label">Usuário</label>
            <input type="text" class="login-input" id="initial-user" name="app_usr_x7k" placeholder="Digite seu usuário" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" data-lpignore="true" data-form-type="other" inputmode="text">
        </div>
        <div class="login-field">
            <label class="login-label">Senha</label>
            <input type="text" class="login-input pwd-field" id="initial-pw" name="app_key_m3z" placeholder="••••••" autocomplete="off" autocorrect="off" spellcheck="false" data-lpignore="true" data-form-type="other" inputmode="text" style="-webkit-text-security:disc" onkeydown="if(event.key==='Enter')doInitialLogin()">
            <button type="button" class="show-pw-btn" onclick="toggleShowPassword('initial-pw', this)"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
        </div>
        <button class="login-btn" onclick="doInitialLogin()">Entrar</button>
        <div class="login-error" id="initial-error"></div>
    </div>
</div>

<!-- WELCOME SCREEN -->
<div class="welcome-screen" id="welcome-screen">
    <!-- Estrelas (noite limpa) -->
    <div class="stars" id="welcome-stars"></div>
    <!-- Nuvens e Sol (manhã limpa) -->
    <div class="clouds" id="welcome-clouds">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
    </div>
    <div class="sun" id="welcome-sun"></div>
    <!-- Pôr do Sol (tarde limpa) -->
    <div class="sunset-clouds" id="welcome-sunset-clouds">
        <div class="sunset-cloud sunset-cloud-1"></div>
        <div class="sunset-cloud sunset-cloud-2"></div>
        <div class="sunset-cloud sunset-cloud-3"></div>
    </div>
    <div class="sunset-sun" id="welcome-sunset-sun"></div>
    <!-- Nuvens pesadas (nublado) -->
    <div class="heavy-clouds" id="welcome-heavy-clouds">
        <div class="heavy-cloud heavy-cloud-1"></div>
        <div class="heavy-cloud heavy-cloud-2"></div>
        <div class="heavy-cloud heavy-cloud-3"></div>
        <div class="heavy-cloud heavy-cloud-4"></div>
    </div>
    <!-- Chuva -->
    <div class="rain" id="welcome-rain"></div>
    <!-- Relâmpago (tempestade) -->
    <div class="lightning" id="welcome-lightning"></div>
    <!-- Neve -->
    <div class="snow" id="welcome-snow"></div>
    <!-- Neblina -->
    <div class="fog" id="welcome-fog"></div>
    <!-- Texto -->
    <div class="welcome-greeting" id="welcome-greeting">Boa noite,</div>
    <div class="welcome-name" id="welcome-name">André</div>
</div>

<!-- HOME -->
<div class="home" id="home">
    <img src="data:image/png;base64,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" class="home-logo" alt="Isa Paes">
    <div class="modules" id="modules-container">
        <div class="mod-btn" id="mod-comercial" onclick="openModule('comercial')">
            <div class="mod-icon">📊</div>
            <div class="mod-info"><div class="mod-name">Comercial</div><div class="mod-desc">Vendas, metas e campanhas</div></div>
            
        </div>
        <div class="mod-btn" id="mod-compras" onclick="openModule('compras')">
            <div class="mod-icon">🛒</div>
            <div class="mod-info"><div class="mod-name">Compras</div><div class="mod-desc">Pedidos e fornecedores</div></div>
            
        </div>
        <div class="mod-btn" id="mod-expedicao" onclick="openExpedicao()">
            <div class="mod-icon">📦</div>
            <div class="mod-info"><div class="mod-name">Expedição</div><div class="mod-desc">Controle de envios</div></div>
            
        </div>
        <div class="mod-btn" id="mod-financeiro" onclick="openModule('financeiro')">
            <div class="mod-icon">💰</div>
            <div class="mod-info"><div class="mod-name">Financeiro</div><div class="mod-desc">Fluxo de caixa e contas</div></div>
            <span class="mod-soon">Em breve</span>
        </div>
    </div>
    <div class="install-banner" id="installBanner" onclick="installApp()">
        <div class="install-title">📲 Instalar Aplicativo</div>
        <div class="install-desc">Adicione à tela inicial para acesso rápido</div>
    </div>
    <div class="home-footer"><span>Isa Paes © 2026</span></div>
    <button class="settings-btn" onclick="openChangePw()" ontouchstart="startDebugPress()" ontouchend="endDebugPress()">⚙️</button>
</div>

<!-- LOGIN ÚNICO -->
<div class="login-screen" id="login-screen">
    <div class="login-box">
        <div class="login-icon" id="login-mod-icon">📊</div>
        <div class="login-title" id="login-mod-title">Comercial</div>
        <div class="login-subtitle">Faça login para acessar</div>
        <!-- Honeypot fields para confundir autofill -->
        <input type="text" name="email" style="display:none!important" tabindex="-1" autocomplete="email">
        <input type="password" name="password" style="display:none!important" tabindex="-1" autocomplete="current-password">
        <div class="login-field">
            <label class="login-label">Usuário</label>
            <input type="text" class="login-input" id="login-user" name="mod_usr_q2j" placeholder="Digite seu usuário" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" data-lpignore="true" data-form-type="other" inputmode="text">
        </div>
        <div class="login-field">
            <label class="login-label">Senha</label>
            <input type="text" class="login-input pwd-field" id="login-pw" name="mod_key_p8w" placeholder="••••••" autocomplete="off" autocorrect="off" spellcheck="false" data-lpignore="true" data-form-type="other" inputmode="text" style="-webkit-text-security:disc" onkeydown="if(event.key==='Enter')doLogin()">
            <button type="button" class="show-pw-btn" onclick="toggleShowPassword('login-pw', this)"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
        </div>
        <button class="login-btn" onclick="doLogin()">Entrar</button>
        <div class="login-error" id="login-error"></div>
    </div>
    <button class="login-back" onclick="goHome()">←</button>
</div>

<!-- SUBMENU: COMERCIAL -->
<div class="submenu-screen" id="sub-comercial">
    <div class="login-icon">📊</div>
    <div class="submenu-title">Comercial</div>
    <div class="submenu-desc">Selecione uma opção</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openChannel('showroom')">
            <div class="sub-icon">🏬</div>
            <div class="sub-info"><div class="sub-name">Showroom</div><div class="sub-desc">Vendas presenciais</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn disabled">
            <div class="sub-icon">🏷️</div>
            <div class="sub-info"><div class="sub-name">Outlet</div><div class="sub-desc">Vendas outlet</div></div>
            <span class="sub-soon">Em breve</span>
        </div>
        <div class="sub-btn disabled">
            <div class="sub-icon">🌐</div>
            <div class="sub-info"><div class="sub-name">E-commerce</div><div class="sub-desc">Vendas online</div></div>
            <span class="sub-soon">Em breve</span>
        </div>
        <div class="sub-btn" onclick="openGeoFromComercial()">
            <div class="sub-icon">📍</div>
            <div class="sub-info"><div class="sub-name">Consultar Praça</div><div class="sub-desc">Mapeador de endereços</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" onclick="goHome()">←</button>
</div>
<div class="submenu-screen" id="sub-expedicao">
    <div class="login-icon">📦</div>
    <div class="submenu-title">Expedição</div>
    <div class="submenu-desc">Selecione a estação</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openExpedicaoEstacao('inverno')">
            <div class="sub-icon">❄️</div>
            <div class="sub-info"><div class="sub-name">Inverno 2026</div><div class="sub-desc">Coleção I26</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openExpedicaoEstacao('verao')">
            <div class="sub-icon">☀️</div>
            <div class="sub-info"><div class="sub-name">Verão 2027</div><div class="sub-desc">Coleção V27</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" onclick="goHome()">←</button>
</div>

<!-- SUBMENU: EXPEDIÇÃO - CÁPSULAS INVERNO -->
<div class="submenu-screen" id="sub-expedicao-inverno">
    <div class="login-icon">❄️</div>
    <div class="submenu-title">Inverno</div>
    <div class="submenu-desc">Coleção I26 - Selecione a cápsula</div>
    <div class="submenu-total-produzido" id="total-produzido-I26"></div>
    <div class="submenu-grid">
        <div class="sub-btn disabled" id="btn-I26-1" onclick="openExpedicaoCapsula('I26', 1)">
            <div class="sub-icon">1️⃣</div>
            <div class="sub-info"><div class="sub-name">1ª Cápsula</div><div class="sub-desc">Primeira entrega</div></div>
            <span class="sub-soon" id="status-I26-1">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-I26-2" onclick="openExpedicaoCapsula('I26', 2)">
            <div class="sub-icon">2️⃣</div>
            <div class="sub-info"><div class="sub-name">2ª Cápsula</div><div class="sub-desc">Segunda entrega</div></div>
            <span class="sub-soon" id="status-I26-2">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-I26-3" onclick="openExpedicaoCapsula('I26', 3)">
            <div class="sub-icon">3️⃣</div>
            <div class="sub-info"><div class="sub-name">3ª Cápsula</div><div class="sub-desc">Terceira entrega</div></div>
            <span class="sub-soon" id="status-I26-3">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-I26-4" onclick="openExpedicaoCapsula('I26', 4)">
            <div class="sub-icon">4️⃣</div>
            <div class="sub-info"><div class="sub-name">4ª Cápsula</div><div class="sub-desc">Quarta entrega</div></div>
            <span class="sub-soon" id="status-I26-4">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-I26-5" onclick="openExpedicaoCapsula('I26', 5)">
            <div class="sub-icon">5️⃣</div>
            <div class="sub-info"><div class="sub-name">5ª Cápsula</div><div class="sub-desc">Quinta entrega</div></div>
            <span class="sub-soon" id="status-I26-5">Em breve</span>
        </div>
    </div>
    <button class="submenu-back" onclick="backToExpedicao()">←</button>
</div>

<!-- SUBMENU: EXPEDIÇÃO - CÁPSULAS VERÃO -->
<div class="submenu-screen" id="sub-expedicao-verao">
    <div class="login-icon">☀️</div>
    <div class="submenu-title">Verão</div>
    <div class="submenu-desc">Coleção V27 - Selecione a cápsula</div>
    <div class="submenu-total-produzido" id="total-produzido-V27"></div>
    <div class="submenu-grid">
        <div class="sub-btn disabled" id="btn-V27-1" onclick="openExpedicaoCapsula('V27', 1)">
            <div class="sub-icon">1️⃣</div>
            <div class="sub-info"><div class="sub-name">1ª Cápsula</div><div class="sub-desc">Primeira entrega</div></div>
            <span class="sub-soon" id="status-V27-1">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-V27-2" onclick="openExpedicaoCapsula('V27', 2)">
            <div class="sub-icon">2️⃣</div>
            <div class="sub-info"><div class="sub-name">2ª Cápsula</div><div class="sub-desc">Segunda entrega</div></div>
            <span class="sub-soon" id="status-V27-2">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-V27-3" onclick="openExpedicaoCapsula('V27', 3)">
            <div class="sub-icon">3️⃣</div>
            <div class="sub-info"><div class="sub-name">3ª Cápsula</div><div class="sub-desc">Terceira entrega</div></div>
            <span class="sub-soon" id="status-V27-3">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-V27-4" onclick="openExpedicaoCapsula('V27', 4)">
            <div class="sub-icon">4️⃣</div>
            <div class="sub-info"><div class="sub-name">4ª Cápsula</div><div class="sub-desc">Quarta entrega</div></div>
            <span class="sub-soon" id="status-V27-4">Em breve</span>
        </div>
        <div class="sub-btn disabled" id="btn-V27-5" onclick="openExpedicaoCapsula('V27', 5)">
            <div class="sub-icon">5️⃣</div>
            <div class="sub-info"><div class="sub-name">5ª Cápsula</div><div class="sub-desc">Quinta entrega</div></div>
            <span class="sub-soon" id="status-V27-5">Em breve</span>
        </div>
    </div>
    <button class="submenu-back" onclick="backToExpedicao()">←</button>
</div>

<!-- SUBMENU: EXPEDIÇÃO - DESTINOS -->
<div class="submenu-screen" id="sub-expedicao-destinos">
    <div class="login-icon">📦</div>
    <div class="submenu-title" id="destinos-title">Cápsula</div>
    <div class="submenu-desc">Selecione o destino</div>
    <div class="exp-update-date" id="destinos-update">📅 Verificando...</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openExpedicaoDestino('showroom')">
            <div class="sub-icon">🏬</div>
            <div class="sub-info"><div class="sub-name">Showroom</div><div class="sub-desc">Envios para loja física</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openExpedicaoDestino('ecommerce')">
            <div class="sub-icon">🌐</div>
            <div class="sub-info"><div class="sub-name">E-commerce</div><div class="sub-desc">Envios para loja online</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openExpedicaoDestino('mostruario')">
            <div class="sub-icon">👗</div>
            <div class="sub-info"><div class="sub-name">Mostruário Isabella</div><div class="sub-desc">Peças de mostruário</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openExpedicaoDestino('ld')">
            <div class="sub-icon">📋</div>
            <div class="sub-info"><div class="sub-name">Leves Defeitos</div><div class="sub-desc">Peças com pequenos defeitos</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn sub-btn-highlight" onclick="openResumoEnviosDia()">
            <div class="sub-icon">📊</div>
            <div class="sub-info"><div class="sub-name">Resumo do Dia</div><div class="sub-desc">Envios de todos os canais</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" id="destinos-back-btn" onclick="backToExpedicaoEstacao()">←</button>
</div>

<!-- TELA: RESUMO ENVIOS DO DIA -->
<div class="submenu-screen" id="resumo-dia-screen">
    <div class="login-icon">📊</div>
    <div class="submenu-title" id="resumo-dia-title">Resumo de Envios</div>
    
    <!-- Seletor de Data -->
    <div class="resumo-dia-date-picker">
        <button class="resumo-dia-nav-btn" onclick="resumoDiaAnterior()">‹</button>
        <div class="resumo-dia-date-display" onclick="abrirCalendarioResumo()">
            <span class="resumo-dia-date-icon">📅</span>
            <span class="resumo-dia-date-text" id="resumo-dia-data">Carregando...</span>
            <span class="resumo-dia-date-arrow">▼</span>
        </div>
        <button class="resumo-dia-nav-btn" onclick="resumoDiaProximo()">›</button>
    </div>
    <input type="date" id="resumo-dia-calendar" style="position:absolute;opacity:0;pointer-events:none" onchange="selecionarDataResumo(this.value)">
    
    <div class="resumo-dia-content" id="resumo-dia-content">
        <div class="resumo-dia-loading">Carregando dados...</div>
    </div>
    <button class="submenu-back" onclick="backToExpedicaoDestinos()">←</button>
</div>

<!-- TELA: EXPEDIÇÃO - DETALHES -->
<div class="app-screen" id="app-expedicao">
    <div class="header">
        <button class="back-btn" onclick="backToExpedicaoDestinos()">←</button>
        <div class="header-info" style="flex:1"><h1 id="exp-header-title">Expedição</h1><div class="sub" id="exp-header-sub">1ª Cápsula Inverno 2026</div></div>
    </div>
    <main class="content ptr-container" id="exp-content">
        <div class="ptr-indicator" id="ptr-indicator">🔄</div>
        <div class="card" id="exp-total-card">
            <div class="card-title">📊 Resumo Geral</div>
            <div class="exp-total-stats" id="exp-total-stats"></div>
            <div class="exp-progress-section" id="exp-total-progress"></div>
        </div>
        <div class="exp-cores-list" id="exp-cores-list"></div>
        <div class="exp-cores-list" id="exp-grupos-list"></div>
        <div class="section-title">📦 Referências</div>
        <div class="ref-search-container">
            <input type="text" id="ref-search" class="ref-search-input" placeholder="🔍 Buscar referência..." oninput="filtrarReferencias(this.value)">
            <button class="ref-search-clear" id="ref-search-clear" onclick="limparBuscaReferencia()">✕</button>
        </div>
        <div id="exp-items-list"></div>
    </main>
</div>
<div class="ptr-toast" id="ptr-toast"></div>

<!-- SPLASH REFRESH GLOBAL -->
<div class="splash-refresh" id="splash-refresh">
    <img src="data:image/png;base64,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" class="splash-logo" alt="Isa Paes">
    <div class="splash-icons">
        <span class="splash-icon">👗</span>
        <span class="splash-icon">✂️</span>
        <span class="splash-icon">🧵</span>
        <span class="splash-icon">🪡</span>
        <span class="splash-icon">👘</span>
    </div>
    <div class="splash-refresh-text" id="splash-refresh-text">Atualizando...</div>
    <div class="splash-refresh-progress">
        <div class="splash-refresh-progress-bar" id="splash-refresh-bar"></div>
    </div>
    <div class="splash-refresh-percent" id="splash-refresh-percent">0%</div>
</div>

<!-- GEOLOCALIZADOR -->

<!-- Modal Biometria -->
<div class="bio-modal" id="bio-modal">
    <div class="bio-modal-content">
        <div class="bio-modal-icon">🔐</div>
        <div class="bio-modal-title">Ativar Biometria?</div>
        <div class="bio-modal-text">Use Face ID ou impressão digital para entrar mais rápido na próxima vez.</div>
        <div class="bio-modal-btns">
            <button class="bio-modal-btn secondary" id="bio-modal-no">Agora não</button>
            <button class="bio-modal-btn primary" id="bio-modal-yes">Ativar</button>
        </div>
    </div>
</div>

<div class="geo-screen" id="geo-screen">
    <div class="geo-header">
        <button class="back-btn" onclick="goBackTo('sub-comercial')">←</button>
        <h1>📍 Consultar Praça</h1>
    </div>
    <div class="geo-body">
        <main class="geo-map-section">
            <div class="geo-stats">
                <div class="geo-stat">
                    <div class="geo-stat-icon total">📍</div>
                    <div><div class="geo-stat-value" id="geoTotal">0</div><div class="geo-stat-label">Total</div></div>
                </div>
                <div class="geo-stat">
                    <div class="geo-stat-icon valid">✓</div>
                    <div><div class="geo-stat-value" id="geoValid">0</div><div class="geo-stat-label">Válidos</div></div>
                </div>
                <div class="geo-stat">
                    <div class="geo-stat-icon conflicts">⚠</div>
                    <div><div class="geo-stat-value" id="geoConflicts">0</div><div class="geo-stat-label">Conflitos</div></div>
                </div>
            </div>
            <div id="geoMap"></div>
            <button class="geo-fullscreen-btn" id="geoFullscreenBtn" onclick="geoToggleFullscreen()">⛶</button>
            <div class="geo-legend">
                <div class="geo-legend-item"><div class="geo-legend-dot valid"></div><span>Válido</span></div>
                <div class="geo-legend-item"><div class="geo-legend-dot conflict"></div><span>Conflito</span></div>
                <div class="geo-legend-item"><div class="geo-legend-dot radius"></div><span>Raio</span></div>
            </div>
        </main>
        <aside class="geo-sidebar">
            <div class="geo-input-section">
                <div class="geo-input-wrap">
                    <input type="text" class="geo-address-input" id="geoSearchInput" placeholder="🔍 Buscar por nome, bairro, cidade, estado ou CEP..." oninput="geoShowSearchSuggestions()" onkeypress="if(event.key==='Enter')geoFilterLocations()" autocomplete="off">
                    <button class="geo-search-btn" onclick="geoFilterLocations()">Buscar</button>
                    <div class="geo-suggestions" id="geoSearchSuggestions"></div>
                </div>
            </div>
            <div class="geo-verify-section">
                <div class="geo-verify-title">📍 Verificar Novo Endereço</div>
                <div class="geo-input-wrap">
                    <input type="text" class="geo-address-input" id="geoVerifyInput" placeholder="Digite um endereço para verificar proximidade..." onkeypress="if(event.key==='Enter')geoVerifyAddress()">
                    <button class="geo-verify-btn" id="geoVerifyBtn" onclick="geoVerifyAddress()">Verificar</button>
                </div>
                <div class="geo-verify-result" id="geoVerifyResult"></div>
                <button class="geo-clear-verify-btn" id="geoClearVerifyBtn" onclick="geoClearVerify()" style="display:none">🔄 Limpar Verificação</button>
            </div>
            <div class="geo-sidebar-row">
                <div class="geo-settings">
                    <div class="geo-settings-title">⚙️ Configurações</div>
                    <div class="geo-settings-row">
                        <label>Distância mínima:</label>
                        <div class="geo-dist-group">
                            <input type="number" class="geo-dist-input" id="geoMinDistance" value="0.5" min="0.1" step="0.1">
                            <span class="geo-unit">km</span>
                        </div>
                    </div>
                    <div class="geo-toggle-row">
                        <span class="geo-toggle-label">Mostrar raios</span>
                        <div class="geo-toggle active" id="geoShowRadius" onclick="geoToggleRadius()">
                            <div class="geo-toggle-knob"></div>
                        </div>
                    </div>
                </div>
                <div class="geo-locs-section">
                    <div class="geo-locs-header">
                        <span class="geo-locs-title">📍 Locais</span>
                        <span class="geo-locs-count" id="geoLocsCount">0 locais</span>
                    </div>
                    <div class="geo-locs-list" id="geoLocsList">
                        <div class="geo-empty">
                            <div class="geo-empty-icon">🗺️</div>
                            <p>Adicione endereços para começar</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>
<div class="geo-toast-container" id="geoToastContainer"></div>

<!-- COMPRAS: TELA SELEÇÃO COLEÇÃO -->
<div class="submenu-screen" id="sub-compras">
    <div class="login-icon">🛒</div>
    <div class="submenu-title">Compras</div>
    <div class="submenu-desc">Selecione a coleção</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openComprasColecao('inverno')">
            <div class="sub-icon">❄️</div>
            <div class="sub-info"><div class="sub-name">Inverno 2026</div><div class="sub-desc">Coleção I26</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasColecao('verao')">
            <div class="sub-icon">☀️</div>
            <div class="sub-info"><div class="sub-name">Verão 2027</div><div class="sub-desc">Coleção V27</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" style="border-top:1px solid var(--brd);margin-top:8px" onclick="openComprasOverview()">
            <div class="sub-icon">📊</div>
            <div class="sub-info"><div class="sub-name">Visão Geral</div><div class="sub-desc">Todas coleções e cápsulas</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" onclick="goHome()">←</button>
</div>

<!-- COMPRAS: TELA SELEÇÃO CÁPSULA INVERNO -->
<div class="submenu-screen" id="sub-compras-inverno">
    <div class="login-icon">❄️</div>
    <div class="submenu-title">Inverno</div>
    <div class="submenu-desc">Coleção I26 - Selecione a cápsula</div>
    <div class="submenu-total-produzido visible" id="compras-total-I26">🛒 Carregando...</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openComprasCapsula('I26', '1')">
            <div class="sub-icon">1️⃣</div>
            <div class="sub-info"><div class="sub-name">1ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-I26-1">Primeira entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('I26', '2')">
            <div class="sub-icon">2️⃣</div>
            <div class="sub-info"><div class="sub-name">2ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-I26-2">Segunda entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('I26', '3')">
            <div class="sub-icon">3️⃣</div>
            <div class="sub-info"><div class="sub-name">3ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-I26-3">Terceira entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('I26', '4')">
            <div class="sub-icon">4️⃣</div>
            <div class="sub-info"><div class="sub-name">4ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-I26-4">Quarta entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('I26', '5')">
            <div class="sub-icon">5️⃣</div>
            <div class="sub-info"><div class="sub-name">5ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-I26-5">Quinta entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" onclick="backToCompras()">←</button>
</div>

<!-- COMPRAS: TELA SELEÇÃO CÁPSULA VERÃO -->
<div class="submenu-screen" id="sub-compras-verao">
    <div class="login-icon">☀️</div>
    <div class="submenu-title">Verão</div>
    <div class="submenu-desc">Coleção V27 - Selecione a cápsula</div>
    <div class="submenu-total-produzido visible" id="compras-total-V27">🛒 Carregando...</div>
    <div class="submenu-grid">
        <div class="sub-btn" onclick="openComprasCapsula('V27', '1')">
            <div class="sub-icon">1️⃣</div>
            <div class="sub-info"><div class="sub-name">1ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-V27-1">Primeira entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('V27', '2')">
            <div class="sub-icon">2️⃣</div>
            <div class="sub-info"><div class="sub-name">2ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-V27-2">Segunda entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('V27', '3')">
            <div class="sub-icon">3️⃣</div>
            <div class="sub-info"><div class="sub-name">3ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-V27-3">Terceira entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('V27', '4')">
            <div class="sub-icon">4️⃣</div>
            <div class="sub-info"><div class="sub-name">4ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-V27-4">Quarta entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
        <div class="sub-btn" onclick="openComprasCapsula('V27', '5')">
            <div class="sub-icon">5️⃣</div>
            <div class="sub-info"><div class="sub-name">5ª Cápsula</div><div class="sub-desc compras-cap-desc" id="compras-cap-V27-5">Quinta entrega</div></div>
            <div class="sub-arrow">›</div>
        </div>
    </div>
    <button class="submenu-back" onclick="backToCompras()">←</button>
</div>

<!-- COMPRAS: TELA PRINCIPAL -->
<div class="dev-screen" id="dev-compras" style="padding:0;overflow-y:auto;justify-content:flex-start;align-items:stretch">
    <div style="position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--brd);padding:12px 16px">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="dev-back" onclick="comprasGoBack()" style="position:static;margin:0">←</button>
            <div style="flex:1">
                <div style="font-size:18px;font-weight:700;color:var(--txt)" id="compras-header-title">Compras</div>
                <div style="font-size:11px;color:var(--txt2)" id="compras-update-time">Carregando...</div>
            </div>
            <button onclick="comprasRefresh()" id="compras-refresh-btn" style="background:var(--card);border:1px solid var(--brd);color:var(--txt);width:36px;height:36px;border-radius:10px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">↻</button>
        </div>
        <!-- Métricas rápidas -->
        <div id="compras-metricas" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px">
            <div class="compras-kpi" id="kpi-abertos"><div class="compras-kpi-val">—</div><div class="compras-kpi-lbl">Abertos</div></div>
            <div class="compras-kpi" id="kpi-parciais"><div class="compras-kpi-val">—</div><div class="compras-kpi-lbl">Parciais</div></div>
            <div class="compras-kpi" id="kpi-atrasados"><div class="compras-kpi-val">—</div><div class="compras-kpi-lbl">Atrasados</div></div>
            <div class="compras-kpi" id="kpi-recebidos"><div class="compras-kpi-val">—</div><div class="compras-kpi-lbl">Recebidos</div></div>
        </div>
        <!-- Filtro ativo (set by entry screens) -->
        <div id="compras-filtro-info" style="display:none;margin-top:8px;background:var(--accent)11;border:1px solid var(--accent)33;border-radius:8px;padding:6px 10px;font-size:12px;display:flex;align-items:center;justify-content:space-between">
            <span id="compras-filtro-label" style="font-weight:600;color:var(--accent)"></span>
            <button onclick="comprasClearFilter()" style="background:none;border:none;font-size:14px;color:var(--txt2);cursor:pointer;padding:2px 6px">✕</button>
        </div>
        <!-- Abas TC / AV / Todos -->
        <div style="display:flex;gap:6px;margin-top:10px" id="compras-tabs">
            <button class="compras-tab active" onclick="comprasSetTab('TODOS')">Todos</button>
            <button class="compras-tab" onclick="comprasSetTab('TC')">🧵 Tecidos</button>
            <button class="compras-tab" onclick="comprasSetTab('AV')">🪡 Aviamentos</button>
        </div>
    </div>
    <!-- Conteúdo scrollável -->
    <div style="padding:12px 16px;flex:1" id="compras-content">
        <div style="text-align:center;padding:40px 0;color:var(--txt2)">
            <div style="font-size:28px;margin-bottom:8px">⏳</div>
            Carregando dados de compras...<br>
            <span style="font-size:11px">(primeira carga pode demorar ~30s)</span>
        </div>
    </div>
</div>

<!-- DEV: FINANCEIRO -->
<div class="dev-screen" id="dev-financeiro">
    <div class="dev-icon">💰</div>
    <div class="dev-title">Financeiro</div>
    <div class="dev-text">Este módulo está em desenvolvimento.<br>Em breve você terá acesso ao fluxo de caixa, contas a pagar e receber.</div>
    <button class="dev-back" onclick="goHome()">←</button>
</div>

<!-- GESTÃO DE USUÁRIOS (Admin) -->
<div class="users-screen" id="users-screen">
    <div class="users-header">
        <button class="users-back" onclick="backFromUsers()">←</button>
        <div class="users-title">👥 Gestão de Usuários</div>
        <button class="users-add-btn" onclick="openUserForm()">+</button>
    </div>
    <div class="users-list" id="users-list">
        <div class="users-loading">Carregando...</div>
    </div>
</div>

<!-- FORMULÁRIO DE USUÁRIO (Modal) -->
<div class="user-form-modal" id="user-form-modal">
    <div class="user-form-content">
        <div class="user-form-header">
            <span class="user-form-title" id="user-form-title">Novo Usuário</span>
            <button class="user-form-close" onclick="closeUserForm()">✕</button>
        </div>
        <div class="user-form-body">
            <input type="hidden" id="user-form-editing-id">
            
            <div class="user-form-field">
                <label>Login (username)</label>
                <input type="text" id="user-form-id" placeholder="ex: joao" autocomplete="off">
            </div>
            
            <div class="user-form-field">
                <label>Nome de Exibição</label>
                <input type="text" id="user-form-nome" placeholder="ex: João Silva" autocomplete="off">
            </div>
            
            <div class="user-form-field">
                <label>Senha</label>
                <input type="password" id="user-form-pw" placeholder="••••••" autocomplete="new-password">
            </div>
            
            <div class="user-form-field">
                <label>Tipo de Usuário</label>
                <div class="user-form-radio-group">
                    <label class="user-form-radio">
                        <input type="radio" name="user-role" value="user" checked>
                        <span>Usuário</span>
                    </label>
                    <label class="user-form-radio">
                        <input type="radio" name="user-role" value="admin">
                        <span>Administrador</span>
                    </label>
                </div>
            </div>
            
            <div class="user-form-field">
                <label>Módulos de Acesso</label>
                <div class="user-form-checks">
                    <label class="user-form-check">
                        <input type="checkbox" id="access-comercial" checked>
                        <span>📊 Comercial</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="access-estoque">
                        <span>📦 Estoque</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="access-compras">
                        <span>🛒 Compras</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="access-financeiro">
                        <span>💰 Financeiro</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="access-usuarios">
                        <span>👥 Gestão Usuários</span>
                    </label>
                </div>
            </div>
            
            <div class="user-form-field">
                <label>Canais de Expedição</label>
                <div class="user-form-checks">
                    <label class="user-form-check">
                        <input type="checkbox" id="channel-showroom" checked>
                        <span>🏬 Showroom</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="channel-ecommerce">
                        <span>🌐 E-commerce</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="channel-mostruario">
                        <span>👗 Mostruário</span>
                    </label>
                    <label class="user-form-check">
                        <input type="checkbox" id="channel-ld">
                        <span>📋 Leves Defeitos</span>
                    </label>
                </div>
            </div>
            
            <div class="user-form-error" id="user-form-error"></div>
            
            <div class="user-form-actions">
                <button class="user-form-btn secondary" onclick="closeUserForm()">Cancelar</button>
                <button class="user-form-btn primary" onclick="saveUser()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: PRIMEIRO LOGIN (Como quer ser chamado?) -->
<div class="user-form-modal" id="first-login-modal">
    <div class="user-form-content" style="max-width:340px">
        <div class="user-form-body" style="text-align:center;padding:30px 24px">
            <div style="font-size:48px;margin-bottom:16px">👋</div>
            <div style="font-size:18px;font-weight:600;color:var(--txt);margin-bottom:8px">Bem-vindo!</div>
            <div style="font-size:13px;color:var(--txt2);margin-bottom:24px">Como você gostaria de ser chamado?</div>
            
            <div class="user-form-field" style="text-align:left">
                <label>Seu nome ou apelido</label>
                <input type="text" id="first-login-nome" placeholder="Ex: João, Jô, Maria..." autocomplete="off" style="text-align:center;font-size:16px">
            </div>
            
            <button class="user-form-btn primary" style="width:100%;margin-top:16px" onclick="confirmFirstLoginName()">Continuar</button>
        </div>
    </div>
</div>

<!-- ALTERAR SENHA -->
<div class="changepw-screen" id="changepw-screen">
    <div class="changepw-box">
        <div class="changepw-icon">⚙️</div>
        <div class="changepw-title">Configurações</div>
        <div class="changepw-subtitle" id="changepw-user-label">Logado como: —</div>
        
        <!-- Menu de Opções -->
        <div class="settings-menu">
            <button class="settings-menu-btn" onclick="showChangePassword()">
                <span class="settings-menu-icon">🔒</span>
                <span class="settings-menu-text">Alterar Senha</span>
                <span class="settings-menu-arrow">›</span>
            </button>
            <button class="settings-menu-btn" id="btn-gestao-usuarios" style="display:none" onclick="openUsers()">
                <span class="settings-menu-icon">👥</span>
                <span class="settings-menu-text">Gestão de Usuários</span>
                <span class="settings-menu-badge">Admin</span>
                <span class="settings-menu-arrow">›</span>
            </button>
        </div>
        
        <!-- Seção Biometria -->
        <div class="changepw-divider"></div>
        <div class="changepw-section-title">🔐 Biometria</div>
        <div class="bio-status" id="bio-status">Verificando...</div>
        <button class="changepw-btn secondary" id="bio-action-btn" onclick="toggleBiometria()">Carregando...</button>
        
        <!-- Botão Logout -->
        <div class="changepw-divider"></div>
        <button class="changepw-btn danger" onclick="doLogout()">🚪 Sair da Conta</button>
    </div>
    <button class="changepw-back" onclick="backFromChangePw()">←</button>
</div>

<!-- ALTERAR SENHA (sub-tela) -->
<div class="changepw-screen" id="changepw-form-screen">
    <div class="changepw-box">
        <div class="changepw-icon">🔒</div>
        <div class="changepw-title">Alterar Senha</div>
        <div class="changepw-subtitle" id="changepw-form-user-label">Logado como: —</div>
        <div class="changepw-field">
            <label class="changepw-label">Senha Atual</label>
            <input type="text" class="changepw-input pwd-field" id="changepw-current" placeholder="••••••" autocomplete="off" data-lpignore="true" data-form-type="other" style="-webkit-text-security:disc">
            <button type="button" class="show-pw-btn" onclick="toggleShowPassword('changepw-current', this)"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
        </div>
        <div class="changepw-field">
            <label class="changepw-label">Nova Senha</label>
            <input type="text" class="changepw-input pwd-field" id="changepw-new" placeholder="••••••" autocomplete="off" data-lpignore="true" data-form-type="other" style="-webkit-text-security:disc">
            <button type="button" class="show-pw-btn" onclick="toggleShowPassword('changepw-new', this)"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
        </div>
        <div class="changepw-field">
            <label class="changepw-label">Confirmar Nova Senha</label>
            <input type="text" class="changepw-input pwd-field" id="changepw-confirm" placeholder="••••••" autocomplete="off" data-lpignore="true" data-form-type="other" style="-webkit-text-security:disc" onkeydown="if(event.key==='Enter')doChangePw()">
            <button type="button" class="show-pw-btn" onclick="toggleShowPassword('changepw-confirm', this)"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
        </div>
        <button class="changepw-btn" onclick="doChangePw()">Salvar Nova Senha</button>
        <div class="changepw-msg" id="changepw-msg"></div>
    </div>
    <button class="changepw-back" onclick="backToSettings()">←</button>
</div>

<!-- COMERCIAL -->
<div class="app-screen" id="app-comercial">
<div class="header">
    <button class="back-btn" onclick="backToSub()">←</button>
    <div class="header-info" style="flex:1"><h1>Comercial</h1><div class="sub">1ª Cápsula Inverno 2026</div></div>
    <button class="back-btn" onclick="openChangePw()" title="Alterar Senha">⚙️</button>
</div>
<nav class="nav"><button class="nav-btn active" data-screen="dashboard">📊 Resumo</button><button class="nav-btn" data-screen="meta">🎯 Meta 80%</button><button class="nav-btn" data-screen="ranking">🏆 Ranking</button><button class="nav-btn" data-screen="campanha">🔥 Campanha</button></nav>
<main class="content">
<section id="dashboard" class="screen active">
<div class="info-banner"><div class="info-banner-title">⏱ META ATIVA — Coleção (80%)</div><div class="info-banner-value">R$ 1.769.076,00 | até 31/05/2026</div></div>
<div class="section-title">📊 Resumo do Dia — 05/02/2026</div>
<div class="grid-2"><div class="card"><div class="card-title">🛒 Peças Vendidas</div><div class="card-value">103</div></div><div class="card"><div class="card-title">💰 Valor Vendido</div><div class="card-value sm">R$ 35.822,17</div></div></div>
<div class="card"><div class="card-title">🎯 Ticket Médio Hoje</div><div class="card-value">R$ 347,79</div></div>
<div class="section-title">🏆 Top Vendas do Dia</div><div id="topdia"></div></section>
<section id="meta" class="screen"><div class="section-title">🎯 Meta 80% da Coleção</div>
<div class="card"><div class="card-title">Progresso Geral</div><div class="card-value">60,7%</div><div class="progress-container"><div class="progress-bar"><div class="progress-fill yellow" style="width:60.7%"></div></div><div class="progress-labels"><span>R$ 1.074.363 realizados</span><span>Meta: R$ 1.769.076</span></div></div></div>
<div class="grid-2"><div class="card"><div class="card-title">📦 Peças Vendidas</div><div class="card-value sm">3.064</div><div class="card-change">65,8% do necessário</div></div><div class="card"><div class="card-title">⏳ Dias Restantes</div><div class="card-value sm">115</div><div class="card-change">13 dias decorridos</div></div></div>
<div class="card"><div class="metric-row"><span class="metric-label">Faturamento Faltante</span><span class="metric-value">R$ 694.713</span></div><div class="metric-row"><span class="metric-label">Peças Faltantes</span><span class="metric-value">1.592</span></div><div class="metric-row"><span class="metric-label">Ticket Médio Realizado</span><span class="metric-value">R$ 350,64</span></div><div class="metric-row"><span class="metric-label">Ticket Restante</span><span class="metric-value">R$ 436,38</span></div><div class="metric-row"><span class="metric-label">Estoque (peças)</span><span class="metric-value">2.757</span></div><div class="metric-row"><span class="metric-label">Estoque (valor)</span><span class="metric-value">R$ 1.107.956</span></div></div></section>
<section id="ranking" class="screen"><div class="section-title">🏆 Aceitação e Rejeição</div>
<div class="summary-row"><div class="summary-card"><div class="summary-card-value">5.825</div><div class="summary-card-label">Enviadas</div></div><div class="summary-card"><div class="summary-card-value">2.961</div><div class="summary-card-label">Vendidas</div></div><div class="summary-card"><div class="summary-card-value">50,8%</div><div class="summary-card-label">Giro</div></div></div>
<div class="section-title">🥇 Top 5 Aceitas</div><div id="topA"></div><div class="section-title">⚠️ Top 5 Rejeitadas</div><div id="topR"></div>
<div class="section-title">📋 Ranking Completo</div><div class="filter-pills" id="rf"><button class="filter-pill active" data-filter="all">Todos</button><button class="filter-pill" data-filter="excelente">🟢 Excelente</button><button class="filter-pill" data-filter="bom">🔵 Bom</button><button class="filter-pill" data-filter="regular">🟡 Regular</button><button class="filter-pill" data-filter="fraco">🔴 Fraco</button></div><div id="rc"></div></section>
<section id="campanha" class="screen"><div class="section-title">🔥 Priorizar Vendas</div><div class="search-box"><span>🔍</span><input type="text" id="sc" placeholder="Buscar produto..."></div><div id="lp"></div><div class="section-title">📷 Campanha Fotos ISA</div><div id="lf"></div></section>
</main>
</div>


<script>
// ==========================================
// INTEGRAÇÃO API TOTVS - EXPEDIÇÃO
// ISA|PAES PWA v2.1
// ==========================================

// VERSÃO DO APP - Incrementar para forçar limpeza de cache
const APP_VERSION = '4.3.1';

// Sistema de versionamento - limpa cache mas preserva navegação
(async function checkVersion() {
    const storedVersion = localStorage.getItem('app-version');
    console.log(`[Version] Atual: ${APP_VERSION}, Armazenada: ${storedVersion}`);
    
    if (storedVersion !== APP_VERSION) {
        console.log(`[Version] ATUALIZANDO de ${storedVersion} para ${APP_VERSION}`);
        
        // Salvar TODOS os dados de navegação antes de qualquer operação
        const savedData = {
            navHistory: sessionStorage.getItem('nav-history'),
            loggedUser: sessionStorage.getItem('logged-user'),
            loggedUserData: sessionStorage.getItem('logged-user-data'),
            lastScreens: sessionStorage.getItem('last-screens'),
            lastExpDestino: sessionStorage.getItem('last-exp-destino'),
            lastScroll: sessionStorage.getItem('last-scroll'),
            lastCapsula: sessionStorage.getItem('last-capsula')
        };
        
        console.log('[Version] Dados salvos:', savedData.loggedUser, savedData.lastScreens);
        
        // 1. Limpar TODOS os caches
        if ('caches' in window) {
            const names = await caches.keys();
            console.log('[Version] Caches encontrados:', names);
            for (const name of names) {
                await caches.delete(name);
                console.log('[Version] Cache deletado:', name);
            }
        }
        
        // 1.5 Limpar cache local de expedição (localStorage)
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('exp-cache-')) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        // Limpar cache de fotos também
        localStorage.removeItem('photo-cache');
        localStorage.removeItem('photo-cache-v2');
        console.log('[Version] Cache local de expedição e fotos limpo:', keysToRemove.length, 'itens');
        
        // 2. Desregistrar Service Workers antigos
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const reg of registrations) {
                await reg.unregister();
                console.log('[Version] SW desregistrado');
            }
        }
        
        // 3. Salvar nova versão
        localStorage.setItem('app-version', APP_VERSION);
        
        // 4. Restaurar TODOS os dados de navegação
        if (savedData.navHistory) sessionStorage.setItem('nav-history', savedData.navHistory);
        if (savedData.loggedUser) sessionStorage.setItem('logged-user', savedData.loggedUser);
        if (savedData.loggedUserData) sessionStorage.setItem('logged-user-data', savedData.loggedUserData);
        if (savedData.lastScreens) sessionStorage.setItem('last-screens', savedData.lastScreens);
        if (savedData.lastExpDestino) sessionStorage.setItem('last-exp-destino', savedData.lastExpDestino);
        if (savedData.lastScroll) sessionStorage.setItem('last-scroll', savedData.lastScroll);
        if (savedData.lastCapsula) sessionStorage.setItem('last-capsula', savedData.lastCapsula);
        
        console.log('[Version] Dados restaurados');
        
        // 5. Recarregar apenas se não for primeira vez (sem mudar URL)
        if (storedVersion) {
            console.log('[Version] Recarregando para aplicar atualização...');
            location.reload();
            return;
        }
    }
    console.log('[Version] App OK:', APP_VERSION);
})();

// ===== CONFIGURAÇÃO DA API =====
// Cache é gerenciado 100% no Cloudflare (KV + HTTP Cache)
// Dados são atualizados a cada 5 minutos via Cron Trigger
const API_CONFIG = {
    baseUrl: 'https://isapaes-api.andrefcg.workers.dev',
    apiKey: 'Isapaes@2026!X' // Valor padrão
};

// Inicializar API Key
(function initApiKey() {
    const savedKey = sessionStorage.getItem('isa-api-key');
    if (savedKey) {
        API_CONFIG.apiKey = savedKey;
    }
    console.log('[API] Config inicializada, baseUrl:', API_CONFIG.baseUrl);
})();

// ===== BUSCAR DADOS DA API (cache no Cloudflare) =====
// ===== CACHE LOCAL PERSISTENTE (localStorage) + STALE-WHILE-REVALIDATE =====
const CACHE_MAX_AGE_MS = 24 * 60 * 60 * 1000; // 24 horas - cache máximo
const CACHE_STALE_MS = 5 * 60 * 1000; // 5 minutos - após isso, revalida em background

function getLocalCache(chave, allowStale = false) {
    try {
        const cached = localStorage.getItem('exp-cache-' + chave);
        if (!cached) return { data: null, isStale: false };
        
        const cacheData = JSON.parse(cached);
        const agora = Date.now();
        const idade = agora - cacheData.ts;
        
        // Cache expirou completamente (> 24h)
        if (idade > CACHE_MAX_AGE_MS) {
            console.log('[Cache Local] Expirado (>' + (CACHE_MAX_AGE_MS/3600000) + 'h):', chave);
            localStorage.removeItem('exp-cache-' + chave);
            return { data: null, isStale: false };
        }
        
        // Cache está "stale" (> 5min) mas ainda válido
        const isStale = idade > CACHE_STALE_MS;
        
        if (isStale) {
            console.log('[Cache Local] Stale (revalidar em background):', chave, '- Idade:', Math.round(idade / 1000) + 's');
        } else {
            console.log('[Cache Local] Fresh:', chave, '- Idade:', Math.round(idade / 1000) + 's');
        }
        
        return { data: cacheData.payload, isStale: isStale };
    } catch (e) {
        console.error('[Cache Local] Erro ao ler:', e);
        return { data: null, isStale: false };
    }
}

function setLocalCache(chave, payload) {
    try {
        const data = {
            ts: Date.now(),
            payload: payload
        };
        localStorage.setItem('exp-cache-' + chave, JSON.stringify(data));
        console.log('[Cache Local] Salvo:', chave);
    } catch (e) {
        console.error('[Cache Local] Erro ao salvar:', e);
        // Se localStorage estiver cheio, limpar caches antigos
        if (e.name === 'QuotaExceededError') {
            limparCachesAntigos();
            try {
                localStorage.setItem('exp-cache-' + chave, JSON.stringify({ ts: Date.now(), payload }));
            } catch (e2) {
                console.error('[Cache Local] Falha mesmo após limpeza');
            }
        }
    }
}

function limparCachesAntigos() {
    console.log('[Cache Local] Limpando caches antigos...');
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('exp-cache-')) {
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(key => localStorage.removeItem(key));
    console.log('[Cache Local] Removidos:', keysToRemove.length, 'itens');
}

// Revalidar em background (não bloqueia UI)
async function revalidateInBackground(destino, cacheKey) {
    console.log('[Background] Revalidando:', cacheKey);
    try {
        const colecao = capsulaAtual.colecao || 'I26';
        const capsula = capsulaAtual.num || 1;
        
        const baseEndpoints = {
            'showroom': '/api/totvs/expedicao/showroom-liquido?colecao=' + colecao + '&capsula=' + capsula,
            'ecommerce': '/api/totvs/expedicao/ecommerce?colecao=' + colecao + '&capsula=' + capsula,
            'mostruario': '/api/totvs/expedicao/mostruario?colecao=' + colecao + '&capsula=' + capsula,
            'ld': '/api/totvs/expedicao/ld?colecao=' + colecao + '&capsula=' + capsula
        };
        
        const url = API_CONFIG.baseUrl + baseEndpoints[destino];
        const response = await fetch(url, {
            headers: { 'X-API-Key': API_CONFIG.apiKey }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Verificar se dados são válidos antes de atualizar
            if (!data.error && data.items && data.items.length > 0) {
                setLocalCache(cacheKey, data);
                console.log('[Background] Cache atualizado:', cacheKey, '- Items:', data.items.length);
                
                // Se ainda estiver na mesma tela, atualizar UI silenciosamente
                if (currentExpDestino === destino) {
                    const transformed = transformApiData(data);
                    if (transformed.items && transformed.items.length > 0) {
                        await renderExpedicao(destino, transformed);
                        console.log('[Background] UI atualizada silenciosamente');
                    } else {
                        console.log('[Background] Dados transformados vazios, mantendo UI atual');
                    }
                }
            } else {
                console.log('[Background] Dados inválidos ou vazios, mantendo cache atual');
            }
        }
    } catch (e) {
        console.log('[Background] Erro ao revalidar (ignorado):', e.message);
    }
}

async function fetchExpedicaoFromAPI(destino, forceRefresh) {
    var colecao = capsulaAtual.colecao || 'I26';
    var capsula = capsulaAtual.num || 1;
    var cacheKey = colecao + '-' + capsula + '-' + destino;
    
    // Tentar cache local primeiro (se não for refresh forçado)
    if (!forceRefresh) {
        const { data: cached, isStale } = getLocalCache(cacheKey);
        if (cached) {
            // Se cache está stale, revalidar em background (não bloqueia)
            if (isStale) {
                setTimeout(() => revalidateInBackground(destino, cacheKey), 100);
            }
            return cached;
        }
    }
    
    var baseEndpoints = {
        'showroom': '/api/totvs/expedicao/showroom-liquido?colecao=' + colecao + '&capsula=' + capsula,
        'ecommerce': '/api/totvs/expedicao/ecommerce?colecao=' + colecao + '&capsula=' + capsula,
        'mostruario': '/api/totvs/expedicao/mostruario?colecao=' + colecao + '&capsula=' + capsula,
        'ld': '/api/totvs/expedicao/ld?colecao=' + colecao + '&capsula=' + capsula
    };
    
    var url = API_CONFIG.baseUrl + baseEndpoints[destino];
    if (forceRefresh) url += '&refresh=true';
    
    console.log('[API] ' + destino + ' - ' + colecao + ' Capsula ' + capsula + (forceRefresh ? ' (refresh)' : ''));
    
    var response = await fetch(url, {
        headers: { 'X-API-Key': API_CONFIG.apiKey }
    });
    
    if (!response.ok) throw new Error('HTTP ' + response.status);
    var data = await response.json();
    
    if (data.fromCache) {
        console.log('[API] Cache hit (Cloudflare KV)');
    } else {
        console.log('[API] Dados frescos do TOTVS');
    }
    
    if (data.error) throw new Error(data.error);
    
    // Salvar no cache local
    setLocalCache(cacheKey, data);
    
    return data;
}

function transformApiData(apiData) {
    if (!apiData.items) return { items: [], producao: null, enviosDoDia: apiData.enviosDoDia || null };
    
    const items = apiData.items.map(function(item) {
        return {
            ref: item.ref,
            desc: item.desc,
            cor: item.cor,
            prod: {
                PP: (item.prod && item.prod.PP) || 0,
                P: (item.prod && item.prod.P) || 0,
                M: (item.prod && item.prod.M) || 0,
                G: (item.prod && item.prod.G) || 0
            },
            envShow: {
                PP: (item.envShow && item.envShow.PP) || 0,
                P: (item.envShow && item.envShow.P) || 0,
                M: (item.envShow && item.envShow.M) || 0,
                G: (item.envShow && item.envShow.G) || 0
            }
        };
    });
    
    // Retornar também dados de produção e envios do dia se existirem
    return {
        items: items,
        producao: apiData.producao || null,
        totais: apiData.totais || null,
        enviosDoDia: apiData.enviosDoDia || null
    };
}

// Buscar dados - estrategia hibrida: cache primeiro, refresh se vazio
async function getExpedicaoData(destino) {
    try {
        // Primeiro tenta do cache (rapido)
        var apiData = await fetchExpedicaoFromAPI(destino, false);
        var transformed = transformApiData(apiData);
        
        // Se cache retornou vazio mas tem produtos, busca dados frescos
        if (transformed.items.length === 0 && apiData.totalProdutos > 0) {
            console.log('[API] Cache vazio mas tem ' + apiData.totalProdutos + ' produtos, buscando refresh...');
            apiData = await fetchExpedicaoFromAPI(destino, true);
            transformed = transformApiData(apiData);
        }
        
        console.log('[API] ' + destino + ': ' + transformed.items.length + ' itens');
        
        // Guardar timestamp da atualizacao
        ultimaAtualizacaoTimestamp = new Date();
        
        return transformed;
    } catch (error) {
        console.error('[API] Erro ' + destino + ':', error);
        showExpedicaoToast('Erro ao carregar dados', 'error');
        return { items: [], producao: null, totais: null }; // Retorna vazio ao invés de dados estáticos incorretos
    }
}

function showExpedicaoToast(message, type) {
    if (!type) type = 'info';
    var toast = document.getElementById('exp-toast');
    if (toast) toast.remove();
    
    var colors = { info: '#3b82f6', success: '#10b981', warning: '#f59e0b', error: '#ef4444' };
    
    toast = document.createElement('div');
    toast.id = 'exp-toast';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:' + colors[type] + ';color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2)';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
}

async function refreshExpedicaoData() {
    if (!currentExpDestino) return;
    showExpedicaoToast('Atualizando...', 'info');
    try {
        // Força refresh no Cloudflare
        const colecao = capsulaAtual.colecao || 'I26';
        const capsula = capsulaAtual.num || 1;
        const url = `${API_CONFIG.baseUrl}/api/totvs/expedicao/showroom-liquido?colecao=${colecao}&capsula=${capsula}&refresh=true`;
        await fetch(url, { headers: { 'X-API-Key': API_CONFIG.apiKey } });
        
        renderExpedicao(currentExpDestino);
        showExpedicaoToast('Atualizado!', 'success');
    } catch (error) {
        showExpedicaoToast('Erro ao atualizar', 'error');
    }
}

const R=[{"referencia": "CJI26013", "descricao": "CONJUNTO ALFAIATARIA BLUSA CAPA", "pecas": 5, "valor": 3217.01}, {"referencia": "CJI26002", "descricao": "CONJUNTO BASIC REGATA DETALHE CHANTILLY", "pecas": 3, "valor": 1919.7}, {"referencia": "CLI26001", "descricao": "CALCA ALFAIATARIA BARRA ITALIANA", "pecas": 3, "valor": 869.7}, {"referencia": "BDI26005", "descricao": "BODY BASIC ISA PAES", "pecas": 3, "valor": 719.7}, {"referencia": "BDI26004", "descricao": "BODY BASIC TULE MANGA", "pecas": 3, "valor": 509.7}, {"referencia": "JAI26002", "descricao": "JAQUETA ALFAIATARIA MESCLA", "pecas": 2, "valor": 1279.8}, {"referencia": "VEI26012", "descricao": "VESTIDO CURTO SAIA ASSIMETRICA", "pecas": 2, "valor": 1159.8}, {"referencia": "SAI26004", "descricao": "SAIA CURTA ALFAIATARIA MESCLA", "pecas": 2, "valor": 739.8}, {"referencia": "SAI26003", "descricao": "SAIA MIDI PEPLUM", "pecas": 2, "valor": 579.8}, {"referencia": "BLI26002", "descricao": "BLUSA CROPPED ALFAIATARIA DUO COLOR", "pecas": 2, "valor": 539.8}, {"referencia": "BDI26011", "descricao": "BODY TRICOT DECOTE V", "pecas": 2, "valor": 439.8}, {"referencia": "BLI26003", "descricao": "BLUSA CROPPED ALFAIATARIA CORSELET", "pecas": 2, "valor": 439.8}, {"referencia": "MCI26001", "descricao": "MACACAO LONGO ALFAIATARIA DUO COLOR", "pecas": 1, "valor": 669.9}, {"referencia": "SAI26009", "descricao": "SAIA MIDI TRICOT TRANSPARENCIA", "pecas": 1, "valor": 599.9}, {"referencia": "VEI26023", "descricao": "VESTIDO CURTO ESTAMPADO SAIA BABADOS", "pecas": 1, "valor": 599.9}, {"referencia": "VEI26022", "descricao": "VESTIDO LONGUETE CINTO FLORES", "pecas": 1, "valor": 530.91}, {"referencia": "SAI26001", "descricao": "SAIA MIDI MEIO GODE", "pecas": 1, "valor": 499.9}, {"referencia": "CLI26006", "descricao": "CALCA STREET ALFAIATARIA MESCLA", "pecas": 1, "valor": 469.9}, {"referencia": "CLI26002", "descricao": "CALCA ALFAIATARIA TIRA LATERAL", "pecas": 1, "valor": 429.9}, {"referencia": "CLI26003", "descricao": "CALCA ALFAIATARIA VIES", "pecas": 1, "valor": 399.9}, {"referencia": "SAI26002", "descricao": "SAIA CURTA ALFAIATARIA VIES", "pecas": 1, "valor": 369.9}, {"referencia": "BLI26006", "descricao": "BLUSA TOP PEPLUM DETALHE DECOTE", "pecas": 1, "valor": 309.9}, {"referencia": "BLI26001", "descricao": "BLUSA TOP DETALHE DECOTE", "pecas": 1, "valor": 299.9}, {"referencia": "CAI26006", "descricao": "CAMISA ALFAIATARIA ESTAMPADA", "pecas": 1, "valor": 299.9}, {"referencia": "CLI26005", "descricao": "CALCA ALFAIATARIA NERVURA", "pecas": 1, "valor": 289.9}, {"referencia": "BLI26004", "descricao": "BLUSA CROPPED ALFAIATARIA MESCLA", "pecas": 1, "valor": 219.9}, {"referencia": "BLI26010", "descricao": "BLUSA BASIC MANGA RENDA", "pecas": 1, "valor": 149.9}, {"referencia": "BLI26019", "descricao": "BLUSA BASIC MANGA RENDA", "pecas": 1, "valor": 149.9}, {"referencia": "BLI26013", "descricao": "BLUSA BASIC REGATA ISA PAES", "pecas": 1, "valor": 99.9}];
const A=[{"referencia": "BDI26003", "descricao": "BODY BASIC RENDA", "preco": 239.9, "enviado": 65, "estoqueAtual": 1, "vendidoBruto": 63, "devolucoes": 0, "vendasLiquidas": 64, "aceitacao": 0.984615, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "BLI26010", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "enviado": 80, "estoqueAtual": 0, "vendidoBruto": 77, "devolucoes": 0, "vendasLiquidas": 80, "aceitacao": 1.0, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "CLI26003", "descricao": "CALCA ALFAIATARIA VIES", "preco": 399.9, "enviado": 109, "estoqueAtual": -2, "vendidoBruto": 104, "devolucoes": 2, "vendasLiquidas": 111, "aceitacao": 1.018349, "rejeicao": 0.019231, "status": "🟢 Excelente"}, {"referencia": "BLI26029", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "enviado": 51, "estoqueAtual": -1, "vendidoBruto": 47, "devolucoes": 0, "vendasLiquidas": 52, "aceitacao": 1.019608, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "BLI26013", "descricao": "BLUSA BASIC REGATA ISA PAES", "preco": 99.9, "enviado": 259, "estoqueAtual": 7, "vendidoBruto": 238, "devolucoes": 0, "vendasLiquidas": 252, "aceitacao": 0.972973, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "BLI26019", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "enviado": 55, "estoqueAtual": 6, "vendidoBruto": 49, "devolucoes": 0, "vendasLiquidas": 49, "aceitacao": 0.890909, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "CAI26006", "descricao": "CAMISA ALFAIATARIA ESTAMPADA", "preco": 299.9, "enviado": 80, "estoqueAtual": 7, "vendidoBruto": 67, "devolucoes": 1, "vendasLiquidas": 73, "aceitacao": 0.9125, "rejeicao": 0.014925, "status": "🟢 Excelente"}, {"referencia": "CLI26006", "descricao": "CALCA STREET ALFAIATARIA MESCLA", "preco": 469.9, "enviado": 91, "estoqueAtual": 15, "vendidoBruto": 72, "devolucoes": 0, "vendasLiquidas": 76, "aceitacao": 0.835165, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "CLI26008", "descricao": "CALCA JEANS PAETE", "preco": 599.9, "enviado": 66, "estoqueAtual": 12, "vendidoBruto": 52, "devolucoes": 0, "vendasLiquidas": 54, "aceitacao": 0.818182, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "BZI26002", "descricao": "BLAZER ALFAIATARIA VIES", "preco": 579.9, "enviado": 148, "estoqueAtual": 28, "vendidoBruto": 114, "devolucoes": 1, "vendasLiquidas": 120, "aceitacao": 0.810811, "rejeicao": 0.008772, "status": "🟢 Excelente"}, {"referencia": "JAI26003", "descricao": "JAQUETA JEANS PAETE", "preco": 619.9, "enviado": 65, "estoqueAtual": 18, "vendidoBruto": 46, "devolucoes": 0, "vendasLiquidas": 47, "aceitacao": 0.723077, "rejeicao": 0.0, "status": "🟢 Excelente"}, {"referencia": "BDI26004", "descricao": "BODY BASIC TULE MANGA", "preco": 169.9, "enviado": 194, "estoqueAtual": 49, "vendidoBruto": 128, "devolucoes": 1, "vendasLiquidas": 145, "aceitacao": 0.747423, "rejeicao": 0.007812, "status": "🔵 Bom"}, {"referencia": "JAI26002", "descricao": "JAQUETA ALFAIATARIA MESCLA", "preco": 639.9, "enviado": 117, "estoqueAtual": 33, "vendidoBruto": 76, "devolucoes": 1, "vendasLiquidas": 84, "aceitacao": 0.717949, "rejeicao": 0.013158, "status": "🔵 Bom"}, {"referencia": "BLI26003", "descricao": "BLUSA CROPPED ALFAIATARIA CORSELET", "preco": 219.9, "enviado": 104, "estoqueAtual": 32, "vendidoBruto": 66, "devolucoes": 0, "vendasLiquidas": 72, "aceitacao": 0.692308, "rejeicao": 0.0, "status": "🔵 Bom"}, {"referencia": "CLI26004", "descricao": "CALCA ALFAIATARIA NERVURA", "preco": 259.9, "enviado": 94, "estoqueAtual": 68, "vendidoBruto": 55, "devolucoes": 0, "vendasLiquidas": 26, "aceitacao": 0.276596, "rejeicao": 0.0, "status": "🔵 Bom"}, {"referencia": "BZI26001", "descricao": "BLAZER ALFAIATARIA TELA BORDADA", "preco": 659.9, "enviado": 70, "estoqueAtual": 28, "vendidoBruto": 40, "devolucoes": 0, "vendasLiquidas": 42, "aceitacao": 0.6, "rejeicao": 0.0, "status": "🔵 Bom"}, {"referencia": "BLI26011", "descricao": "BLUSA TOP PEPLUM JEANS PAETE", "preco": 369.9, "enviado": 64, "estoqueAtual": 26, "vendidoBruto": 37, "devolucoes": 0, "vendasLiquidas": 38, "aceitacao": 0.59375, "rejeicao": 0.0, "status": "🔵 Bom ⚠️"}, {"referencia": "CJI26013", "descricao": "CONJUNTO ALFAIATARIA BLUSA CAPA", "preco": 649.9, "enviado": 87, "estoqueAtual": 27, "vendidoBruto": 49, "devolucoes": 1, "vendasLiquidas": 60, "aceitacao": 0.689655, "rejeicao": 0.020408, "status": "🔵 Bom"}, {"referencia": "VEI26025", "descricao": "VESTIDO LONGO ESTAMPADO PALA LASTEX", "preco": 639.9, "enviado": 100, "estoqueAtual": 46, "vendidoBruto": 51, "devolucoes": 0, "vendasLiquidas": 54, "aceitacao": 0.54, "rejeicao": 0.0, "status": "🔵 Bom"}, {"referencia": "SAI26003", "descricao": "SAIA MIDI PEPLUM", "preco": 289.9, "enviado": 195, "estoqueAtual": 76, "vendidoBruto": 95, "devolucoes": 1, "vendasLiquidas": 119, "aceitacao": 0.610256, "rejeicao": 0.010526, "status": "🟡 Regular"}, {"referencia": "VEI26045", "descricao": "VESTIDO CURTO MOULAGE", "preco": 499.9, "enviado": 29, "estoqueAtual": 10, "vendidoBruto": 14, "devolucoes": 0, "vendasLiquidas": 19, "aceitacao": 0.655172, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "BDI26005", "descricao": "BODY BASIC ISA PAES", "preco": 239.9, "enviado": 291, "estoqueAtual": 126, "vendidoBruto": 139, "devolucoes": 2, "vendasLiquidas": 165, "aceitacao": 0.56701, "rejeicao": 0.0, "status": "🟡 Regular ⚠️"}, {"referencia": "BLI26002", "descricao": "BLUSA CROPPED ALFAIATARIA DUO COLOR", "preco": 269.9, "enviado": 134, "estoqueAtual": 68, "vendidoBruto": 61, "devolucoes": 0, "vendasLiquidas": 66, "aceitacao": 0.492537, "rejeicao": 0.014388, "status": "🟡 Regular"}, {"referencia": "SHI26001", "descricao": "SHORT CURTO DETALHE PREGA", "preco": 299.9, "enviado": 71, "estoqueAtual": 37, "vendidoBruto": 32, "devolucoes": 0, "vendasLiquidas": 34, "aceitacao": 0.478873, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "CAI26007", "descricao": "CAMISA ALFAIATARIA PAETE", "preco": 299.9, "enviado": 76, "estoqueAtual": 39, "vendidoBruto": 35, "devolucoes": 1, "vendasLiquidas": 37, "aceitacao": 0.486842, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "MCI26001", "descricao": "MACACAO LONGO ALFAIATARIA DUO COLOR", "preco": 669.9, "enviado": 91, "estoqueAtual": 47, "vendidoBruto": 41, "devolucoes": 1, "vendasLiquidas": 44, "aceitacao": 0.483516, "rejeicao": 0.028571, "status": "🟡 Regular"}, {"referencia": "CAI26009", "descricao": "CAMISA ALFAIATARIA COM PONTEIRA", "preco": 249.9, "enviado": 88, "estoqueAtual": 46, "vendidoBruto": 37, "devolucoes": 0, "vendasLiquidas": 42, "aceitacao": 0.477273, "rejeicao": 0.02439, "status": "🟡 Regular ⚠️"}, {"referencia": "BLI26006", "descricao": "BLUSA TOP PEPLUM DETALHE DECOTE", "preco": 309.9, "enviado": 114, "estoqueAtual": 52, "vendidoBruto": 47, "devolucoes": 0, "vendasLiquidas": 62, "aceitacao": 0.54386, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "CLI26005", "descricao": "CALCA ALFAIATARIA NERVURA", "preco": 289.9, "enviado": 183, "estoqueAtual": 68, "vendidoBruto": 75, "devolucoes": 0, "vendasLiquidas": 115, "aceitacao": 0.628415, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "VEI26012", "descricao": "VESTIDO CURTO SAIA ASSIMETRICA", "preco": 579.9, "enviado": 84, "estoqueAtual": 45, "vendidoBruto": 34, "devolucoes": 0, "vendasLiquidas": 39, "aceitacao": 0.464286, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "VEI26001", "descricao": "VESTIDO LONGO SAIA CAMADAS", "preco": 799.9, "enviado": 58, "estoqueAtual": 35, "vendidoBruto": 23, "devolucoes": 0, "vendasLiquidas": 23, "aceitacao": 0.396552, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "SHI26002", "descricao": "SHORT CURTO ALFAIATARIA BASIC", "preco": 219.9, "enviado": 236, "estoqueAtual": 134, "vendidoBruto": 93, "devolucoes": 0, "vendasLiquidas": 102, "aceitacao": 0.432203, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "BZI26003", "descricao": "BLAZER ALFAIATARIA BASIC ISA PAES", "preco": 469.9, "enviado": 277, "estoqueAtual": 158, "vendidoBruto": 109, "devolucoes": 1, "vendasLiquidas": 119, "aceitacao": 0.429603, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "BLI26004", "descricao": "BLUSA CROPPED ALFAIATARIA MESCLA", "preco": 219.9, "enviado": 129, "estoqueAtual": 77, "vendidoBruto": 49, "devolucoes": 0, "vendasLiquidas": 52, "aceitacao": 0.403101, "rejeicao": 0.009174, "status": "🟡 Regular"}, {"referencia": "CLI26001", "descricao": "CALCA ALFAIATARIA BARRA ITALIANA", "preco": 289.9, "enviado": 189, "estoqueAtual": 102, "vendidoBruto": 71, "devolucoes": 3, "vendasLiquidas": 87, "aceitacao": 0.460317, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "BLI26001", "descricao": "BLUSA TOP DETALHE DECOTE", "preco": 299.9, "enviado": 65, "estoqueAtual": 39, "vendidoBruto": 23, "devolucoes": 0, "vendasLiquidas": 26, "aceitacao": 0.4, "rejeicao": 0.042254, "status": "🟡 Regular"}, {"referencia": "CLI26002", "descricao": "CALCA ALFAIATARIA TIRA LATERAL", "preco": 429.9, "enviado": 130, "estoqueAtual": 82, "vendidoBruto": 46, "devolucoes": 1, "vendasLiquidas": 48, "aceitacao": 0.369231, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "SAI26004", "descricao": "SAIA CURTA ALFAIATARIA MESCLA", "preco": 369.9, "enviado": 116, "estoqueAtual": 68, "vendidoBruto": 41, "devolucoes": 1, "vendasLiquidas": 48, "aceitacao": 0.413793, "rejeicao": 0.021739, "status": "🟡 Regular"}, {"referencia": "VEI26023", "descricao": "VESTIDO CURTO ESTAMPADO SAIA BABADOS", "preco": 599.9, "enviado": 80, "estoqueAtual": 48, "vendidoBruto": 27, "devolucoes": 1, "vendasLiquidas": 32, "aceitacao": 0.4, "rejeicao": 0.02439, "status": "🟡 Regular ⚠️"}, {"referencia": "BLI26026", "descricao": "BLUSA BASIC CAVADA MARTINGALES", "preco": 269.9, "enviado": 51, "estoqueAtual": 35, "vendidoBruto": 16, "devolucoes": 0, "vendasLiquidas": 16, "aceitacao": 0.313725, "rejeicao": 0.037037, "status": "🟡 Regular ⚠️"}, {"referencia": "SAI26001", "descricao": "SAIA MIDI MEIO GODE", "preco": 499.9, "enviado": 70, "estoqueAtual": 47, "vendidoBruto": 21, "devolucoes": 0, "vendasLiquidas": 23, "aceitacao": 0.328571, "rejeicao": 0.0, "status": "🟡 Regular"}, {"referencia": "VEI26008", "descricao": "VESTIDO CURTO APLICACAO RENDA", "preco": 599.9, "enviado": 78, "estoqueAtual": 55, "vendidoBruto": 21, "devolucoes": 0, "vendasLiquidas": 23, "aceitacao": 0.294872, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "CJI26002", "descricao": "CONJUNTO BASIC REGATA DETALHE CHANTILLY", "preco": 639.9, "enviado": 136, "estoqueAtual": 90, "vendidoBruto": 36, "devolucoes": 0, "vendasLiquidas": 46, "aceitacao": 0.338235, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "SAI26002", "descricao": "SAIA CURTA ALFAIATARIA VIES", "preco": 369.9, "enviado": 113, "estoqueAtual": 82, "vendidoBruto": 29, "devolucoes": 0, "vendasLiquidas": 31, "aceitacao": 0.274336, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "BDI26011", "descricao": "BODY TRICOT DECOTE V", "preco": 219.9, "enviado": 131, "estoqueAtual": 109, "vendidoBruto": 17, "devolucoes": 1, "vendasLiquidas": 22, "aceitacao": 0.167939, "rejeicao": 0.0, "status": "🔴 Fraco ⚠️"}, {"referencia": "JAI26001", "descricao": "JAQUETA BOMBER DETALHE TRICOT", "preco": 499.9, "enviado": 63, "estoqueAtual": 48, "vendidoBruto": 15, "devolucoes": 0, "vendasLiquidas": 15, "aceitacao": 0.238095, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "VEI26006", "descricao": "VESTIDO CURTO DETALHE SOBREPOSICAO", "preco": 799.9, "enviado": 77, "estoqueAtual": 60, "vendidoBruto": 17, "devolucoes": 0, "vendasLiquidas": 17, "aceitacao": 0.220779, "rejeicao": 0.058824, "status": "🔴 Fraco"}, {"referencia": "SAI26009", "descricao": "SAIA MIDI TRICOT TRANSPARENCIA", "preco": 599.9, "enviado": 92, "estoqueAtual": 69, "vendidoBruto": 19, "devolucoes": 1, "vendasLiquidas": 23, "aceitacao": 0.25, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "SAI26005", "descricao": "SAIA MIDI TULE PAETE", "preco": 349.9, "enviado": 57, "estoqueAtual": 46, "vendidoBruto": 11, "devolucoes": 0, "vendasLiquidas": 11, "aceitacao": 0.192982, "rejeicao": 0.0, "status": "🔴 Fraco ⚠️"}, {"referencia": "VEI26009", "descricao": "VESTIDO LONGO BABADOS RENDA", "preco": 699.9, "enviado": 73, "estoqueAtual": 58, "vendidoBruto": 13, "devolucoes": 0, "vendasLiquidas": 15, "aceitacao": 0.205479, "rejeicao": 0.052632, "status": "🔴 Fraco"}, {"referencia": "VEI26022", "descricao": "VESTIDO LONGUETE CINTO FLORES", "preco": 589.9, "enviado": 95, "estoqueAtual": 77, "vendidoBruto": 14, "devolucoes": 0, "vendasLiquidas": 18, "aceitacao": 0.189474, "rejeicao": 0.0, "status": "🔴 Fraco ⚠️"}, {"referencia": "VEI26010", "descricao": "VESTIDO LONGO DETALHE CUT-OUT", "preco": 629.9, "enviado": 63, "estoqueAtual": 58, "vendidoBruto": 5, "devolucoes": 0, "vendasLiquidas": 5, "aceitacao": 0.079365, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "BLI26027", "descricao": "BLUSA REGATA BASIC ISA PAES", "preco": 99.9, "enviado": 137, "estoqueAtual": 123, "vendidoBruto": 7, "devolucoes": 1, "vendasLiquidas": 14, "aceitacao": 0.10219, "rejeicao": 0.0, "status": "🔴 Fraco"}, {"referencia": "BLI26028", "descricao": "BLUSA TOP PAETE PEPLUM DETALHE DECOTE", "preco": 359.9, "enviado": 54, "estoqueAtual": 52, "vendidoBruto": 2, "devolucoes": 0, "vendasLiquidas": 2, "aceitacao": 0.037037, "rejeicao": 0.142857, "status": "🔴 Fraco"}];
const P=[{"referencia": "CLI26008", "descricao": "CALCA JEANS PAETE", "preco": 599.9, "estoqueEnviado": 66, "estoqueAtual": 12, "vendasLiquidas": 54, "giro": 0.818182, "ranking": 9, "status": "Excelente", "vendasHoje": 1}, {"referencia": "BZI26002", "descricao": "BLAZER ALFAIATARIA VIES", "preco": 579.9, "estoqueEnviado": 148, "estoqueAtual": 28, "vendasLiquidas": 120, "giro": 0.810811, "ranking": 10, "status": "Excelente", "vendasHoje": 4}, {"referencia": "CLI26006", "descricao": "CALCA STREET ALFAIATARIA MESCLA", "preco": 469.9, "estoqueEnviado": 91, "estoqueAtual": 15, "vendasLiquidas": 76, "giro": 0.835165, "ranking": 8, "status": "Excelente", "vendasHoje": 2}, {"referencia": "CLI26003", "descricao": "CALCA ALFAIATARIA VIES", "preco": 399.9, "estoqueEnviado": 109, "estoqueAtual": -2, "vendasLiquidas": 111, "giro": 1.018349, "ranking": 3, "status": "Excelente", "vendasHoje": 5}, {"referencia": "CAI26006", "descricao": "CAMISA ALFAIATARIA ESTAMPADA", "preco": 299.9, "estoqueEnviado": 80, "estoqueAtual": 7, "vendasLiquidas": 73, "giro": 0.9125, "ranking": 7, "status": "Excelente", "vendasHoje": 1}, {"referencia": "BDI26003", "descricao": "BODY BASIC RENDA", "preco": 239.9, "estoqueEnviado": 65, "estoqueAtual": 1, "vendasLiquidas": 64, "giro": 0.984615, "ranking": 1, "status": "Excelente", "vendasHoje": 0}, {"referencia": "BLI26010", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "estoqueEnviado": 80, "estoqueAtual": 0, "vendasLiquidas": 80, "giro": 1.0, "ranking": 2, "status": "Excelente", "vendasHoje": 2}, {"referencia": "BLI26019", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "estoqueEnviado": 55, "estoqueAtual": 6, "vendasLiquidas": 49, "giro": 0.890909, "ranking": 6, "status": "Excelente", "vendasHoje": 1}, {"referencia": "BLI26029", "descricao": "BLUSA BASIC MANGA RENDA", "preco": 149.9, "estoqueEnviado": 51, "estoqueAtual": -1, "vendasLiquidas": 52, "giro": 1.019608, "ranking": 4, "status": "Excelente", "vendasHoje": 0}, {"referencia": "BLI26013", "descricao": "BLUSA BASIC REGATA ISA PAES", "preco": 99.9, "estoqueEnviado": 259, "estoqueAtual": 7, "vendasLiquidas": 252, "giro": 0.972973, "ranking": 5, "status": "Excelente", "vendasHoje": 5}, {"referencia": "BZI26001", "descricao": "BLAZER ALFAIATARIA TELA BORDADA", "preco": 659.9, "estoqueEnviado": 70, "estoqueAtual": 28, "vendasLiquidas": 42, "giro": 0.6, "ranking": 16, "status": "Bom", "vendasHoje": 0}, {"referencia": "CJI26013", "descricao": "CONJUNTO ALFAIATARIA BLUSA CAPA", "preco": 649.9, "estoqueEnviado": 87, "estoqueAtual": 27, "vendasLiquidas": 60, "giro": 0.689655, "ranking": 18, "status": "Bom", "vendasHoje": 5}, {"referencia": "VEI26025", "descricao": "VESTIDO LONGO ESTAMPADO PALA LASTEX", "preco": 639.9, "estoqueEnviado": 100, "estoqueAtual": 46, "vendasLiquidas": 54, "giro": 0.54, "ranking": 19, "status": "Bom", "vendasHoje": 0}, {"referencia": "JAI26002", "descricao": "JAQUETA ALFAIATARIA MESCLA", "preco": 639.9, "estoqueEnviado": 117, "estoqueAtual": 33, "vendasLiquidas": 84, "giro": 0.717949, "ranking": 13, "status": "Bom", "vendasHoje": 4}, {"referencia": "BLI26011", "descricao": "BLUSA TOP PEPLUM JEANS PAETE", "preco": 369.9, "estoqueEnviado": 64, "estoqueAtual": 26, "vendasLiquidas": 38, "giro": 0.59375, "ranking": 17, "status": "Bom", "vendasHoje": 0}, {"referencia": "CLI26004", "descricao": "CALCA ALFAIATARIA NERVURA", "preco": 259.9, "estoqueEnviado": 94, "estoqueAtual": 68, "vendasLiquidas": 26, "giro": 0.276596, "ranking": 15, "status": "Bom", "vendasHoje": 0}, {"referencia": "BLI26003", "descricao": "BLUSA CROPPED ALFAIATARIA CORSELET", "preco": 219.9, "estoqueEnviado": 104, "estoqueAtual": 32, "vendasLiquidas": 72, "giro": 0.692308, "ranking": 14, "status": "Bom", "vendasHoje": 3}, {"referencia": "BDI26004", "descricao": "BODY BASIC TULE MANGA", "preco": 169.9, "estoqueEnviado": 194, "estoqueAtual": 49, "vendasLiquidas": 145, "giro": 0.747423, "ranking": 12, "status": "Bom", "vendasHoje": 5}, {"referencia": "JAI26003", "descricao": "JAQUETA JEANS PAETE", "preco": 619.9, "estoqueEnviado": 65, "estoqueAtual": 18, "vendasLiquidas": 47, "giro": 0.723077, "ranking": 20, "status": "Bom", "vendasHoje": 0}];
const F=[{"referencia": "BLI26028", "descricao": "BLUSA TOP PAETE PEPLUM DETALHE DECOTE", "preco": 359.9, "estoqueEnviado": 54, "estoqueAtual": 52, "vendasLiquidas": 2, "giro": 0.037037, "ranking": 1, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "BLI26027", "descricao": "BLUSA REGATA BASIC ISA PAES", "preco": 99.9, "estoqueEnviado": 137, "estoqueAtual": 123, "vendasLiquidas": 14, "giro": 0.10219, "ranking": 2, "status": "Fotos ISA", "vendasHoje": 7}, {"referencia": "VEI26010", "descricao": "VESTIDO LONGO DETALHE CUT-OUT", "preco": 629.9, "estoqueEnviado": 63, "estoqueAtual": 58, "vendasLiquidas": 5, "giro": 0.079365, "ranking": 3, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "BDI26011", "descricao": "BODY TRICOT DECOTE V", "preco": 219.9, "estoqueEnviado": 131, "estoqueAtual": 109, "vendasLiquidas": 22, "giro": 0.167939, "ranking": 4, "status": "Fotos ISA", "vendasHoje": 3}, {"referencia": "VEI26022", "descricao": "VESTIDO LONGUETE CINTO FLORES", "preco": 589.9, "estoqueEnviado": 95, "estoqueAtual": 77, "vendasLiquidas": 18, "giro": 0.189474, "ranking": 5, "status": "Fotos ISA", "vendasHoje": 2}, {"referencia": "VEI26009", "descricao": "VESTIDO LONGO BABADOS RENDA", "preco": 699.9, "estoqueEnviado": 73, "estoqueAtual": 58, "vendasLiquidas": 15, "giro": 0.205479, "ranking": 6, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SAI26005", "descricao": "SAIA MIDI TULE PAETE", "preco": 349.9, "estoqueEnviado": 57, "estoqueAtual": 46, "vendasLiquidas": 11, "giro": 0.192982, "ranking": 7, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SAI26009", "descricao": "SAIA MIDI TRICOT TRANSPARENCIA", "preco": 599.9, "estoqueEnviado": 92, "estoqueAtual": 69, "vendasLiquidas": 23, "giro": 0.25, "ranking": 8, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "VEI26006", "descricao": "VESTIDO CURTO DETALHE SOBREPOSICAO", "preco": 799.9, "estoqueEnviado": 77, "estoqueAtual": 60, "vendasLiquidas": 17, "giro": 0.220779, "ranking": 9, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "JAI26001", "descricao": "JAQUETA BOMBER DETALHE TRICOT", "preco": 499.9, "estoqueEnviado": 63, "estoqueAtual": 48, "vendasLiquidas": 15, "giro": 0.238095, "ranking": 10, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SAI26002", "descricao": "SAIA CURTA ALFAIATARIA VIES", "preco": 369.9, "estoqueEnviado": 113, "estoqueAtual": 82, "vendasLiquidas": 31, "giro": 0.274336, "ranking": 11, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "CJI26002", "descricao": "CONJUNTO BASIC REGATA DETALHE CHANTILLY", "preco": 639.9, "estoqueEnviado": 136, "estoqueAtual": 90, "vendasLiquidas": 46, "giro": 0.338235, "ranking": 12, "status": "Fotos ISA", "vendasHoje": 3}, {"referencia": "VEI26008", "descricao": "VESTIDO CURTO APLICACAO RENDA", "preco": 599.9, "estoqueEnviado": 78, "estoqueAtual": 55, "vendasLiquidas": 23, "giro": 0.294872, "ranking": 13, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SAI26001", "descricao": "SAIA MIDI MEIO GODE", "preco": 499.9, "estoqueEnviado": 70, "estoqueAtual": 47, "vendasLiquidas": 23, "giro": 0.328571, "ranking": 14, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "BLI26026", "descricao": "BLUSA BASIC CAVADA MARTINGALES", "preco": 269.9, "estoqueEnviado": 51, "estoqueAtual": 35, "vendasLiquidas": 16, "giro": 0.313725, "ranking": 15, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "VEI26023", "descricao": "VESTIDO CURTO ESTAMPADO SAIA BABADOS", "preco": 599.9, "estoqueEnviado": 80, "estoqueAtual": 48, "vendasLiquidas": 32, "giro": 0.4, "ranking": 16, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "SAI26004", "descricao": "SAIA CURTA ALFAIATARIA MESCLA", "preco": 369.9, "estoqueEnviado": 116, "estoqueAtual": 68, "vendasLiquidas": 48, "giro": 0.413793, "ranking": 17, "status": "Fotos ISA", "vendasHoje": 2}, {"referencia": "CLI26002", "descricao": "CALCA ALFAIATARIA TIRA LATERAL", "preco": 429.9, "estoqueEnviado": 130, "estoqueAtual": 82, "vendasLiquidas": 48, "giro": 0.369231, "ranking": 18, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "BLI26001", "descricao": "BLUSA TOP DETALHE DECOTE", "preco": 299.9, "estoqueEnviado": 65, "estoqueAtual": 39, "vendasLiquidas": 26, "giro": 0.4, "ranking": 19, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "CLI26001", "descricao": "CALCA ALFAIATARIA BARRA ITALIANA", "preco": 289.9, "estoqueEnviado": 189, "estoqueAtual": 102, "vendasLiquidas": 87, "giro": 0.460317, "ranking": 20, "status": "Fotos ISA", "vendasHoje": 7}, {"referencia": "BLI26004", "descricao": "BLUSA CROPPED ALFAIATARIA MESCLA", "preco": 219.9, "estoqueEnviado": 129, "estoqueAtual": 77, "vendasLiquidas": 52, "giro": 0.403101, "ranking": 21, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "BZI26003", "descricao": "BLAZER ALFAIATARIA BASIC ISA PAES", "preco": 469.9, "estoqueEnviado": 277, "estoqueAtual": 158, "vendasLiquidas": 119, "giro": 0.429603, "ranking": 22, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SHI26002", "descricao": "SHORT CURTO ALFAIATARIA BASIC", "preco": 219.9, "estoqueEnviado": 236, "estoqueAtual": 134, "vendasLiquidas": 102, "giro": 0.432203, "ranking": 23, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "VEI26001", "descricao": "VESTIDO LONGO SAIA CAMADAS", "preco": 799.9, "estoqueEnviado": 58, "estoqueAtual": 35, "vendasLiquidas": 23, "giro": 0.396552, "ranking": 24, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "VEI26012", "descricao": "VESTIDO CURTO SAIA ASSIMETRICA", "preco": 579.9, "estoqueEnviado": 84, "estoqueAtual": 45, "vendasLiquidas": 39, "giro": 0.464286, "ranking": 25, "status": "Fotos ISA", "vendasHoje": 2}, {"referencia": "CLI26005", "descricao": "CALCA ALFAIATARIA NERVURA", "preco": 289.9, "estoqueEnviado": 183, "estoqueAtual": 68, "vendasLiquidas": 115, "giro": 0.628415, "ranking": 26, "status": "Fotos ISA", "vendasHoje": 4}, {"referencia": "BLI26006", "descricao": "BLUSA TOP PEPLUM DETALHE DECOTE", "preco": 309.9, "estoqueEnviado": 114, "estoqueAtual": 52, "vendasLiquidas": 62, "giro": 0.54386, "ranking": 27, "status": "Fotos ISA", "vendasHoje": 6}, {"referencia": "CAI26009", "descricao": "CAMISA ALFAIATARIA COM PONTEIRA", "preco": 249.9, "estoqueEnviado": 88, "estoqueAtual": 46, "vendasLiquidas": 42, "giro": 0.477273, "ranking": 28, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "MCI26001", "descricao": "MACACAO LONGO ALFAIATARIA DUO COLOR", "preco": 669.9, "estoqueEnviado": 91, "estoqueAtual": 47, "vendasLiquidas": 44, "giro": 0.483516, "ranking": 29, "status": "Fotos ISA", "vendasHoje": 1}, {"referencia": "CAI26007", "descricao": "CAMISA ALFAIATARIA PAETE", "preco": 299.9, "estoqueEnviado": 76, "estoqueAtual": 39, "vendasLiquidas": 37, "giro": 0.486842, "ranking": 30, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "SHI26001", "descricao": "SHORT CURTO DETALHE PREGA", "preco": 299.9, "estoqueEnviado": 71, "estoqueAtual": 37, "vendasLiquidas": 34, "giro": 0.478873, "ranking": 31, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "BLI26002", "descricao": "BLUSA CROPPED ALFAIATARIA DUO COLOR", "preco": 269.9, "estoqueEnviado": 134, "estoqueAtual": 68, "vendasLiquidas": 66, "giro": 0.492537, "ranking": 32, "status": "Fotos ISA", "vendasHoje": 2}, {"referencia": "VEI26045", "descricao": "VESTIDO CURTO MOULAGE", "preco": 499.9, "estoqueEnviado": 29, "estoqueAtual": 10, "vendasLiquidas": 19, "giro": 0.655172, "ranking": 33, "status": "Fotos ISA", "vendasHoje": 0}, {"referencia": "BDI26005", "descricao": "BODY BASIC ISA PAES", "preco": 239.9, "estoqueEnviado": 291, "estoqueAtual": 126, "vendasLiquidas": 165, "giro": 0.56701, "ranking": 34, "status": "Fotos ISA", "vendasHoje": 6}, {"referencia": "SAI26003", "descricao": "SAIA MIDI PEPLUM", "preco": 289.9, "estoqueEnviado": 195, "estoqueAtual": 76, "vendasLiquidas": 119, "giro": 0.610256, "ranking": 35, "status": "Fotos ISA", "vendasHoje": 8}];

// Splash -> Login Inicial -> Welcome -> Home
const isFirstVisit = !sessionStorage.getItem('isa-paes-visited');
const splashTime = isFirstVisit ? 3700 : 1800;
sessionStorage.setItem('isa-paes-visited', 'true');
document.querySelector('.splash-logo').classList.add(isFirstVisit ? 'first-visit' : 'revisit');

// Histórico de navegação para botão voltar
let navHistory = ['home'];

// Telas válidas para restauração (mesmas do goToScreen)
const VALID_SCREENS = ['home','login-screen','sub-comercial','sub-expedicao','sub-expedicao-inverno','sub-expedicao-verao','sub-expedicao-destinos','resumo-dia-screen','app-comercial','app-expedicao','geo-screen','changepw-screen','changepw-form-screen','sub-compras','sub-compras-inverno','sub-compras-verao','dev-compras','dev-financeiro','users-screen'];

// Salvar estado da página antes de sair
window.addEventListener('beforeunload', function(){
    const screenIds = [];
    
    // Verificar se home está visível
    if(document.getElementById('home').classList.contains('visible')){
        screenIds.push('home');
    }
    
    // Só salvar telas de navegação válidas que estejam ativas
    VALID_SCREENS.forEach(id => {
        if(id === 'home') return; // já tratado acima
        const el = document.getElementById(id);
        if(el && el.classList.contains('active')) screenIds.push(id);
    });
    
    sessionStorage.setItem('last-screens', JSON.stringify(screenIds));
    sessionStorage.setItem('last-scroll', window.scrollY);
    // Salvar histórico de navegação completo
    sessionStorage.setItem('nav-history', JSON.stringify(navHistory));
    console.log('[NAV-DEBUG] === BEFOREUNLOAD === screens salvas:', JSON.stringify(screenIds), '| navHistory:', JSON.stringify(navHistory));
    // Salvar destino de expedição se estiver ativo
    if(currentExpDestino) sessionStorage.setItem('last-exp-destino', currentExpDestino);
    // Salvar cápsula atual
    if(typeof capsulaAtual !== 'undefined') sessionStorage.setItem('last-capsula', JSON.stringify(capsulaAtual));
});

setTimeout(()=>{
    const splash = document.getElementById('splash');
    function afterSplash(){
        splash.style.display='none';
        // Verificar se já está logado (refresh)
        const savedUser = sessionStorage.getItem('logged-user');
        const savedUserData = sessionStorage.getItem('logged-user-data');
        
        // Verificar se tem usuário salvo (não depender de USERS local)
        if(savedUser){
            currentUser = savedUser;
            
            // Iniciar heartbeat e verificação de kick
            startHeartbeat();
            startKickCheck();
            
            // Restaurar dados do usuário se existirem
            if (savedUserData) {
                try {
                    USERS[savedUser] = JSON.parse(savedUserData);
                } catch(e) {
                    console.log('[Restore] Erro ao restaurar dados do usuário');
                }
            }
            
            // Atualizar dados do usuário em background (buscar permissões atualizadas)
            atualizarDadosUsuarioBackground(savedUser);
            
            // Já logado - restaurar última tela ou ir para home
            const lastScreens = sessionStorage.getItem('last-screens');
            const lastScroll = sessionStorage.getItem('last-scroll');
            const lastExpDestino = sessionStorage.getItem('last-exp-destino');
            const savedNavHistory = sessionStorage.getItem('nav-history');
            const lastCapsula = sessionStorage.getItem('last-capsula');
            
            // Restaurar cápsula atual
            if (lastCapsula) {
                try {
                    capsulaAtual = JSON.parse(lastCapsula);
                    console.log('[Restore] Cápsula restaurada:', capsulaAtual);
                } catch(e) {
                    console.log('[Restore] Erro ao restaurar cápsula');
                }
            }
            
            let screens = [];
            try {
                screens = lastScreens ? JSON.parse(lastScreens) : [];
            } catch(e) {
                screens = [];
            }
            
            // Restaurar histórico de navegação
            try {
                const restoredHistory = savedNavHistory ? JSON.parse(savedNavHistory) : ['home'];
                navHistory = restoredHistory.length > 0 ? restoredHistory : ['home'];
            } catch(e) {
                navHistory = ['home'];
            }
            
            // NÃO recriar pushState para cada tela - apenas substituir o estado atual
            // O navHistory em memória já controla a navegação via popstate
            history.replaceState({screen: navHistory[navHistory.length - 1] || 'home', restored: true}, '', '');
            
            // Função para mostrar home
            function showHome(){
                const home = document.getElementById('home');
                home.classList.remove('hidden');
                home.classList.add('visible');
                // Atualizar visibilidade dos módulos
                setTimeout(updateModulesVisibility, 100);
                console.log('[NAV-DEBUG] showHome() chamado | home classes:', home.className);
            }
            
            console.log('[NAV-DEBUG] screens para restaurar (raw):', JSON.stringify(screens));
            
            // Filtrar telas válidas (remover home e welcome-screen, e só aceitar telas de navegação)
            const telasParaRestaurar = screens.filter(id => id !== 'home' && id !== 'welcome-screen' && VALID_SCREENS.includes(id));
            
            console.log('[NAV-DEBUG] telasParaRestaurar:', JSON.stringify(telasParaRestaurar));
            
            // Se não tem telas para restaurar, mostrar home
            if(telasParaRestaurar.length === 0){
                console.log('[NAV-DEBUG] Nenhuma tela para restaurar -> showHome()');
                showHome();
                return;
            }
            
            // Atualizar visibilidade dos módulos em background
            setTimeout(updateModulesVisibility, 100);
            
            // Tem outras telas para restaurar
            // Primeiro esconde home
            const home = document.getElementById('home');
            home.classList.add('hidden');
            home.classList.remove('visible');
            console.log('[NAV-DEBUG] Home escondida, restaurando telas:', JSON.stringify(telasParaRestaurar));
            
            // Restaurar cada tela visualmente
            telasParaRestaurar.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('active');
                }
            });
            
            // Restaurar destino de expedição se necessário
            if(telasParaRestaurar.includes('app-expedicao') && lastExpDestino){
                currentExpDestino = lastExpDestino;
                console.log('[NAV-DEBUG] Restaurando expedição:', lastExpDestino);
                renderExpedicao(lastExpDestino);
            }
            // Restaurar scroll
            if(lastScroll){
                setTimeout(() => window.scrollTo(0, parseInt(lastScroll)), 100);
            }
        } else {
            // Não logado - tentar biometria ou mostrar login
            tryInitialBiometric();
        }
    }
    if(isFirstVisit){
        afterSplash();
    } else {
        splash.classList.add('fade-out');
        setTimeout(afterSplash, 300);
    }
},splashTime);

async function tryInitialBiometric(){
    const bioUser = localStorage.getItem('bio-user');
    const credId = localStorage.getItem('bio-cred-id');
    console.log('[Bio] Verificando biometria inicial...');
    console.log('[Bio] bioUser:', bioUser);
    console.log('[Bio] credId existe:', !!credId);
    console.log('[Bio] PublicKeyCredential:', !!window.PublicKeyCredential);
    
    // Verificar se tem biometria cadastrada
    if(bioUser && credId && window.PublicKeyCredential){
        try{
            console.log('[Bio] Tentando autenticar com biometria...');
            const rawId = Uint8Array.from(atob(credId), c=>c.charCodeAt(0));
            const a = await navigator.credentials.get({publicKey:{
                challenge: crypto.getRandomValues(new Uint8Array(32)),
                allowCredentials:[{id:rawId, type:'public-key'}],
                userVerification:'required', timeout:60000
            }});
            if(a){
                console.log('[Bio] ✅ Autenticação biométrica bem sucedida!');
                
                // Carregar dados do usuário do sessionStorage (salvos no último login)
                const savedUserData = sessionStorage.getItem('logged-user-data');
                if (savedUserData) {
                    try {
                        const userData = JSON.parse(savedUserData);
                        USERS[bioUser] = { ...userData, pw: '' };
                        console.log('[Bio] Dados do usuário carregados do sessionStorage');
                    } catch(e) {
                        console.log('[Bio] Erro ao carregar dados do usuário:', e);
                    }
                }
                
                // Se não tem dados no sessionStorage, buscar da API
                if (!USERS[bioUser]) {
                    try {
                        console.log('[Bio] Buscando dados do usuário na API...');
                        const resp = await fetch(`${API_CONFIG.baseUrl}/api/users/${bioUser}`, {
                            headers: { 
                                'X-API-Key': API_CONFIG.apiKey || 'Isapaes@2026!X',
                                'X-User-Id': bioUser
                            }
                        });
                        if (resp.ok) {
                            const data = await resp.json();
                            if (data.user) {
                                USERS[bioUser] = { ...data.user, pw: '' };
                                sessionStorage.setItem('logged-user-data', JSON.stringify(data.user));
                                console.log('[Bio] Dados do usuário carregados da API:', data.user.role, data.user.access);
                            }
                        }
                    } catch(e) {
                        console.log('[Bio] Erro ao buscar dados da API:', e.message);
                    }
                }
                
                // Último fallback: sem dados da API, não dar acesso
                if (!USERS[bioUser]) {
                    USERS[bioUser] = { 
                        nome: bioUser.charAt(0).toUpperCase() + bioUser.slice(1),
                        access: [],
                        channels: [],
                        pw: ''
                    };
                    console.log('[Bio] Sem dados da API - acesso bloqueado até verificação');
                }
                
                sessionStorage.setItem('logged-user', bioUser);
                startHeartbeat();
                startKickCheck();
                getWeatherAndShowWelcome(bioUser);
                return;
            }
        }catch(e){
            console.log('[Bio] ❌ Biometria cancelada/falhou:', e.message || e);
        }
    } else {
        console.log('[Bio] Biometria não disponível ou não cadastrada');
        console.log('[Bio] Detalhes: bioUser=' + !!bioUser + ', credId=' + !!credId + ', PKC=' + !!window.PublicKeyCredential);
    }
    // Sem biometria - mostrar login
    console.log('[Bio] Mostrando tela de login');
    document.getElementById('initial-login').classList.add('active');
    setTimeout(()=>document.getElementById('initial-user').focus(),100);
}

async function doInitialLogin(){
    const user = document.getElementById('initial-user').value.trim().toLowerCase();
    const pw = document.getElementById('initial-pw').value;
    
    // Mostrar loading
    const btn = document.querySelector('#initial-login .login-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Autenticando...';
    btn.disabled = true;
    
    try {
        const result = await autenticarViaAPI(user, pw);
        
        if (!result.success) {
            document.getElementById('initial-error').textContent = result.error || 'Usuário ou senha incorretos';
            document.getElementById('initial-pw').value = '';
            btn.textContent = originalText;
            btn.disabled = false;
            return;
        }
        
        // Salvar dados do usuário na sessão
        sessionStorage.setItem('logged-user', user);
        if (result.user) {
            sessionStorage.setItem('logged-user-data', JSON.stringify(result.user));
            // Atualizar USERS local com dados da API
            USERS[user] = { ...result.user, pw: pw };
        }
        
        document.getElementById('initial-error').textContent = '';
        document.getElementById('initial-login').classList.remove('active');
        
        // Iniciar heartbeat e verificação de kick
        currentUser = user;
        startHeartbeat();
        startKickCheck();
        
        // Verificar se é primeiro login (pedir apelido)
        if (result.user && result.user.firstLogin) {
            console.log('[Login] Primeiro login detectado, pedindo apelido');
            window.pendingFirstLoginUser = user;
            window.pendingFirstLoginPw = pw;
            document.getElementById('first-login-nome').value = result.user.nome || '';
            document.getElementById('first-login-modal').classList.add('active');
            setTimeout(() => document.getElementById('first-login-nome').focus(), 100);
            btn.textContent = originalText;
            btn.disabled = false;
            return;
        }
        
        // Verificar se biometria está disponível e NÃO está cadastrada ainda
        const bioUserAtual = localStorage.getItem('bio-user');
        
        // Se já tem biometria cadastrada (para qualquer usuário), não perguntar
        if (bioUserAtual) {
            console.log('[Bio] Já tem biometria cadastrada para:', bioUserAtual);
            getWeatherAndShowWelcome(user);
            return;
        }
        
        // Detectar se é PWA instalado
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true ||
                      document.referrer.includes('android-app://');
        console.log('[Bio] Rodando como PWA:', isPWA);
        
        // Verificar se dispositivo suporta biometria
        let biometriaDisponivel = false;
        if (window.PublicKeyCredential) {
            try {
                // Em PWA Android, sempre tentar mostrar o modal
                // A verificação real acontece no momento do registro
                if (isPWA) {
                    biometriaDisponivel = true;
                    console.log('[Bio] PWA detectado - assumindo biometria disponível');
                } else if (typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function') {
                    biometriaDisponivel = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                } else {
                    biometriaDisponivel = true;
                }
            } catch(e) {
                console.log('[Bio] Erro verificação:', e);
                biometriaDisponivel = true;
            }
        }
        
        console.log('[Bio] Disponível:', biometriaDisponivel);
        
        // Oferecer biometria usando modal customizado
        if (biometriaDisponivel) {
            mostrarModalBiometria(user);
            return;
        }
        
        getWeatherAndShowWelcome(user);
        
    } catch (e) {
        console.error('[Auth] Erro:', e);
        document.getElementById('initial-error').textContent = 'Erro de conexão. Tente novamente.';
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function registerInitialBiometric(user){
    try{
        const id = new TextEncoder().encode(user);
        const cred = await navigator.credentials.create({publicKey:{
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            rp:{name:'Isa Paes', id:location.hostname},
            user:{id, name:user, displayName:USERS[user]?.nome || user},
            pubKeyCredParams:[{alg:-7, type:'public-key'},{alg:-257, type:'public-key'}],
            authenticatorSelection:{authenticatorAttachment:'platform', userVerification:'required', residentKey:'discouraged'},
            timeout:60000
        }});
        if(cred){
            localStorage.setItem('bio-user', user);
            localStorage.setItem('bio-cred-id', btoa(String.fromCharCode(...new Uint8Array(cred.rawId))));
            console.log('[Bio] ✅ Biometria cadastrada para:', user);
            return true;
        }
    }catch(e){
        console.log('[Bio] Erro ao cadastrar:', e);
    }
    return false;
}

// Modal de biometria customizado (funciona em PWA)
function mostrarModalBiometria(user) {
    const modal = document.getElementById('bio-modal');
    const btnYes = document.getElementById('bio-modal-yes');
    const btnNo = document.getElementById('bio-modal-no');
    
    modal.classList.add('active');
    
    btnYes.onclick = async () => {
        modal.classList.remove('active');
        await registerInitialBiometric(user);
        getWeatherAndShowWelcome(user);
    };
    
    btnNo.onclick = () => {
        modal.classList.remove('active');
        getWeatherAndShowWelcome(user);
    };
}

// Função para criar gotas de chuva
function createRainDrops(){
    const rain = document.getElementById('welcome-rain');
    rain.innerHTML = '';
    for(let i = 0; i < 100; i++){
        const drop = document.createElement('div');
        drop.className = 'rain-drop';
        drop.style.left = Math.random() * 100 + '%';
        drop.style.height = Math.random() * 20 + 10 + 'px';
        drop.style.animationDuration = Math.random() * 0.5 + 0.5 + 's';
        drop.style.animationDelay = Math.random() * 2 + 's';
        rain.appendChild(drop);
    }
}

// Função para criar flocos de neve
function createSnowflakes(){
    const snow = document.getElementById('welcome-snow');
    snow.innerHTML = '';
    for(let i = 0; i < 50; i++){
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.innerHTML = '❄';
        flake.style.left = Math.random() * 100 + '%';
        flake.style.fontSize = Math.random() * 10 + 10 + 'px';
        flake.style.opacity = Math.random() * 0.5 + 0.5;
        flake.style.animationDuration = Math.random() * 3 + 3 + 's';
        flake.style.animationDelay = Math.random() * 5 + 's';
        snow.appendChild(flake);
    }
}

// Atualizar dados do usuário em background (permissões, etc)
async function atualizarDadosUsuarioBackground(userId) {
    try {
        console.log('[Background] Atualizando dados do usuário:', userId);
        const response = await fetch(`${API_CONFIG.baseUrl}/api/users/${userId}`, {
            headers: { 
                'X-API-Key': API_CONFIG.apiKey,
                'X-User-Id': userId
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.user) {
                // Atualizar USERS local
                USERS[userId] = { ...USERS[userId], ...data.user };
                // Atualizar sessionStorage
                sessionStorage.setItem('logged-user-data', JSON.stringify(data.user));
                console.log('[Background] Dados do usuário atualizados:', data.user.access);
                // Atualizar visibilidade dos módulos
                updateModulesVisibility();
            }
        }
    } catch (e) {
        console.log('[Background] Erro ao atualizar dados do usuário:', e.message);
    }
}

// ===== CLIMA VIA WEATHERAPI.COM =====
const WEATHER_API_KEY = 'bc2557ae0d204fc5abd155031260702';

// Mapear condition code do WeatherAPI para tipo de céu
function getWeatherType(code){
    // https://www.weatherapi.com/docs/weather_conditions.json
    // Tempestade
    if([1087,1273,1276,1279,1282].includes(code)) return 'storm';
    // Neve
    if([1066,1114,1117,1210,1213,1216,1219,1222,1225,1255,1258].includes(code)) return 'snow';
    // Chuva
    if([1063,1180,1183,1186,1189,1192,1195,1240,1243,1246].includes(code)) return 'rain';
    // Garoa / chuva leve
    if([1150,1153,1168,1171].includes(code)) return 'drizzle';
    // Neblina
    if([1030,1135,1147].includes(code)) return 'fog';
    // Nublado
    if(code === 1006 || code === 1009) return 'cloudy';
    // Parcialmente nublado
    if(code === 1003) return 'partly-cloudy';
    // Granizo / sleet
    if([1069,1072,1198,1201,1204,1207,1237,1249,1252,1261,1264].includes(code)) return 'rain';
    // Céu limpo
    return 'clear';
}

// Buscar clima via Open-Meteo (gratuito, sem API key)
async function fetchWeather(lat, lon){
    try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code,temperature_2m,relative_humidity_2m,apparent_temperature`;
        const res = await fetch(url);
        const data = await res.json();
        const wmo = data.current.weather_code;
        let type = 'clear';
        if(wmo === 0) type = 'clear';
        else if(wmo <= 2) type = 'partly-cloudy';
        else if(wmo === 3) type = 'cloudy';
        else if(wmo >= 45 && wmo <= 48) type = 'fog';
        else if(wmo >= 51 && wmo <= 57) type = 'drizzle';
        else if(wmo >= 61 && wmo <= 67) type = 'rain';
        else if(wmo >= 71 && wmo <= 77) type = 'snow';
        else if(wmo >= 80 && wmo <= 82) type = 'rain';
        else if(wmo >= 85 && wmo <= 86) type = 'snow';
        else if(wmo >= 95) type = 'storm';
        const wmoTexts = {0:'Céu limpo',1:'Principalmente limpo',2:'Parcialmente nublado',3:'Nublado',45:'Nevoeiro',48:'Nevoeiro com geada',51:'Garoa leve',53:'Garoa moderada',55:'Garoa forte',61:'Chuva leve',63:'Chuva moderada',65:'Chuva forte',71:'Neve leve',73:'Neve moderada',75:'Neve forte',80:'Pancadas leves',81:'Pancadas moderadas',82:'Pancadas fortes',95:'Trovoada',96:'Trovoada com granizo',99:'Trovoada com granizo forte'};
        console.log('[Weather] Open-Meteo WMO:', wmo, 'type:', type);
        return {
            code: wmo,
            temp: Math.round(data.current.temperature_2m),
            feelsLike: Math.round(data.current.apparent_temperature),
            humidity: data.current.relative_humidity_2m,
            type,
            conditionText: wmoTexts[wmo] || 'Indefinido',
            icon: '',
            city: ''
        };
    }catch(e){
        console.log('Erro ao buscar clima:', e);
        return null;
    }
}

// Esconder todos os elementos climáticos
function hideAllWeatherElements(){
    const elements = ['welcome-stars','welcome-clouds','welcome-sun','welcome-sunset-clouds','welcome-sunset-sun','welcome-heavy-clouds','welcome-rain','welcome-lightning','welcome-snow','welcome-fog'];
    elements.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
}

function showWelcomeScreen(user, weather = null){
    // Setar usuário atual
    currentUser = user;
    
    // Garantir que o usuário existe no USERS
    if (!USERS[user]) {
        // Tentar carregar do sessionStorage
        const savedUserData = sessionStorage.getItem('logged-user-data');
        if (savedUserData) {
            try {
                USERS[user] = JSON.parse(savedUserData);
                console.log('[Welcome] Dados do usuário carregados do sessionStorage');
            } catch(e) {
                console.log('[Welcome] Erro ao carregar dados:', e);
            }
        }
        // Se ainda não existe, criar básico
        if (!USERS[user]) {
            USERS[user] = { 
                nome: user.charAt(0).toUpperCase() + user.slice(1),
                access: [],
                channels: []
            };
            console.log('[Welcome] Sem dados do usuário - acesso bloqueado até verificação');
        }
    }
    
    const u = USERS[user];
    
    const hour = new Date().getHours();
    let greeting, skyClass;
    const isNight = hour < 5 || hour >= 18;
    const isMorning = hour >= 5 && hour < 12;
    const isAfternoon = hour >= 12 && hour < 18;
    
    // Definir saudação
    if(isMorning) greeting = 'Bom dia,';
    else if(isAfternoon) greeting = 'Boa tarde,';
    else greeting = 'Boa noite,';
    
    // Esconder todos os elementos climáticos
    hideAllWeatherElements();
    
    const weatherType = weather ? weather.type : 'clear';
    
    // Definir classe do céu e elementos baseado no clima + período
    if(weatherType === 'storm'){
        skyClass = 'storm';
        createRainDrops();
        document.getElementById('welcome-rain').style.display = 'block';
        document.getElementById('welcome-lightning').style.display = 'block';
        document.getElementById('welcome-heavy-clouds').style.display = 'block';
    } else if(weatherType === 'rain' || weatherType === 'drizzle'){
        skyClass = isNight ? 'rainy-night' : 'rainy-day';
        createRainDrops();
        document.getElementById('welcome-rain').style.display = 'block';
        document.getElementById('welcome-heavy-clouds').style.display = 'block';
    } else if(weatherType === 'snow'){
        skyClass = isNight ? 'snowy-night' : 'snowy-day';
        createSnowflakes();
        document.getElementById('welcome-snow').style.display = 'block';
        document.getElementById('welcome-heavy-clouds').style.display = 'block';
    } else if(weatherType === 'fog'){
        skyClass = 'foggy';
        document.getElementById('welcome-fog').style.display = 'block';
    } else if(weatherType === 'cloudy' || weatherType === 'partly-cloudy'){
        skyClass = isNight ? 'cloudy-night' : 'cloudy-day';
        document.getElementById('welcome-heavy-clouds').style.display = 'block';
        if(isNight) document.getElementById('welcome-stars').style.display = 'block';
    } else {
        // Céu limpo
        if(isMorning){
            skyClass = 'morning';
            document.getElementById('welcome-clouds').style.display = 'block';
            document.getElementById('welcome-sun').style.display = 'block';
        } else if(isAfternoon){
            skyClass = 'afternoon';
            document.getElementById('welcome-sunset-clouds').style.display = 'block';
            document.getElementById('welcome-sunset-sun').style.display = 'block';
        } else {
            skyClass = 'night';
            document.getElementById('welcome-stars').style.display = 'block';
        }
    }
    
    const ws = document.getElementById('welcome-screen');
    // Determinar se há nuvens que podem sobrepor o texto
    const hasClouds = ['storm','rain','drizzle','snow','cloudy','partly-cloudy'].includes(weatherType) || (weatherType === 'clear' && (isMorning || isAfternoon));
    ws.className = 'welcome-screen ' + skyClass + (hasClouds ? ' text-bottom' : '');
    
    document.getElementById('welcome-greeting').textContent = greeting;
    document.getElementById('welcome-name').textContent = u.nome;
    ws.classList.add('active');
    
    setTimeout(()=>{
        ws.classList.add('fade-out');
        setTimeout(()=>{
            ws.classList.remove('active');
            ws.classList.remove('fade-out');
            const homeEl = document.getElementById('home');
            homeEl.classList.remove('hidden');
            homeEl.classList.add('visible');
            pushState('home');
            // Atualizar visibilidade dos módulos baseado no acesso do usuário
            updateModulesVisibility();
        },500);
    },3500);
}

// Função para obter localização e clima
async function getWeatherAndShowWelcome(user){
    // Verificar se GPS foi negado anteriormente
    const gpsNegado = localStorage.getItem('gps-negado');
    
    if(gpsNegado === 'true'){
        // Usar BH direto sem perguntar
        fetchWeather(-19.9167, -43.9345).then(weather => {
            showWelcomeScreen(user, weather);
        }).catch(() => showWelcomeScreen(user, null));
        return;
    }
    
    // Tentar obter localização GPS
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                // GPS permitido - salvar e usar
                localStorage.setItem('gps-negado', 'false');
                const weather = await fetchWeather(pos.coords.latitude, pos.coords.longitude);
                showWelcomeScreen(user, weather);
            },
            (err) => {
                console.log('GPS não disponível:', err);
                // Salvar que foi negado para não perguntar novamente
                localStorage.setItem('gps-negado', 'true');
                // Fallback: usar localização padrão (Belo Horizonte)
                fetchWeather(-19.9167, -43.9345).then(weather => {
                    showWelcomeScreen(user, weather);
                }).catch(() => showWelcomeScreen(user, null));
            },
            {timeout: 5000, enableHighAccuracy: false}
        );
    } else {
        // Sem suporte a GPS - usar BH
        localStorage.setItem('gps-negado', 'true');
        fetchWeather(-19.9167, -43.9345).then(weather => {
            showWelcomeScreen(user, weather);
        }).catch(() => showWelcomeScreen(user, null));
    }
}

// ===== NAVEGAÇÃO COM HISTORY API (BOTÃO VOLTAR NATIVO) =====
function pushState(screen) {
    if (navHistory[navHistory.length - 1] !== screen) {
        navHistory.push(screen);
        history.pushState({screen: screen}, '', '');
    }
    // Salvar tela atual para persistência ao recarregar
    sessionStorage.setItem('current-screen', screen);
}
function getCurrentScreen() {
    if (document.getElementById('home').classList.contains('visible')) return 'home';
    if (document.getElementById('login-screen').classList.contains('active')) return 'login';
    if (document.getElementById('sub-comercial').classList.contains('active')) return 'sub-comercial';
    if (document.getElementById('sub-expedicao').classList.contains('active')) return 'sub-expedicao';
    if (document.getElementById('sub-expedicao-inverno').classList.contains('active')) return 'sub-expedicao-inverno';
    if (document.getElementById('sub-expedicao-verao').classList.contains('active')) return 'sub-expedicao-verao';
    if (document.getElementById('sub-expedicao-destinos').classList.contains('active')) return 'sub-expedicao-destinos';
    if (document.getElementById('resumo-dia-screen').classList.contains('active')) return 'resumo-dia-screen';
    if (document.getElementById('app-comercial').classList.contains('active')) return 'app-comercial';
    if (document.getElementById('app-expedicao').classList.contains('active')) return 'app-expedicao';
    if (document.getElementById('geo-screen').classList.contains('active')) return 'geo-screen';
    if (document.getElementById('changepw-screen').classList.contains('active')) return 'changepw';
    if (document.getElementById('dev-compras').classList.contains('active')) return 'dev-compras';
    if (document.getElementById('sub-compras').classList.contains('active')) return 'sub-compras';
    if (document.getElementById('sub-compras-inverno').classList.contains('active')) return 'sub-compras-inverno';
    if (document.getElementById('sub-compras-verao').classList.contains('active')) return 'sub-compras-verao';
    if (document.getElementById('dev-financeiro').classList.contains('active')) return 'dev-financeiro';
    return 'home';
}
function navigateBack() {
    if (navHistory.length > 1) {
        navHistory.pop(); // Remove tela atual
        const prevScreen = navHistory[navHistory.length - 1];
        goToScreen(prevScreen, false);
        return true;
    }
    return false;
}
function goToScreen(screen, addToHistory = true) {
    hideAll();
    switch(screen) {
        case 'home':
            document.getElementById('home').classList.remove('hidden');
            document.getElementById('home').classList.add('visible');
            currentMod = null;
            break;
        case 'login':
            showLoginScreen(currentMod || 'comercial');
            break;
        case 'sub-comercial':
            document.getElementById('sub-comercial').classList.add('active');
            break;
        case 'sub-expedicao':
            document.getElementById('sub-expedicao').classList.add('active');
            break;
        case 'sub-expedicao-inverno':
            document.getElementById('sub-expedicao-inverno').classList.add('active');
            break;
        case 'sub-expedicao-verao':
            document.getElementById('sub-expedicao-verao').classList.add('active');
            break;
        case 'sub-expedicao-destinos':
            document.getElementById('sub-expedicao-destinos').classList.add('active');
            break;
        case 'resumo-dia-screen':
            document.getElementById('resumo-dia-screen').classList.add('active');
            renderResumoEnviosDia();
            break;
        case 'app-comercial':
            document.getElementById('app-comercial').classList.add('active');
            break;
        case 'app-expedicao':
            document.getElementById('app-expedicao').classList.add('active');
            if(currentExpDestino) renderExpedicao(currentExpDestino);
            break;
        case 'geo-screen':
            document.getElementById('geo-screen').classList.add('active');
            geoInit();
            break;
        case 'changepw':
        case 'changepw-screen':
            document.getElementById('changepw-screen').classList.add('active');
            break;
        case 'changepw-form-screen':
            document.getElementById('changepw-form-screen').classList.add('active');
            break;
        case 'dev-compras':
            document.getElementById('dev-compras').classList.add('active');
            comprasInit();
            break;
        case 'sub-compras':
            document.getElementById('sub-compras').classList.add('active');
            break;
        case 'sub-compras-inverno':
            document.getElementById('sub-compras-inverno').classList.add('active');
            break;
        case 'sub-compras-verao':
            document.getElementById('sub-compras-verao').classList.add('active');
            break;
        case 'dev-financeiro':
            document.getElementById('dev-financeiro').classList.add('active');
            break;
        case 'users-screen':
            document.getElementById('users-screen').classList.add('active');
            break;
        default:
            document.getElementById('home').classList.remove('hidden');
            document.getElementById('home').classList.add('visible');
    }
    if (addToHistory) pushState(screen);
}
// Listener para o botão voltar do navegador/celular
let _handlingPop = false;
window.addEventListener('popstate', function(e) {
    if (_handlingPop) return;
    _handlingPop = true;
    
    // Se o modal de foto está aberto, fechar ele primeiro
    const photoModal = document.getElementById('photo-modal');
    if (photoModal && photoModal.classList.contains('active')) {
        closePhoto(true);
        setTimeout(function(){ _handlingPop = false; }, 100);
        return;
    }
    
    // Se o modal de envios detalhes está aberto, fechar ele
    const enviosModal = document.getElementById('envios-detalhes-modal');
    if (enviosModal) {
        fecharDetalhesEnvios(true);
        setTimeout(function(){ _handlingPop = false; }, 100);
        return;
    }
    
    // Se o modal de formulário de usuário está aberto, fechar ele
    const userFormModal = document.getElementById('user-form-modal');
    if (userFormModal && userFormModal.classList.contains('active')) {
        closeUserForm(true);
        setTimeout(function(){ _handlingPop = false; }, 100);
        return;
    }
    
    // Se o mapa está em fullscreen, sair do fullscreen
    const mapSection = document.querySelector('.geo-map-section.fullscreen');
    if (mapSection) {
        geoToggleFullscreen();
        history.pushState({screen: 'geo-screen'}, '', '');
        setTimeout(function(){ _handlingPop = false; }, 100);
        return;
    }
    
    if (navHistory.length > 1) {
        navHistory.pop();
        const prevScreen = navHistory[navHistory.length - 1] || 'home';
        goToScreen(prevScreen, false);
        if (navHistory.length <= 1) {
            history.pushState({screen: 'home'}, '', '');
        }
    } else {
        goToScreen('home', false);
        history.pushState({screen: 'home'}, '', '');
    }
    
    setTimeout(function(){ _handlingPop = false; }, 100);
});
// Prevenir que o app feche ao apertar voltar na home
history.pushState({screen: 'home'}, '', '');

// ===== USUÁRIOS E PERMISSÕES =====
// =====================================================
// AUTENTICAÇÃO DE USUÁRIOS
// =====================================================
// Usuários são autenticados via API (/auth endpoint)
// Credenciais ficam seguras no Cloudflare (APP_USERS)
// =====================================================

let USERS = {};

// Função para autenticar via API
async function autenticarViaAPI(usuario, senha, novoNome = null) {
    try {
        const body = { usuario, senha };
        if (novoNome) body.novoNome = novoNome;
        
        const response = await fetch(`${API_CONFIG.baseUrl}/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await response.json();
        
        if (data.authenticated) {
            // Salvar API Key na sessão
            if (data.apiKey) {
                API_CONFIG.apiKey = data.apiKey;
                sessionStorage.setItem('isa-api-key', data.apiKey);
            }
            // Retornar dados do usuário
            return {
                success: true,
                user: data.user
            };
        }
        return { success: false, error: data.error || 'Credenciais inválidas' };
    } catch (e) {
        console.error('[Auth] Erro na API:', e);
        return { success: false, error: 'Erro de conexão. Verifique sua internet.' };
    }
}

// ===== SENHAS PERSISTENTES (localStorage) =====
(function loadSavedPasswords(){
    const saved=localStorage.getItem('isa-paes-passwords');
    if(saved){try{const pw=JSON.parse(saved);Object.keys(pw).forEach(u=>{if(USERS[u])USERS[u].pw=pw[u]})}catch(e){}}
})();
function savePasswords(){
    const pw={};Object.keys(USERS).forEach(u=>pw[u]=USERS[u].pw);
    localStorage.setItem('isa-paes-passwords',JSON.stringify(pw));
}

// ===== ALTERAR SENHA =====
let changePwReturnTo=null;
function openChangePw(){
    if(!currentUser){alert('Faça login primeiro');return}
    // detectar de qual tela veio
    if(document.getElementById('sub-comercial').classList.contains('active'))changePwReturnTo='sub-comercial';
    else if(document.getElementById('dev-compras').classList.contains('active'))changePwReturnTo='dev-compras';
    else if(document.getElementById('dev-financeiro').classList.contains('active'))changePwReturnTo='dev-financeiro';
    else if(document.getElementById('app-comercial').classList.contains('active'))changePwReturnTo='sub-comercial';
    else if(document.getElementById('geo-screen').classList.contains('active'))changePwReturnTo='sub-comercial';
    else changePwReturnTo='home';
    hideAll();
    document.getElementById('changepw-screen').classList.add('active');
    pushState('changepw-screen');
    document.getElementById('changepw-user-label').textContent='Logado como: '+USERS[currentUser].nome;
    
    // Mostrar/esconder botão de gestão de usuários baseado no role
    const u = USERS[currentUser];
    const btnGestao = document.getElementById('btn-gestao-usuarios');
    if (btnGestao) {
        if (u && (u.role === 'admin' || (u.access && u.access.includes('usuarios')))) {
            btnGestao.style.display = 'flex';
        } else {
            btnGestao.style.display = 'none';
        }
    }
    
    // Atualizar status da biometria
    atualizarStatusBiometria();
}

function showChangePassword(){
    hideAll();
    document.getElementById('changepw-form-screen').classList.add('active');
    pushState('changepw-form-screen');
    document.getElementById('changepw-form-user-label').textContent='Logado como: '+USERS[currentUser].nome;
    document.getElementById('changepw-current').value='';
    document.getElementById('changepw-new').value='';
    document.getElementById('changepw-confirm').value='';
    document.getElementById('changepw-msg').textContent='';
    document.getElementById('changepw-msg').className='changepw-msg';
    setTimeout(()=>document.getElementById('changepw-current').focus(),100);
}

function backToSettings(){
    hideAll();
    document.getElementById('changepw-screen').classList.add('active');
    pushState('changepw-screen');
}

function atualizarStatusBiometria() {
    const bioUser = localStorage.getItem('bio-user');
    const statusEl = document.getElementById('bio-status');
    const btnEl = document.getElementById('bio-action-btn');
    
    if (bioUser) {
        statusEl.innerHTML = '✅ Ativada para: <strong>' + (USERS[bioUser]?.nome || bioUser) + '</strong>';
        btnEl.textContent = '🗑️ Desativar Biometria';
        btnEl.className = 'changepw-btn danger';
        btnEl.onclick = desativarBiometria;
    } else {
        statusEl.innerHTML = '❌ Não configurada';
        btnEl.textContent = '🔐 Ativar Biometria';
        btnEl.className = 'changepw-btn secondary';
        btnEl.onclick = ativarBiometria;
    }
}

// Toggle mostrar/ocultar senha
function toggleShowPassword(inputId, btn) {
    const input = document.getElementById(inputId);
    const eyeOpen = '<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
    const eyeClosed = '<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
    
    // Verificar se usa -webkit-text-security (campos type=text disfarçados)
    const currentSecurity = input.style.webkitTextSecurity || input.style['-webkit-text-security'];
    
    if (input.type === 'password' || currentSecurity === 'disc') {
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.style.webkitTextSecurity = 'none';
        }
        btn.innerHTML = eyeClosed;
    } else {
        if (input.classList.contains('pwd-field')) {
            input.style.webkitTextSecurity = 'disc';
        } else {
            input.type = 'password';
        }
        btn.innerHTML = eyeOpen;
    }
}

// Confirmar nome do primeiro login
async function confirmFirstLoginName() {
    const novoNome = document.getElementById('first-login-nome').value.trim();
    
    if (!novoNome) {
        alert('Por favor, digite como quer ser chamado');
        return;
    }
    
    const user = window.pendingFirstLoginUser;
    const pw = window.pendingFirstLoginPw;
    
    if (!user || !pw) {
        console.error('[FirstLogin] Dados pendentes não encontrados');
        document.getElementById('first-login-modal').classList.remove('active');
        return;
    }
    
    try {
        // Chamar API novamente com o novo nome
        const result = await autenticarViaAPI(user, pw, novoNome);
        
        if (result.success && result.user) {
            // Atualizar dados locais
            USERS[user] = { ...result.user, pw: pw };
            sessionStorage.setItem('logged-user-data', JSON.stringify(result.user));
        }
        
        // Fechar modal
        document.getElementById('first-login-modal').classList.remove('active');
        
        // Limpar dados pendentes
        window.pendingFirstLoginUser = null;
        window.pendingFirstLoginPw = null;
        
        // Continuar fluxo normal (verificar biometria ou ir para welcome)
        const bioUserAtual = localStorage.getItem('bio-user');
        if (bioUserAtual) {
            getWeatherAndShowWelcome(user);
        } else {
            // Verificar se pode oferecer biometria
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            let biometriaDisponivel = false;
            
            if (window.PublicKeyCredential) {
                if (isPWA) {
                    biometriaDisponivel = true;
                } else if (typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function') {
                    biometriaDisponivel = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                }
            }
            
            if (biometriaDisponivel) {
                showBiometricOffer(user);
            } else {
                getWeatherAndShowWelcome(user);
            }
        }
    } catch (e) {
        console.error('[FirstLogin] Erro:', e);
        document.getElementById('first-login-modal').classList.remove('active');
        getWeatherAndShowWelcome(user);
    }
}

async function ativarBiometria() {
    if (!currentUser) { alert('Faça login primeiro'); return; }
    
    const btn = document.getElementById('bio-action-btn');
    btn.textContent = 'Aguarde...';
    btn.disabled = true;
    
    try {
        const success = await registerInitialBiometric(currentUser);
        if (success) {
            alert('✅ Biometria ativada com sucesso!');
        } else {
            alert('❌ Não foi possível ativar a biometria. Tente novamente.');
        }
    } catch (e) {
        console.log('[Bio] Erro ao ativar:', e);
        alert('❌ Erro ao ativar biometria: ' + e.message);
    }
    
    btn.disabled = false;
    atualizarStatusBiometria();
}

function desativarBiometria() {
    if (confirm('Deseja realmente desativar a biometria?')) {
        localStorage.removeItem('bio-user');
        localStorage.removeItem('bio-cred-id');
        console.log('[Bio] Biometria desativada');
        alert('✅ Biometria desativada!');
        atualizarStatusBiometria();
    }
}
async function doChangePw(){
    const msg=document.getElementById('changepw-msg');
    const curr=document.getElementById('changepw-current').value;
    const newP=document.getElementById('changepw-new').value;
    const conf=document.getElementById('changepw-confirm').value;
    msg.textContent='';msg.className='changepw-msg';
    
    if(!curr||!newP||!conf){msg.textContent='Preencha todos os campos';msg.classList.add('error');return}
    if(newP.length<3){msg.textContent='Nova senha deve ter pelo menos 3 caracteres';msg.classList.add('error');return}
    if(newP!==conf){msg.textContent='As senhas não conferem';msg.classList.add('error');document.getElementById('changepw-confirm').value='';return}
    if(newP===curr){msg.textContent='A nova senha deve ser diferente da atual';msg.classList.add('error');return}
    
    // Chamar API para alterar senha
    msg.textContent='Alterando...';
    msg.className='changepw-msg';
    
    try {
        const userId = currentUser || sessionStorage.getItem('logged-user');
        const response = await fetch(`${API_CONFIG.baseUrl}/auth/change-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuario: userId,
                senhaAtual: curr,
                novaSenha: newP
            })
        });
        
        const data = await response.json();
        
        if (!response.ok || data.error) {
            msg.textContent = data.error || 'Erro ao alterar senha';
            msg.classList.add('error');
            if (data.error === 'Senha atual incorreta') {
                document.getElementById('changepw-current').value='';
            }
            return;
        }
        
        // Atualizar localmente também
        if (USERS[currentUser]) {
            USERS[currentUser].pw = newP;
        }
        
        msg.textContent='✓ Senha alterada com sucesso!';
        msg.classList.add('success');
        document.getElementById('changepw-current').value='';
        document.getElementById('changepw-new').value='';
        document.getElementById('changepw-confirm').value='';
        
        // voltar automaticamente após 1.5s
        setTimeout(()=>backToSettings(),1500);
        
    } catch(e) {
        console.error('[ChangePw] Erro:', e);
        msg.textContent='Erro de conexão. Tente novamente.';
        msg.classList.add('error');
    }
}
function backFromChangePw(){
    if(changePwReturnTo && changePwReturnTo!=='home'){
        goBackTo(changePwReturnTo);
    }else{goBackTo('home')}
    changePwReturnTo=null;
}

function doLogout(){
    if(!confirm('Deseja realmente sair da conta?')) return;
    
    // Parar heartbeat e verificação de kick
    stopHeartbeat();
    stopKickCheck();
    
    // Notificar servidor que o usuário saiu (remove sessão ativa imediatamente)
    if (currentUser) {
        try {
            // Usar sendBeacon para garantir envio mesmo ao fechar
            const data = JSON.stringify({ userId: currentUser });
            const sent = navigator.sendBeacon(`${API_CONFIG.baseUrl}/sessions/logout`, data);
            if (!sent) {
                // Fallback com fetch
                fetch(`${API_CONFIG.baseUrl}/sessions/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': API_CONFIG.apiKey },
                    body: data,
                    keepalive: true
                }).catch(() => {});
            }
            console.log('[Logout] Sessão removida do servidor');
        } catch(e) {
            console.log('[Logout] Erro ao remover sessão:', e.message);
        }
    }
    
    // Limpar TODOS os dados de sessão
    sessionStorage.clear();
    
    // Limpar cache local de expedição
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('exp-cache-')) {
            keysToRemove.push(key);
        }
    }
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    // Limpar biometria se quiser logout completo
    localStorage.removeItem('bio-user');
    localStorage.removeItem('bio-cred-id');
    
    // Limpar variáveis
    currentUser = null;
    currentMod = null;
    currentExpDestino = null;
    navHistory = ['home'];
    capsulaAtual = { colecao: 'I26', num: 1 };
    
    // Esconder todas as telas
    hideAll();
    
    // Mostrar tela de login INICIAL (não a de módulo)
    document.getElementById('initial-login').classList.add('active');
    
    // Limpar campos de login inicial
    const initialUser = document.getElementById('initial-user');
    const initialPw = document.getElementById('initial-pw');
    const initialError = document.getElementById('initial-error');
    if (initialUser) initialUser.value = '';
    if (initialPw) initialPw.value = '';
    if (initialError) initialError.textContent = '';
    
    console.log('[Logout] Usuário deslogado completamente');
}

let currentMod=null, currentUser=null;
const allScreens='.app-screen,.dev-screen,.login-screen,.submenu-screen,.changepw-screen,.geo-screen,.users-screen';
function hideAll(){document.querySelectorAll(allScreens).forEach(s=>s.classList.remove('active'));document.getElementById('home').classList.add('hidden');document.getElementById('home').classList.remove('visible')}
const modIcons={comercial:'📊',compras:'🛒',financeiro:'💰',expedicao:'📦'};
const modNames={comercial:'Comercial',compras:'Compras',financeiro:'Financeiro',expedicao:'Expedição'};

// ===== EXPEDIÇÃO =====
const EXPEDICAO_INV1 = [{"ref":"BDI26003","desc":"BODY BASIC RENDA","cor":"MARFIM","prod":{"PP":11,"P":22,"M":22,"G":10},"envShow":{"PP":11,"P":22,"M":22,"G":10}},{"ref":"BDI26004","desc":"BODY BASIC TULE MANGA","cor":"AREIA","prod":{"PP":17,"P":32,"M":33,"G":18},"envShow":{"PP":17,"P":32,"M":33,"G":18}},{"ref":"BDI26004","desc":"BODY BASIC TULE MANGA","cor":"PRETO","prod":{"PP":16,"P":31,"M":31,"G":16},"envShow":{"PP":16,"P":31,"M":31,"G":16}},{"ref":"BDI26005","desc":"BODY BASIC ISA PAES","cor":"MARFIM","prod":{"PP":14,"P":29,"M":29,"G":15},"envShow":{"PP":14,"P":29,"M":29,"G":15}},{"ref":"BDI26005","desc":"BODY BASIC ISA PAES","cor":"MARROM","prod":{"PP":15,"P":29,"M":30,"G":15},"envShow":{"PP":15,"P":29,"M":30,"G":15}},{"ref":"BDI26005","desc":"BODY BASIC ISA PAES","cor":"PRETO","prod":{"PP":20,"P":38,"M":37,"G":20},"envShow":{"PP":20,"P":38,"M":37,"G":20}},{"ref":"BDI26011","desc":"BODY TRICOT DECOTE V","cor":"MARROM","prod":{"PP":10,"P":23,"M":22,"G":10},"envShow":{"PP":10,"P":23,"M":22,"G":10}},{"ref":"BDI26011","desc":"BODY TRICOT DECOTE V","cor":"PRETO","prod":{"PP":11,"P":18,"M":23,"G":11},"envShow":{"PP":11,"P":18,"M":23,"G":11}},{"ref":"BLI26001","desc":"BLUSA TOP DETALHE DECOTE","cor":"MARROM","prod":{"PP":11,"P":23,"M":21,"G":11},"envShow":{"PP":11,"P":23,"M":21,"G":11}},{"ref":"BLI26002","desc":"BLUSA CROPPED ALFAIATARIA DUO COLOR","cor":"AMARELO CLARO","prod":{"PP":26,"P":28,"M":51,"G":26},"envShow":{"PP":26,"P":28,"M":51,"G":26}},{"ref":"BLI26002","desc":"BLUSA CROPPED ALFAIATARIA DUO COLOR","cor":"ROSA CLARO","prod":{"PP":18,"P":35,"M":32,"G":12},"envShow":{"PP":18,"P":35,"M":32,"G":12}},{"ref":"BLI26003","desc":"BLUSA CROPPED ALFAIATARIA CORSELET","cor":"AZUL CLARO","prod":{"PP":9,"P":17,"M":18,"G":8},"envShow":{"PP":9,"P":17,"M":18,"G":8}},{"ref":"BLI26003","desc":"BLUSA CROPPED ALFAIATARIA CORSELET","cor":"MARFIM","prod":{"PP":8,"P":18,"M":18,"G":8},"envShow":{"PP":8,"P":18,"M":18,"G":8}},{"ref":"BLI26004","desc":"BLUSA CROPPED ALFAIATARIA MESCLA","cor":"AZUL","prod":{"PP":10,"P":22,"M":21,"G":11},"envShow":{"PP":10,"P":22,"M":21,"G":11}},{"ref":"BLI26004","desc":"BLUSA CROPPED ALFAIATARIA MESCLA","cor":"MARFIM","prod":{"PP":10,"P":22,"M":23,"G":11},"envShow":{"PP":10,"P":22,"M":23,"G":11}},{"ref":"BLI26006","desc":"BLUSA TOP PEPLUM DETALHE DECOTE","cor":"MARFIM","prod":{"PP":9,"P":20,"M":20,"G":10},"envShow":{"PP":9,"P":20,"M":20,"G":10}},{"ref":"BLI26006","desc":"BLUSA TOP PEPLUM DETALHE DECOTE","cor":"PRETO","prod":{"PP":9,"P":18,"M":19,"G":9},"envShow":{"PP":9,"P":18,"M":19,"G":9}},{"ref":"BLI26010","desc":"BLUSA BASIC MANGA RENDA","cor":"MARROM","prod":{"PP":14,"P":26,"M":26,"G":15},"envShow":{"PP":14,"P":26,"M":26,"G":15}},{"ref":"BLI26011","desc":"BLUSA TOP PEPLUM JEANS PAETE","cor":"OFF-WHITE","prod":{"PP":10,"P":22,"M":22,"G":10},"envShow":{"PP":10,"P":22,"M":22,"G":10}},{"ref":"BLI26013","desc":"BLUSA BASIC REGATA ISA PAES","cor":"MARFIM","prod":{"PP":15,"P":31,"M":31,"G":15},"envShow":{"PP":15,"P":31,"M":31,"G":15}},{"ref":"BLI26013","desc":"BLUSA BASIC REGATA ISA PAES","cor":"MARROM","prod":{"PP":16,"P":31,"M":31,"G":16},"envShow":{"PP":16,"P":31,"M":31,"G":16}},{"ref":"BLI26013","desc":"BLUSA BASIC REGATA ISA PAES","cor":"PRETO","prod":{"PP":11,"P":25,"M":26,"G":11},"envShow":{"PP":11,"P":25,"M":26,"G":11}},{"ref":"BLI26019","desc":"BLUSA BASIC MANGA RENDA","cor":"VERMELHO ESCURO","prod":{"PP":8,"P":17,"M":18,"G":8},"envShow":{"PP":8,"P":17,"M":18,"G":8}},{"ref":"BLI26019","desc":"BLUSA BASIC MANGA RENDA","cor":"AREIA","prod":{"PP":9,"P":18,"M":19,"G":9},"envShow":{"PP":9,"P":18,"M":19,"G":9}},{"ref":"BLI26026","desc":"BLUSA BASIC CAVADA MARTINGALES","cor":"OFF-WHITE","prod":{"PP":8,"P":17,"M":18,"G":8},"envShow":{"PP":8,"P":17,"M":18,"G":8}},{"ref":"BLI26027","desc":"BLUSA REGATA BASIC ISA PAES","cor":"PRETO","prod":{"PP":0,"P":56,"M":58,"G":23},"envShow":{"PP":0,"P":56,"M":58,"G":23}},{"ref":"BLI26028","desc":"BLUSA TOP PAETE PEPLUM DETALHE DECOTE","cor":"MARROM","prod":{"PP":11,"P":17,"M":17,"G":10},"envShow":{"PP":11,"P":17,"M":17,"G":10}},{"ref":"BLI26029","desc":"BLUSA BASIC MANGA RENDA","cor":"MARFIM","prod":{"PP":10,"P":17,"M":16,"G":10},"envShow":{"PP":10,"P":17,"M":16,"G":10}},{"ref":"BZI26001","desc":"BLAZER ALFAIATARIA TELA BORDADA","cor":"MARROM","prod":{"PP":12,"P":23,"M":23,"G":12},"envShow":{"PP":12,"P":23,"M":23,"G":12}},{"ref":"BZI26002","desc":"BLAZER ALFAIATARIA VIES","cor":"AZUL CLARO","prod":{"PP":9,"P":17,"M":18,"G":11},"envShow":{"PP":9,"P":17,"M":18,"G":11}},{"ref":"BZI26002","desc":"BLAZER ALFAIATARIA VIES","cor":"MARFIM","prod":{"PP":15,"P":31,"M":32,"G":15},"envShow":{"PP":15,"P":31,"M":32,"G":15}},{"ref":"BZI26003","desc":"BLAZER ALFAIATARIA BASIC ISA PAES","cor":"MARFIM","prod":{"PP":17,"P":31,"M":30,"G":17},"envShow":{"PP":17,"P":31,"M":30,"G":17}},{"ref":"BZI26003","desc":"BLAZER ALFAIATARIA BASIC ISA PAES","cor":"MARROM","prod":{"PP":17,"P":30,"M":31,"G":17},"envShow":{"PP":17,"P":30,"M":31,"G":17}},{"ref":"BZI26003","desc":"BLAZER ALFAIATARIA BASIC ISA PAES","cor":"PRETO","prod":{"PP":16,"P":27,"M":29,"G":15},"envShow":{"PP":16,"P":27,"M":29,"G":15}},{"ref":"CAI26006","desc":"CAMISA ALFAIATARIA ESTAMPADA","cor":"MARFIM","prod":{"PP":13,"P":27,"M":27,"G":13},"envShow":{"PP":13,"P":27,"M":27,"G":13}},{"ref":"CAI26007","desc":"CAMISA ALFAIATARIA PAETE","cor":"MARROM","prod":{"PP":16,"P":21,"M":22,"G":17},"envShow":{"PP":16,"P":21,"M":22,"G":17}},{"ref":"CAI26009","desc":"CAMISA ALFAIATARIA COM PONTEIRA","cor":"MARROM","prod":{"PP":9,"P":13,"M":12,"G":9},"envShow":{"PP":9,"P":13,"M":12,"G":9}},{"ref":"CAI26009","desc":"CAMISA ALFAIATARIA COM PONTEIRA","cor":"PRETO","prod":{"PP":8,"P":15,"M":15,"G":9},"envShow":{"PP":8,"P":15,"M":15,"G":9}},{"ref":"CJI26002","desc":"CONJUNTO BASIC REGATA DETALHE CHANTILLY","cor":"OFF-WHITE","prod":{"PP":14,"P":24,"M":25,"G":14},"envShow":{"PP":14,"P":24,"M":25,"G":14}},{"ref":"CJI26002","desc":"CONJUNTO BASIC REGATA DETALHE CHANTILLY","cor":"AREIA","prod":{"PP":0,"P":22,"M":25,"G":13},"envShow":{"PP":0,"P":22,"M":25,"G":13}},{"ref":"CJI26013","desc":"CONJUNTO ALFAIATARIA BLUSA CAPA","cor":"MARROM","prod":{"PP":8,"P":13,"M":13,"G":9},"envShow":{"PP":8,"P":13,"M":13,"G":9}},{"ref":"CJI26013","desc":"CONJUNTO ALFAIATARIA BLUSA CAPA","cor":"PRETO","prod":{"PP":9,"P":12,"M":15,"G":9},"envShow":{"PP":9,"P":12,"M":15,"G":9}},{"ref":"CLI26001","desc":"CALCA ALFAIATARIA BARRA ITALIANA","cor":"MARROM","prod":{"PP":17,"P":30,"M":31,"G":16},"envShow":{"PP":17,"P":30,"M":31,"G":16}},{"ref":"CLI26001","desc":"CALCA ALFAIATARIA BARRA ITALIANA","cor":"CAMEL","prod":{"PP":17,"P":31,"M":30,"G":17},"envShow":{"PP":17,"P":31,"M":30,"G":17}},{"ref":"CLI26002","desc":"CALCA ALFAIATARIA TIRA LATERAL","cor":"AMARELO CLARO","prod":{"PP":13,"P":25,"M":29,"G":12},"envShow":{"PP":13,"P":25,"M":29,"G":12}},{"ref":"CLI26002","desc":"CALCA ALFAIATARIA TIRA LATERAL","cor":"ROSA CLARO","prod":{"PP":8,"P":18,"M":16,"G":9},"envShow":{"PP":8,"P":18,"M":16,"G":9}},{"ref":"CLI26003","desc":"CALCA ALFAIATARIA VIES","cor":"AZUL CLARO","prod":{"PP":10,"P":18,"M":18,"G":9},"envShow":{"PP":10,"P":18,"M":18,"G":9}},{"ref":"CLI26003","desc":"CALCA ALFAIATARIA VIES","cor":"MARFIM","prod":{"PP":8,"P":19,"M":19,"G":9},"envShow":{"PP":8,"P":19,"M":19,"G":9}},{"ref":"CLI26004","desc":"CALCA ALFAIATARIA NERVURA","cor":"MARROM","prod":{"PP":16,"P":31,"M":30,"G":17},"envShow":{"PP":16,"P":31,"M":30,"G":17}},{"ref":"CLI26005","desc":"CALCA ALFAIATARIA NERVURA","cor":"MARFIM","prod":{"PP":15,"P":32,"M":31,"G":15},"envShow":{"PP":15,"P":32,"M":31,"G":15}},{"ref":"CLI26005","desc":"CALCA ALFAIATARIA NERVURA","cor":"PRETO","prod":{"PP":15,"P":30,"M":31,"G":15},"envShow":{"PP":15,"P":30,"M":31,"G":15}},{"ref":"CLI26006","desc":"CALCA STREET ALFAIATARIA MESCLA","cor":"AZUL","prod":{"PP":6,"P":15,"M":14,"G":7},"envShow":{"PP":6,"P":15,"M":14,"G":7}},{"ref":"CLI26006","desc":"CALCA STREET ALFAIATARIA MESCLA","cor":"MARFIM","prod":{"PP":6,"P":19,"M":17,"G":7},"envShow":{"PP":6,"P":19,"M":17,"G":7}},{"ref":"CLI26008","desc":"CALCA JEANS PAETE","cor":"OFF-WHITE","prod":{"PP":11,"P":23,"M":22,"G":11},"envShow":{"PP":11,"P":23,"M":22,"G":11}},{"ref":"JAI26001","desc":"JAQUETA BOMBER DETALHE TRICOT","cor":"MARROM","prod":{"PP":11,"P":21,"M":21,"G":11},"envShow":{"PP":11,"P":21,"M":21,"G":11}},{"ref":"JAI26002","desc":"JAQUETA ALFAIATARIA MESCLA","cor":"AZUL","prod":{"PP":9,"P":20,"M":18,"G":9},"envShow":{"PP":9,"P":20,"M":18,"G":9}},{"ref":"JAI26002","desc":"JAQUETA ALFAIATARIA MESCLA","cor":"MARFIM","prod":{"PP":10,"P":20,"M":21,"G":10},"envShow":{"PP":10,"P":20,"M":21,"G":10}},{"ref":"JAI26003","desc":"JAQUETA JEANS PAETE","cor":"OFF-WHITE","prod":{"PP":11,"P":22,"M":22,"G":11},"envShow":{"PP":11,"P":22,"M":22,"G":11}},{"ref":"MCI26001","desc":"MACACAO LONGO ALFAIATARIA DUO COLOR","cor":"MARROM","prod":{"PP":15,"P":30,"M":32,"G":14},"envShow":{"PP":15,"P":30,"M":32,"G":14}},{"ref":"SAI26001","desc":"SAIA MIDI MEIO GODE","cor":"MARROM","prod":{"PP":12,"P":23,"M":23,"G":12},"envShow":{"PP":12,"P":23,"M":23,"G":12}},{"ref":"SAI26002","desc":"SAIA CURTA ALFAIATARIA VIES","cor":"AZUL CLARO","prod":{"PP":9,"P":18,"M":19,"G":9},"envShow":{"PP":9,"P":18,"M":19,"G":9}},{"ref":"SAI26002","desc":"SAIA CURTA ALFAIATARIA VIES","cor":"MARFIM","prod":{"PP":9,"P":21,"M":20,"G":9},"envShow":{"PP":9,"P":21,"M":20,"G":9}},{"ref":"SAI26003","desc":"SAIA MIDI PEPLUM","cor":"MARFIM","prod":{"PP":9,"P":20,"M":18,"G":9},"envShow":{"PP":9,"P":20,"M":18,"G":9}},{"ref":"SAI26003","desc":"SAIA MIDI PEPLUM","cor":"MARROM","prod":{"PP":14,"P":27,"M":28,"G":14},"envShow":{"PP":14,"P":27,"M":28,"G":14}},{"ref":"SAI26003","desc":"SAIA MIDI PEPLUM","cor":"PRETO","prod":{"PP":9,"P":19,"M":19,"G":9},"envShow":{"PP":9,"P":19,"M":19,"G":9}},{"ref":"SAI26004","desc":"SAIA CURTA ALFAIATARIA MESCLA","cor":"AZUL","prod":{"PP":9,"P":20,"M":19,"G":9},"envShow":{"PP":9,"P":20,"M":19,"G":9}},{"ref":"SAI26004","desc":"SAIA CURTA ALFAIATARIA MESCLA","cor":"MARFIM","prod":{"PP":9,"P":20,"M":21,"G":10},"envShow":{"PP":9,"P":20,"M":21,"G":10}},{"ref":"SAI26005","desc":"SAIA MIDI TULE PAETE","cor":"MARROM","prod":{"PP":11,"P":18,"M":18,"G":11},"envShow":{"PP":11,"P":18,"M":18,"G":11}},{"ref":"SAI26009","desc":"SAIA MIDI TRICOT TRANSPARENCIA","cor":"PRETO","prod":{"PP":19,"P":26,"M":47,"G":0},"envShow":{"PP":19,"P":26,"M":47,"G":0}},{"ref":"SHI26001","desc":"SHORT CURTO DETALHE PREGA","cor":"MARROM","prod":{"PP":13,"P":23,"M":23,"G":12},"envShow":{"PP":13,"P":23,"M":23,"G":12}},{"ref":"SHI26002","desc":"SHORT CURTO ALFAIATARIA BASIC","cor":"MARFIM","prod":{"PP":15,"P":32,"M":31,"G":15},"envShow":{"PP":15,"P":32,"M":31,"G":15}},{"ref":"SHI26002","desc":"SHORT CURTO ALFAIATARIA BASIC","cor":"MARROM","prod":{"PP":9,"P":18,"M":19,"G":9},"envShow":{"PP":9,"P":18,"M":19,"G":9}},{"ref":"SHI26002","desc":"SHORT CURTO ALFAIATARIA BASIC","cor":"PRETO","prod":{"PP":14,"P":30,"M":29,"G":16},"envShow":{"PP":14,"P":30,"M":29,"G":16}},{"ref":"VEI26001","desc":"VESTIDO LONGO SAIA CAMADAS","cor":"MARROM","prod":{"PP":9,"P":20,"M":20,"G":9},"envShow":{"PP":9,"P":20,"M":20,"G":9}},{"ref":"VEI26006","desc":"VESTIDO CURTO DETALHE SOBREPOSICAO","cor":"PRETO","prod":{"PP":13,"P":25,"M":26,"G":13},"envShow":{"PP":13,"P":25,"M":26,"G":13}},{"ref":"VEI26008","desc":"VESTIDO CURTO APLICACAO RENDA","cor":"AREIA","prod":{"PP":13,"P":26,"M":27,"G":13},"envShow":{"PP":13,"P":26,"M":27,"G":13}},{"ref":"VEI26009","desc":"VESTIDO LONGO BABADOS RENDA","cor":"AREIA","prod":{"PP":12,"P":24,"M":25,"G":13},"envShow":{"PP":12,"P":24,"M":25,"G":13}},{"ref":"VEI26010","desc":"VESTIDO LONGO DETALHE CUT-OUT","cor":"MARROM","prod":{"PP":11,"P":21,"M":21,"G":11},"envShow":{"PP":11,"P":21,"M":21,"G":11}},{"ref":"VEI26012","desc":"VESTIDO CURTO SAIA ASSIMETRICA","cor":"MARFIM","prod":{"PP":9,"P":10,"M":11,"G":9},"envShow":{"PP":9,"P":10,"M":11,"G":9}},{"ref":"VEI26012","desc":"VESTIDO CURTO SAIA ASSIMETRICA","cor":"MARROM","prod":{"PP":9,"P":13,"M":14,"G":9},"envShow":{"PP":9,"P":13,"M":14,"G":9}},{"ref":"VEI26022","desc":"VESTIDO LONGUETE CINTO FLORES","cor":"MARROM","prod":{"PP":17,"P":20,"M":40,"G":17},"envShow":{"PP":17,"P":20,"M":40,"G":17}},{"ref":"VEI26023","desc":"VESTIDO CURTO ESTAMPADO SAIA BABADOS","cor":"MARFIM","prod":{"PP":13,"P":27,"M":27,"G":13},"envShow":{"PP":13,"P":27,"M":27,"G":13}},{"ref":"VEI26025","desc":"VESTIDO LONGO ESTAMPADO PALA LASTEX","cor":"MARFIM","prod":{"PP":17,"P":34,"M":31,"G":18},"envShow":{"PP":17,"P":34,"M":31,"G":18}},{"ref":"VEI26045","desc":"VESTIDO CURTO MOULAGE","cor":"OFF-WHITE","prod":{"PP":4,"P":8,"M":12,"G":5},"envShow":{"PP":4,"P":8,"M":12,"G":5}}];

let currentExpDestino = null;
let ultimaAtualizacaoTimestamp = null; // Guarda quando os dados foram realmente atualizados

// Função simplificada para mostrar última atualização
function atualizarDataNaTela() {
    var updateEl = document.getElementById('exp-update-text');
    if (!updateEl) return;
    
    if (!ultimaAtualizacaoTimestamp) {
        updateEl.innerHTML = '🕐 Carregando...';
        return;
    }
    
    var dataStr = ultimaAtualizacaoTimestamp.toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
    updateEl.innerHTML = '🕐 Última atualização: ' + dataStr;
}

// =====================================================
// BUSCAR STATUS DAS CÁPSULAS DO CLOUDFLARE
// Cache gerenciado pelo Cloudflare (KV + HTTP Cache 5min)
// =====================================================

// Flag para controlar se já carregou
let expedicaoCarregada = false;

async function openExpedicao(){
    hideAll();
    document.getElementById('sub-expedicao').classList.add('active');
    pushState('sub-expedicao');
    
    // Se já carregou, não precisa buscar de novo
    if (expedicaoCarregada) return;
    
    // Buscar status das cápsulas do Cloudflare (já vem do cache KV)
    console.log('[API] Buscando status das cápsulas...');
    console.log('[API] URL:', `${API_CONFIG.baseUrl}/api/totvs/capsulas/status`);
    console.log('[API] Key:', API_CONFIG.apiKey ? 'presente' : 'AUSENTE');
    
    try {
        const response = await fetch(`${API_CONFIG.baseUrl}/api/totvs/capsulas/status`, {
            headers: { 'X-API-Key': API_CONFIG.apiKey || 'Isapaes@2026!X' },
            mode: 'cors'
        });
        
        console.log('[API] Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('[API] Dados recebidos:', data);
            
            if (data.fromCache) {
                console.log('[API] ✅ Dados do cache Cloudflare KV');
            }
            
            // Aplicar na UI
            for (const item of data.capsulas || []) {
                const key = `${item.colecao}-${item.capsula}`;
                capsulasStatus[key] = {
                    habilitada: item.habilitada,
                    enviado: item.enviado || 0,
                    produzido: item.produzido || 0
                };
                
                if (item.habilitada) {
                    habilitarBotaoCapsula(item.colecao, item.capsula);
                } else {
                    desabilitarBotaoCapsula(item.colecao, item.capsula, 'Em breve');
                }
            }
            
            expedicaoCarregada = true;
            console.log(`[API] ${data.capsulas?.length || 0} cápsulas carregadas`);
            
            // Calcular total de peças produzidas por coleção
            const totaisPorColecao = {};
            for (const item of data.capsulas || []) {
                if (!totaisPorColecao[item.colecao]) totaisPorColecao[item.colecao] = 0;
                totaisPorColecao[item.colecao] += item.produzido || 0;
            }
            for (const [col, total] of Object.entries(totaisPorColecao)) {
                const el = document.getElementById('total-produzido-' + col);
                if (el && total > 0) {
                    el.textContent = '📦 ' + total.toLocaleString('pt-BR') + ' peças produzidas';
                    el.classList.add('visible');
                }
            }
        } else {
            console.log('[API] Erro HTTP:', response.status, response.statusText);
        }
    } catch(e) {
        console.log('[API] Erro ao carregar cápsulas:', e.message || e);
        showExpedicaoToast('Erro ao conectar', 'error');
    }
}

function openExpedicaoEstacao(estacao){
    hideAll();
    if(estacao==='inverno'){
        document.getElementById('sub-expedicao-inverno').classList.add('active');
        pushState('sub-expedicao-inverno');
    }else if(estacao==='verao'){
        document.getElementById('sub-expedicao-verao').classList.add('active');
        pushState('sub-expedicao-verao');
    }
}
function backToExpedicao(){goBackTo('sub-expedicao')}

// =====================================================
// PULL TO REFRESH - Atualizar dados ao puxar para baixo
// =====================================================
let ptrStartY = 0;
let ptrCurrentY = 0;
let ptrRefreshing = false;
let ptrActive = false;

function initPullToRefresh() {
    const container = document.getElementById('exp-content');
    const indicator = document.getElementById('ptr-indicator');
    
    if (!container || !indicator) return;
    
    // Desabilitar pull-to-refresh nativo do navegador na tela de expedição
    document.body.style.overscrollBehavior = 'contain';
    
    container.addEventListener('touchstart', (e) => {
        if (container.scrollTop === 0 && !ptrRefreshing) {
            ptrStartY = e.touches[0].clientY;
            ptrActive = true;
        }
    }, { passive: true });
    
    container.addEventListener('touchmove', (e) => {
        if (ptrRefreshing || container.scrollTop > 0 || !ptrActive) return;
        
        ptrCurrentY = e.touches[0].clientY;
        const diff = ptrCurrentY - ptrStartY;
        
        if (diff > 0 && diff < 150) {
            // Prevenir scroll bounce e pull-to-refresh nativo
            if (diff > 10) {
                e.preventDefault();
            }
            indicator.classList.add('pulling');
            indicator.style.top = Math.min(diff - 40, 20) + 'px';
        }
    }, { passive: false }); // passive: false para poder usar preventDefault
    
    container.addEventListener('touchend', async () => {
        if (!ptrActive) return;
        
        const diff = ptrCurrentY - ptrStartY;
        
        if (diff > 80 && !ptrRefreshing && container.scrollTop === 0) {
            // Ativar refresh - mostrar splash com logo
            ptrRefreshing = true;
            indicator.classList.remove('pulling');
            indicator.style.top = '-50px';
            
            // Mostrar splash de refresh com logo e barra de progresso (com percentual)
            showSplashRefresh(true);
            
            // Forçar atualização
            await forcarAtualizacaoExpedicao();
            
            // Finalizar - esconder splash
            hideSplashRefresh();
            ptrRefreshing = false;
        } else {
            // Cancelar
            indicator.classList.remove('pulling');
            indicator.style.top = '-50px';
        }
        
        ptrStartY = 0;
        ptrCurrentY = 0;
        ptrActive = false;
    });
}

// Mostrar splash de refresh
// Histórico de tempos de carregamento para estimar
let refreshTimeHistory = [];
const DEFAULT_REFRESH_TIME = 3000; // 3 segundos padrão

function getEstimatedRefreshTime() {
    if (refreshTimeHistory.length === 0) return DEFAULT_REFRESH_TIME;
    const avg = refreshTimeHistory.reduce((a, b) => a + b, 0) / refreshTimeHistory.length;
    return Math.round(avg);
}

function showSplashRefresh(showPercent) {
    var splash = document.getElementById('splash-refresh');
    if (!splash) return;
    
    splash.classList.add('active');
    
    // Reset direto nos elementos
    document.getElementById('splash-refresh-bar').style.width = '0%';
    document.getElementById('splash-refresh-text').textContent = 'Atualizando...';
    
    var percentEl = document.getElementById('splash-refresh-percent');
    if (percentEl) {
        if (showPercent) {
            percentEl.style.display = 'block';
            percentEl.textContent = '0%';
        } else {
            percentEl.style.display = 'none';
        }
    }
    
    // Guardar configuração
    splash.setAttribute('data-start', Date.now());
    splash.setAttribute('data-estimate', getEstimatedRefreshTime());
    splash.setAttribute('data-show-percent', showPercent ? 'true' : 'false');
    
    // Parar animação anterior se existir
    if (window.splashAnimFrame) {
        cancelAnimationFrame(window.splashAnimFrame);
    }
    
    // Usar requestAnimationFrame para animação suave
    function animateProgress() {
        var splashEl = document.getElementById('splash-refresh');
        if (!splashEl || !splashEl.classList.contains('active')) return;
        
        var startTime = parseInt(splashEl.getAttribute('data-start')) || Date.now();
        var estimatedTime = parseInt(splashEl.getAttribute('data-estimate')) || 3000;
        var shouldShowPercent = splashEl.getAttribute('data-show-percent') === 'true';
        var elapsed = Date.now() - startTime;
        var progress = Math.min(Math.floor((elapsed / estimatedTime) * 85), 85);
        
        var barEl = document.getElementById('splash-refresh-bar');
        var pctEl = document.getElementById('splash-refresh-percent');
        
        if (barEl) barEl.style.width = progress + '%';
        if (pctEl && shouldShowPercent) pctEl.textContent = progress + '%';
        
        // Continuar animando enquanto não atingir 85%
        if (progress < 85) {
            window.splashAnimFrame = requestAnimationFrame(animateProgress);
        }
    }
    
    // Iniciar animação
    window.splashAnimFrame = requestAnimationFrame(animateProgress);
}

function updateSplashRefreshStage(stage) {
    var text = document.getElementById('splash-refresh-text');
    
    var stages = {
        'connecting': '🔌 Conectando...',
        'fetching': '📡 Buscando dados...',
        'processing': '⚙️ Processando...',
        'rendering': '🎨 Atualizando...',
        'done': '✅ Concluído!'
    };
    
    if (stages[stage] && text) {
        text.textContent = stages[stage];
    }
}

// Esconder splash de refresh
function hideSplashRefresh() {
    // Parar animação
    if (window.splashAnimFrame) {
        cancelAnimationFrame(window.splashAnimFrame);
        window.splashAnimFrame = null;
    }
    
    var splash = document.getElementById('splash-refresh');
    var shouldShowPercent = splash && splash.getAttribute('data-show-percent') === 'true';
    
    // Salvar tempo real para melhorar estimativa futura
    if (splash) {
        var startTime = parseInt(splash.getAttribute('data-start'));
        if (startTime) {
            var elapsed = Date.now() - startTime;
            refreshTimeHistory.push(elapsed);
            if (refreshTimeHistory.length > 5) refreshTimeHistory.shift();
        }
    }
    
    // Completar para 100%
    document.getElementById('splash-refresh-bar').style.width = '100%';
    document.getElementById('splash-refresh-text').textContent = '✅ Concluído!';
    
    var percentEl = document.getElementById('splash-refresh-percent');
    if (percentEl && shouldShowPercent) {
        percentEl.textContent = '100%';
    }
    
    // Esconder após 500ms
    setTimeout(function() {
        var splashEl = document.getElementById('splash-refresh');
        if (splashEl) splashEl.classList.remove('active');
    }, 500);
}

// Forçar atualização (sem cache local)
async function forcarAtualizacaoExpedicao() {
    const destino = currentExpDestino;
    if (!destino) {
        console.log('[Refresh] Sem destino definido');
        return;
    }
    
    // Recarregar fotos do Drive também
    reloadPhotos();
    
    console.log('[Refresh] Iniciando atualização forçada para:', destino);
    
    try {
        updateSplashRefreshStage('connecting');
        
        // Buscar novos dados da API (com ?refresh=true para forçar no Cloudflare)
        const colecao = capsulaAtual.colecao || 'I26';
        const capsula = capsulaAtual.num || 1;
        const endpoints = {
            'showroom': `/api/totvs/expedicao/showroom-liquido?colecao=${colecao}&capsula=${capsula}&refresh=true`,
            'ecommerce': `/api/totvs/expedicao/ecommerce?colecao=${colecao}&capsula=${capsula}&refresh=true`,
            'mostruario': `/api/totvs/expedicao/mostruario?colecao=${colecao}&capsula=${capsula}&refresh=true`,
            'ld': `/api/totvs/expedicao/ld?colecao=${colecao}&capsula=${capsula}&refresh=true`
        };
        
        updateSplashRefreshStage('fetching');
        const url = `${API_CONFIG.baseUrl}${endpoints[destino]}`;
        console.log('[Refresh] URL:', url);
        
        const response = await fetch(url, { 
            headers: { 'X-API-Key': API_CONFIG.apiKey },
            mode: 'cors'
        });
        
        console.log('[Refresh] Response status:', response.status);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        updateSplashRefreshStage('processing');
        const apiData = await response.json();
        console.log('[Refresh] Dados recebidos:', apiData ? 'OK' : 'VAZIO');
        
        const novosItens = transformApiData(apiData);
        console.log('[Refresh] Itens transformados:', novosItens.items?.length || 0);
        
        updateSplashRefreshStage('rendering');
        // Atualizar UI
        await renderExpedicao(destino, novosItens);
        
        updateSplashRefreshStage('done');
        mostrarPtrToast('✅ Atualizado!');
        
    } catch (error) {
        console.error('[PTR] Erro:', error);
        mostrarPtrToast('❌ Erro ao atualizar', 'warning');
    }
}

// =====================================================
// PULL-TO-REFRESH GLOBAL - Funciona em todas as telas
// Mostra splash e limpa todos os caches
// =====================================================
let globalPtrStartY = 0;
let globalPtrActive = false;
let globalPtrRefreshing = false;

function initGlobalPullToRefresh() {
    document.body.addEventListener('touchstart', (e) => {
        // Verifica se o toque está dentro de um container com scroll
        const target = e.target;
        const scrollableParent = target.closest('#exp-content, .modal-body, .scroll-container');
        
        // Se está dentro de um container scrollável que não está no topo, não ativa
        if (scrollableParent && scrollableParent.scrollTop > 0) {
            globalPtrActive = false;
            return;
        }
        
        // Só ativa se estiver no topo da página
        if (window.scrollY === 0 && !globalPtrRefreshing) {
            globalPtrStartY = e.touches[0].clientY;
            globalPtrActive = true;
        }
    }, { passive: true });
    
    document.body.addEventListener('touchmove', (e) => {
        if (!globalPtrActive || globalPtrRefreshing || window.scrollY > 0) return;
        
        // Verifica novamente se está dentro de um scroll
        const target = e.target;
        const scrollableParent = target.closest('#exp-content, .modal-body, .scroll-container');
        if (scrollableParent && scrollableParent.scrollTop > 0) {
            globalPtrActive = false;
            return;
        }
        
        const currentY = e.touches[0].clientY;
        const diff = currentY - globalPtrStartY;
        
        // Se puxou mais de 150px para baixo
        if (diff > 150) {
            e.preventDefault();
        }
    }, { passive: false });
    
    document.body.addEventListener('touchend', async (e) => {
        if (!globalPtrActive || globalPtrRefreshing) return;
        
        const endY = e.changedTouches[0].clientY;
        const diff = endY - globalPtrStartY;
        
        // Aumentado threshold de 120px para 180px
        if (diff > 180 && window.scrollY === 0) {
            await executarRefreshGlobal();
        }
        
        globalPtrStartY = 0;
        globalPtrActive = false;
    });
}

async function executarRefreshGlobal() {
    globalPtrRefreshing = true;
    
    const splash = document.getElementById('splash-refresh');
    const splashText = document.getElementById('splash-refresh-text');
    const splashBar = document.getElementById('splash-refresh-bar');
    const splashPercent = document.getElementById('splash-refresh-percent');
    
    splash.classList.add('active');
    splashBar.style.width = '0%';
    
    // Esconder percentual no refresh global (fora da cápsula mostra, dentro não)
    if (splashPercent) splashPercent.style.display = 'none';
    
    // Animação contínua da barra de progresso
    let progressoAtual = 0;
    let progressoAlvo = 10;
    const intervaloProgresso = setInterval(() => {
        if (progressoAtual < progressoAlvo) {
            progressoAtual += 0.5;
            splashBar.style.width = progressoAtual + '%';
        }
    }, 100);
    
    // Função para atualizar o alvo do progresso
    const setProgresso = (valor) => {
        progressoAlvo = Math.min(valor, 95); // Nunca passa de 95% até completar
    };
    
    // Verificar se está dentro de uma cápsula (tela app-expedicao ativa)
    const telaExpedicao = document.getElementById('app-expedicao');
    const dentroCapsula = telaExpedicao && telaExpedicao.classList.contains('active') && currentExpDestino;
    
    if (dentroCapsula) {
        // ========================================
        // DENTRO DA CÁPSULA: Atualiza só ela
        // ========================================
        splashText.textContent = 'Atualizando cápsula...';
        setProgresso(20);
        
        await new Promise(r => setTimeout(r, 200));
        
        setProgresso(40);
        splashText.textContent = 'Conectando ao TOTVS...';
        
        await new Promise(r => setTimeout(r, 200));
        
        try {
            // Buscar dados atualizados da API (com refresh=true para forçar no Cloudflare)
            setProgresso(60);
            splashText.textContent = 'Buscando dados...';
            
            const colecao = capsulaAtual.colecao || 'I26';
            const cap = capsulaAtual.num || 1;
            const endpoints = {
                'showroom': `/api/totvs/expedicao/showroom-liquido?colecao=${colecao}&capsula=${cap}&refresh=true`,
                'ecommerce': `/api/totvs/expedicao/ecommerce?colecao=${colecao}&capsula=${cap}&refresh=true`,
                'mostruario': `/api/totvs/expedicao/mostruario?colecao=${colecao}&capsula=${cap}&refresh=true`,
                'ld': `/api/totvs/expedicao/ld?colecao=${colecao}&capsula=${cap}&refresh=true`
            };
            
            const url = `${API_CONFIG.baseUrl}${endpoints[currentExpDestino]}`;
            const response = await fetch(url, { headers: { 'X-API-Key': API_CONFIG.apiKey } });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const apiData = await response.json();
            const novosItens = transformApiData(apiData);
            
            // Guardar timestamp real da atualização
            ultimaAtualizacaoTimestamp = new Date();
            
            setProgresso(85);
            splashText.textContent = 'Atualizando tela...';
            
            // Atualizar a tela
            await renderExpedicao(currentExpDestino, novosItens);
            
            clearInterval(intervaloProgresso);
            splashBar.style.width = '100%';
            splashText.textContent = 'Pronto!';
            
        } catch(e) {
            console.log('[Refresh] Erro:', e);
            clearInterval(intervaloProgresso);
            splashBar.style.width = '100%';
            splashText.textContent = 'Erro ao atualizar';
        }
        
        await new Promise(r => setTimeout(r, 300));
        
        // Esconder splash
        splash.classList.remove('active');
        globalPtrRefreshing = false;
        
        mostrarPtrToast('✅ Atualizado!');
        
    } else {
        // ========================================
        // OUTRAS TELAS: Forçar refresh no Cloudflare
        // ========================================
        
        // Se não está logado, apenas recarregar a página
        const loggedUser = sessionStorage.getItem('logged-user');
        if (!loggedUser) {
            splashText.textContent = 'Recarregando...';
            clearInterval(intervaloProgresso);
            splashBar.style.width = '100%';
            await new Promise(r => setTimeout(r, 500));
            location.reload();
            return;
        }
        
        splashText.textContent = 'Atualizando...';
        setProgresso(50);
        
        await new Promise(r => setTimeout(r, 300));
        
        // Forçar refresh no Cloudflare (com timeout de 5s)
        try {
            setProgresso(70);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            await fetch(`${API_CONFIG.baseUrl}/api/totvs/capsulas/status?refresh=true`, {
                headers: { 'X-API-Key': API_CONFIG.apiKey || 'Isapaes@2026!X' },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
        } catch(e) {
            console.log('[Refresh] Timeout ou erro:', e);
        }
        
        // Resetar flag para recarregar na próxima abertura
        expedicaoCarregada = false;
        capsulasStatus = {};
        
        // Resetar botões das cápsulas visualmente
        const colecoes = Object.keys(COLECOES_CONFIG);
        for (const colecao of colecoes) {
            const config = COLECOES_CONFIG[colecao];
            for (const capsula of config.capsulas) {
                desabilitarBotaoCapsula(colecao, capsula, 'Verificando...');
            }
        }
        
        clearInterval(intervaloProgresso);
        splashBar.style.width = '100%';
        splashText.textContent = 'Pronto!';
        
        await new Promise(r => setTimeout(r, 300));
        
        // Esconder splash
        splash.classList.remove('active');
        globalPtrRefreshing = false;
        
        mostrarPtrToast('✅ Atualizado!');
    }
}

// Inicializar quando DOM carregar
document.addEventListener('DOMContentLoaded', () => {
    initGlobalPullToRefresh();
});

// Atualizar apenas a data de atualização na tela
function atualizarDataNaTela() {
    // Usa a função atualizarDataNaTela
    atualizarDataNaTela();
}

// Mostrar toast de feedback
function mostrarPtrToast(mensagem, tipo = '') {
    const toast = document.getElementById('ptr-toast');
    if (!toast) return;
    
    toast.textContent = mensagem;
    toast.className = 'ptr-toast show' + (tipo ? ' ' + tipo : '');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}

// Flag para saber se já inicializou o PTR
let ptrInitialized = false;

// ==========================================
// CONFIGURAÇÃO DE COLEÇÕES E CÁPSULAS
// Baseado no calendário: Ano 2026
// Inverno 2026 = I26, Verão 2027 = V27
// Ano 2027: Inverno 2027 = I27, Verão 2028 = V28
// ==========================================

const COLECOES_CONFIG = {
    'I26': { 
        nome: 'Inverno', 
        estacao: 'inverno',
        ano: 2026,
        capsulas: [1, 2, 3, 4, 5]
    },
    'V27': { 
        nome: 'Verão', 
        estacao: 'verao',
        ano: 2027,
        capsulas: [1, 2, 3, 4, 5]
    }
};

// Estado das cápsulas (habilitadas/desabilitadas)
let capsulasStatus = {};

// Cápsula atualmente selecionada
let capsulaAtual = { colecao: 'I26', num: 1 };

// Verificar se uma cápsula tem envios via API
async function verificarCapsulaAPI(colecao, capsula) {
    try {
        const url = `${API_CONFIG.baseUrl}/api/totvs/expedicao/showroom-liquido?colecao=${colecao}&capsula=${capsula}`;
        const response = await fetch(url, {
            headers: { 'X-API-Key': API_CONFIG.apiKey }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const enviado = data.totais?.enviado || 0;
        return { habilitada: enviado > 0, enviado, erro: false };
    } catch (e) {
        console.log(`[API] Erro verificar ${colecao}-${capsula}:`, e);
        return { habilitada: false, enviado: 0, produzido: 0, erro: true };
    }
}

// Habilitar botão de cápsula
function habilitarBotaoCapsula(colecao, capsula) {
    const btn = document.getElementById(`btn-${colecao}-${capsula}`);
    const status = document.getElementById(`status-${colecao}-${capsula}`);
    
    if (btn && status) {
        btn.classList.remove('disabled');
        status.remove();
        
        // Adicionar seta
        const arrow = document.createElement('div');
        arrow.className = 'sub-arrow';
        arrow.textContent = '›';
        btn.appendChild(arrow);
    }
}

// Desabilitar botão de cápsula
function desabilitarBotaoCapsula(colecao, capsula, texto = 'Em breve') {
    const status = document.getElementById(`status-${colecao}-${capsula}`);
    if (status) {
        status.textContent = texto;
    }
}

// Função verificarTodasCapsulas movida para verificarTodasCapsulasComLoading acima

// Mostrar aviso geral de API indisponível
function mostrarAvisoAPIIndisponivel() {
    // Adicionar aviso nas telas de cápsulas
    const telaInverno = document.getElementById('sub-expedicao-inverno');
    const telaVerao = document.getElementById('sub-expedicao-verao');
    
    const avisoHtml = `
        <div class="api-warning" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px 16px;border-radius:8px;margin:0 20px 16px;text-align:center;font-size:13px;">
            ⚠️ API temporariamente indisponível. Verifique sua conexão.
        </div>
    `;
    
    [telaInverno, telaVerao].forEach(tela => {
        if (tela && !tela.querySelector('.api-warning')) {
            const grid = tela.querySelector('.submenu-grid');
            if (grid) {
                grid.insertAdjacentHTML('beforebegin', avisoHtml);
            }
        }
    });
}

// Abrir cápsula específica
function openExpedicaoCapsula(colecao, num) {
    const key = `${colecao}-${num}`;
    const status = capsulasStatus[key];
    
    if (!status?.habilitada) {
        showExpedicaoToast('Aguardando início dos envios', 'warning');
        return;
    }
    
    capsulaAtual = { colecao, num };
    
    // Atualizar título do submenu de destinos
    const config = COLECOES_CONFIG[colecao];
    const titulo = `${num}ª Cápsula ${config.nome}`;
    
    document.getElementById('destinos-title').textContent = titulo;
    document.getElementById('destinos-update').textContent = `📦 ${status.produzido?.toLocaleString('pt-BR') || 0} peças produzidas`;
    
    // Configurar botão de voltar baseado na estação
    const backBtn = document.getElementById('destinos-back-btn');
    if (config.estacao === 'inverno') {
        backBtn.onclick = () => goBackTo('sub-expedicao-inverno');
    } else {
        backBtn.onclick = () => goBackTo('sub-expedicao-verao');
    }
    
    // PREFETCH: iniciar busca do showroom em background enquanto usuário vê a tela de destinos
    prefetchExpedicaoData(colecao, num);
    
    hideAll();
    document.getElementById('sub-expedicao-destinos').classList.add('active');
    pushState('sub-expedicao-destinos');
}

// Prefetch: buscar dados dos destinos em background para carregar instantâneo
let prefetchPromises = {};
let backgroundPreloadStarted = false;

function prefetchExpedicaoData(colecao, num) {
    const destinos = ['showroom', 'ecommerce', 'mostruario'];
    prefetchPromises = {};
    
    destinos.forEach(destino => {
        const cacheKey = colecao + '-' + num + '-' + destino;
        const { data: cached, isStale } = getLocalCache(cacheKey);
        
        // Se não tem cache ou está stale, buscar em background
        if (!cached || isStale) {
            console.log('[Prefetch] Iniciando:', destino);
            const endpoint = {
                'showroom': '/api/totvs/expedicao/showroom-liquido',
                'ecommerce': '/api/totvs/expedicao/ecommerce',
                'mostruario': '/api/totvs/expedicao/mostruario'
            }[destino];
            
            const url = `${API_CONFIG.baseUrl}${endpoint}?colecao=${colecao}&capsula=${num}`;
            prefetchPromises[destino] = fetch(url, {
                headers: { 'X-API-Key': API_CONFIG.apiKey }
            }).then(r => r.ok ? r.json() : null).then(data => {
                if (data && data.items && data.items.length > 0) {
                    setLocalCache(cacheKey, data);
                    console.log('[Prefetch] Salvo:', destino, data.items.length, 'items');
                }
                return data;
            }).catch(e => {
                console.log('[Prefetch] Erro:', destino, e.message);
                return null;
            });
        } else {
            console.log('[Prefetch] Cache fresh:', destino);
            prefetchPromises[destino] = Promise.resolve(cached);
        }
    });
    
    // Iniciar preload de todas as outras cápsulas em background
    if (!backgroundPreloadStarted) {
        backgroundPreloadStarted = true;
        setTimeout(() => preloadAllCapsulas(colecao, num), 2000);
    }
}

// Pré-carregar todas as cápsulas habilitadas em background (sequencial para não sobrecarregar)
async function preloadAllCapsulas(currentColecao, currentNum) {
    const destinos = ['showroom'];
    const toPreload = [];
    
    // Coletar todas as cápsulas habilitadas exceto a atual
    for (const [key, status] of Object.entries(capsulasStatus)) {
        if (!status.habilitada) continue;
        const [colecao, num] = key.split('-');
        if (colecao === currentColecao && num === String(currentNum)) continue;
        toPreload.push({ colecao, num });
    }
    
    if (toPreload.length === 0) {
        console.log('[Preload] Nenhuma cápsula adicional para carregar');
        return;
    }
    
    console.log('[Preload] Carregando', toPreload.length, 'cápsulas em background...');
    
    for (const cap of toPreload) {
        for (const destino of destinos) {
            const cacheKey = cap.colecao + '-' + cap.num + '-' + destino;
            const { data: cached, isStale } = getLocalCache(cacheKey);
            
            if (cached && !isStale) {
                console.log('[Preload] Cache fresh:', cap.colecao, cap.num, destino);
                continue;
            }
            
            try {
                const endpoint = {
                    'showroom': '/api/totvs/expedicao/showroom-liquido',
                    'ecommerce': '/api/totvs/expedicao/ecommerce',
                    'mostruario': '/api/totvs/expedicao/mostruario'
                }[destino];
                
                const url = `${API_CONFIG.baseUrl}${endpoint}?colecao=${cap.colecao}&capsula=${cap.num}`;
                const response = await fetch(url, {
                    headers: { 'X-API-Key': API_CONFIG.apiKey }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.items && data.items.length > 0) {
                        setLocalCache(cacheKey, data);
                        console.log('[Preload] Salvo:', cap.colecao, cap.num, destino, data.items.length, 'items');
                    }
                }
                
                // Pausa entre requests para não sobrecarregar
                await new Promise(r => setTimeout(r, 1500));
            } catch (e) {
                console.log('[Preload] Erro:', cap.colecao, cap.num, destino, e.message);
            }
        }
    }
    
    console.log('[Preload] Concluído!');
}

function backToExpedicaoEstacao() {
    const config = COLECOES_CONFIG[capsulaAtual.colecao];
    if (config?.estacao === 'inverno') {
        goBackTo('sub-expedicao-inverno');
    } else {
        goBackTo('sub-expedicao-verao');
    }
}

function backToExpedicaoDestinos(){ goBackTo('sub-expedicao-destinos')}

// Data selecionada para o resumo (padrão: hoje)
let resumoDiaDataSelecionada = new Date();

function openResumoEnviosDia(){
    hideAll();
    document.getElementById('resumo-dia-screen').classList.add('active');
    pushState('resumo-dia-screen');
    
    // Resetar para hoje
    resumoDiaDataSelecionada = new Date();
    
    // Atualizar título com cápsula atual
    const capInfo = window.currentCapsulaInfo;
    if (capInfo) {
        document.getElementById('resumo-dia-title').textContent = `Resumo - ${capInfo.nome}`;
    }
    
    atualizarDisplayData();
    carregarEnviosDoDia();
}

function atualizarDisplayData() {
    const dataFormatada = resumoDiaDataSelecionada.toLocaleDateString('pt-BR', { 
        weekday: 'short', 
        day: '2-digit', 
        month: 'short',
        year: 'numeric'
    });
    document.getElementById('resumo-dia-data').textContent = dataFormatada.charAt(0).toUpperCase() + dataFormatada.slice(1);
    
    // Atualizar o input date para o calendário
    const ano = resumoDiaDataSelecionada.getFullYear();
    const mes = String(resumoDiaDataSelecionada.getMonth() + 1).padStart(2, '0');
    const dia = String(resumoDiaDataSelecionada.getDate()).padStart(2, '0');
    document.getElementById('resumo-dia-calendar').value = `${ano}-${mes}-${dia}`;
}

function resumoDiaAnterior() {
    resumoDiaDataSelecionada.setDate(resumoDiaDataSelecionada.getDate() - 1);
    atualizarDisplayData();
    carregarEnviosDoDia();
}

function resumoDiaProximo() {
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const selecionada = new Date(resumoDiaDataSelecionada);
    selecionada.setHours(0,0,0,0);
    
    // Não permitir ir além de hoje
    if (selecionada >= hoje) return;
    
    resumoDiaDataSelecionada.setDate(resumoDiaDataSelecionada.getDate() + 1);
    atualizarDisplayData();
    carregarEnviosDoDia();
}

function abrirCalendarioResumo() {
    const calendar = document.getElementById('resumo-dia-calendar');
    calendar.showPicker();
}

function selecionarDataResumo(valor) {
    if (!valor) return;
    const [ano, mes, dia] = valor.split('-').map(Number);
    resumoDiaDataSelecionada = new Date(ano, mes - 1, dia);
    atualizarDisplayData();
    carregarEnviosDoDia();
}

async function carregarEnviosDoDia() {
    const contentEl = document.getElementById('resumo-dia-content');
    contentEl.innerHTML = '<div class="resumo-dia-loading">Carregando dados...</div>';
    
    try {
        const colecao = capsulaAtual.colecao || 'I26';
        const capsula = capsulaAtual.num || 1;
        
        // Formatar data para API (YYYY-MM-DD)
        const ano = resumoDiaDataSelecionada.getFullYear();
        const mes = String(resumoDiaDataSelecionada.getMonth() + 1).padStart(2, '0');
        const dia = String(resumoDiaDataSelecionada.getDate()).padStart(2, '0');
        const dataStr = `${ano}-${mes}-${dia}`;
        
        const url = `${API_CONFIG.baseUrl}/api/totvs/envios-dia?colecao=${colecao}&capsula=${capsula}&data=${dataStr}`;
        
        const response = await fetch(url, {
            headers: { 'X-API-Key': API_CONFIG.apiKey }
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        renderResumoEnviosDia(data);
    } catch (e) {
        console.error('[ResumoEnvios] Erro:', e);
        contentEl.innerHTML = `
            <div class="resumo-dia-loading">
                <div style="font-size:48px;margin-bottom:16px">⚠️</div>
                <div>Erro ao carregar dados</div>
                <div style="font-size:12px;margin-top:8px;color:var(--txt2)">${e.message}</div>
            </div>
        `;
    }
}

function renderResumoEnviosDia(enviosDoDia = null){
    const contentEl = document.getElementById('resumo-dia-content');
    
    // Se não passou dados, usar os dados globais (compatibilidade)
    if (!enviosDoDia) {
        enviosDoDia = window.currentEnviosDoDia;
    }
    
    // Guardar dados para uso posterior
    window.currentResumoEnvios = enviosDoDia;
    
    if (!enviosDoDia) {
        contentEl.innerHTML = `
            <div class="resumo-dia-loading">
                <div style="font-size:48px;margin-bottom:16px">📊</div>
                <div>Dados não disponíveis</div>
                <div style="font-size:12px;margin-top:8px;color:var(--txt2)">Selecione uma data para ver os envios</div>
            </div>
        `;
        return;
    }
    
    const showroom = enviosDoDia.showroom || 0;
    const ecommerce = enviosDoDia.ecommerce || 0;
    const mostruario = enviosDoDia.mostruario || 0;
    const ld = enviosDoDia.ld || 0;
    const total = showroom + ecommerce + mostruario + ld;
    
    // Verificar se é hoje
    const hoje = new Date();
    const isHoje = resumoDiaDataSelecionada.toDateString() === hoje.toDateString();
    const labelTotal = isHoje ? 'Total Enviado Hoje' : 'Total Enviado';
    const devolucoes = enviosDoDia.devolucoes || 0;
    
    // Verificar se tem detalhes disponíveis
    const temDetalhes = enviosDoDia.detalhes && Object.keys(enviosDoDia.detalhes).length > 0;
    const btnClass = temDetalhes ? 'resumo-dia-total clickable' : 'resumo-dia-total';
    const onClick = temDetalhes ? 'onclick="mostrarDetalhesEnvios()"' : '';
    const hint = temDetalhes ? '<div class="resumo-dia-total-hint">Toque para ver detalhes</div>' : '';
    
    contentEl.innerHTML = `
        <div class="${btnClass}" ${onClick}>
            <div class="resumo-dia-total-label">${labelTotal}</div>
            <div class="resumo-dia-total-valor">${total.toLocaleString('pt-BR')}</div>
            <div class="resumo-dia-total-unidade">peças</div>
            ${hint}
        </div>
        <div class="resumo-dia-canais">
            <div class="resumo-dia-canal" onclick="mostrarDetalhesCanal('showroom')">
                <div class="resumo-dia-canal-icon">🏬</div>
                <div class="resumo-dia-canal-info">
                    <div class="resumo-dia-canal-nome">Showroom</div>
                    <div class="resumo-dia-canal-desc">Envios para loja física</div>
                </div>
                <div class="resumo-dia-canal-valor">${showroom.toLocaleString('pt-BR')}</div>
            </div>
            <div class="resumo-dia-canal" onclick="mostrarDetalhesCanal('ecommerce')">
                <div class="resumo-dia-canal-icon">🌐</div>
                <div class="resumo-dia-canal-info">
                    <div class="resumo-dia-canal-nome">E-commerce</div>
                    <div class="resumo-dia-canal-desc">Envios para loja online</div>
                </div>
                <div class="resumo-dia-canal-valor">${ecommerce.toLocaleString('pt-BR')}</div>
            </div>
            <div class="resumo-dia-canal" onclick="mostrarDetalhesCanal('mostruario')">
                <div class="resumo-dia-canal-icon">👗</div>
                <div class="resumo-dia-canal-info">
                    <div class="resumo-dia-canal-nome">Mostruário Isabella</div>
                    <div class="resumo-dia-canal-desc">Peças de mostruário</div>
                </div>
                <div class="resumo-dia-canal-valor">${mostruario.toLocaleString('pt-BR')}</div>
            </div>
            <div class="resumo-dia-canal" onclick="mostrarDetalhesCanal('ld')">
                <div class="resumo-dia-canal-icon">📋</div>
                <div class="resumo-dia-canal-info">
                    <div class="resumo-dia-canal-nome">Leves Defeitos</div>
                    <div class="resumo-dia-canal-desc">Peças com pequenos defeitos</div>
                </div>
                <div class="resumo-dia-canal-valor">${ld.toLocaleString('pt-BR')}</div>
            </div>
            <div class="resumo-dia-canal devolucao" onclick="mostrarDetalhesCanal('devolucoes')">
                <div class="resumo-dia-canal-icon">↩️</div>
                <div class="resumo-dia-canal-info">
                    <div class="resumo-dia-canal-nome">Devoluções</div>
                    <div class="resumo-dia-canal-desc">Peças devolvidas hoje</div>
                </div>
                <div class="resumo-dia-canal-valor">${devolucoes.toLocaleString('pt-BR')}</div>
            </div>
        </div>
    `;
}

// Mostrar detalhes de todos os envios
function mostrarDetalhesEnvios() {
    mostrarDetalhesCanal('todos');
}

// Mostrar detalhes de um canal específico
function mostrarDetalhesCanal(canal) {
    const envios = window.currentResumoEnvios;
    if (!envios || !envios.detalhes) {
        alert('Detalhes não disponíveis. Tente novamente.');
        return;
    }
    
    let items = [];
    const icons = { showroom: '🏬', ecommerce: '🌐', mostruario: '👗', ld: '📋', devolucoes: '↩️' };
    const nomes = { showroom: 'Showroom', ecommerce: 'E-commerce', mostruario: 'Mostruário Isabella', ld: 'Leves Defeitos', devolucoes: 'Devoluções' };
    
    if (canal === 'todos') {
        // Combinar todos os canais
        for (const [c, itens] of Object.entries(envios.detalhes)) {
            for (const item of itens) {
                items.push({ ...item, canal: c, icon: icons[c] });
            }
        }
    } else {
        items = (envios.detalhes[canal] || []).map(item => ({ ...item, canal, icon: icons[canal] }));
    }
    
    if (items.length === 0) {
        alert('Nenhum envio encontrado para este canal.');
        return;
    }
    
    // Agrupar por referência
    const porRef = {};
    for (const item of items) {
        const key = `${item.ref}-${item.cor}`;
        if (!porRef[key]) {
            porRef[key] = { ref: item.ref, cor: item.cor, desc: item.desc, icon: item.icon, canal: item.canal, tamanhos: {}, total: 0 };
        }
        porRef[key].tamanhos[item.tamanho] = (porRef[key].tamanhos[item.tamanho] || 0) + item.qtd;
        porRef[key].total += item.qtd;
    }
    
    // Ordenar por referência
    const refsList = Object.values(porRef).sort((a, b) => a.ref.localeCompare(b.ref));
    
    // Criar modal de detalhes
    const dataFormatada = resumoDiaDataSelecionada.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const titulo = canal === 'todos' ? `Todos os Envios - ${dataFormatada}` : `${nomes[canal]} - ${dataFormatada}`;
    
    let html = `
        <div class="envios-detalhes-modal" id="envios-detalhes-modal">
            <div class="envios-detalhes-content">
                <div class="envios-detalhes-header">
                    <span class="envios-detalhes-title">${titulo}</span>
                    <button class="envios-detalhes-close" onclick="fecharDetalhesEnvios()">✕</button>
                </div>
                <div class="envios-detalhes-summary">
                    <span>${refsList.length} referências</span>
                    <span>${items.reduce((s, i) => s + i.qtd, 0)} peças</span>
                </div>
                <div class="envios-detalhes-list">
    `;
    
    for (const ref of refsList) {
        const tamanhosHtml = ['PP', 'P', 'M', 'G', 'GG'].filter(t => ref.tamanhos[t]).map(t => 
            `<span class="envio-tam">${t}: ${ref.tamanhos[t]}</span>`
        ).join('');
        
        const descEsc1 = (ref.desc || '').replace(/'/g, "\\'");
        html += `
            <div class="envio-item" onclick="openPhoto('${ref.ref}','${descEsc1}')" style="cursor:pointer">
                <div class="envio-item-header">
                    <div class="envio-item-ref">${ref.icon} ${ref.ref}</div>
                    <div class="envio-item-total">${ref.total} pç</div>
                </div>
                <div class="envio-item-desc">${ref.desc || ''}</div>
                <div class="envio-item-cor">🎨 ${ref.cor}</div>
                <div class="envio-item-tamanhos">${tamanhosHtml}</div>
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const existente = document.getElementById('envios-detalhes-modal');
    if (existente) existente.remove();
    
    // Adicionar ao body
    document.body.insertAdjacentHTML('beforeend', html);
    history.pushState({enviosModal: true}, '', '');
}

function fecharDetalhesEnvios(fromPopstate) {
    const modal = document.getElementById('envios-detalhes-modal');
    if (modal) modal.remove();
    if (!fromPopstate) {
        // Substituir o pushState sem navegar (não dispara popstate)
        history.replaceState({screen: navHistory[navHistory.length - 1]}, '', '');
    }
}

// Ver detalhes de envios de um canal específico (chamado da tela de expedição)
async function verDetalhesEnviosCanal(canal) {
    const nomes = { showroom: 'Showroom', ecommerce: 'E-commerce', mostruario: 'Mostruário Isabella', ld: 'Leves Defeitos', devolucoes: 'Devoluções' };
    const icons = { showroom: '🏬', ecommerce: '🌐', mostruario: '👗', ld: '📋', devolucoes: '↩️' };
    
    // Mostrar loading
    const dataHoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    let html = `
        <div class="envios-detalhes-modal" id="envios-detalhes-modal">
            <div class="envios-detalhes-content">
                <div class="envios-detalhes-header">
                    <span class="envios-detalhes-title">${icons[canal]} ${nomes[canal]} - ${dataHoje}</span>
                    <button class="envios-detalhes-close" onclick="fecharDetalhesEnvios()">✕</button>
                </div>
                <div class="envios-detalhes-list" style="display:flex;align-items:center;justify-content:center">
                    <div class="resumo-dia-loading">Carregando detalhes...</div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente
    const existente = document.getElementById('envios-detalhes-modal');
    if (existente) existente.remove();
    document.body.insertAdjacentHTML('beforeend', html);
    history.pushState({enviosModal: true}, '', '');
    
    try {
        const colecao = capsulaAtual.colecao || 'I26';
        const capsula = capsulaAtual.num || 1;
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        const dataStr = `${ano}-${mes}-${dia}`;
        
        const url = `${API_CONFIG.baseUrl}/api/totvs/envios-dia?colecao=${colecao}&capsula=${capsula}&data=${dataStr}`;
        
        const response = await fetch(url, {
            headers: { 'X-API-Key': API_CONFIG.apiKey }
        });
        
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        // Mostrar detalhes
        const items = (data.detalhes?.[canal] || []);
        
        if (items.length === 0) {
            document.querySelector('#envios-detalhes-modal .envios-detalhes-list').innerHTML = `
                <div class="resumo-dia-loading">
                    <div style="font-size:48px;margin-bottom:16px">📭</div>
                    <div>Nenhum registro encontrado</div>
                </div>
            `;
            return;
        }
        
        // Agrupar por referência
        const porRef = {};
        for (const item of items) {
            const key = `${item.ref}-${item.cor}`;
            if (!porRef[key]) {
                porRef[key] = { ref: item.ref, cor: item.cor, desc: item.desc, tamanhos: {}, total: 0 };
            }
            porRef[key].tamanhos[item.tamanho] = (porRef[key].tamanhos[item.tamanho] || 0) + item.qtd;
            porRef[key].total += item.qtd;
        }
        
        const refsList = Object.values(porRef).sort((a, b) => a.ref.localeCompare(b.ref));
        const totalPecas = items.reduce((s, i) => s + i.qtd, 0);
        
        let listHtml = '';
        for (const ref of refsList) {
            const tamanhosHtml = ['PP', 'P', 'M', 'G', 'GG', 'UN'].filter(t => ref.tamanhos[t]).map(t => 
                `<span class="envio-tam">${t}: ${ref.tamanhos[t]}</span>`
            ).join('');
            
            const descEsc2 = (ref.desc || '').replace(/'/g, "\\'");
            listHtml += `
                <div class="envio-item" onclick="openPhoto('${ref.ref}','${descEsc2}')" style="cursor:pointer">
                    <div class="envio-item-header">
                        <div class="envio-item-ref">${icons[canal]} ${ref.ref}</div>
                        <div class="envio-item-total">${ref.total} pç</div>
                    </div>
                    <div class="envio-item-desc">${ref.desc || ''}</div>
                    <div class="envio-item-cor">🎨 ${ref.cor}</div>
                    <div class="envio-item-tamanhos">${tamanhosHtml}</div>
                </div>
            `;
        }
        
        const modal = document.getElementById('envios-detalhes-modal');
        modal.innerHTML = `
            <div class="envios-detalhes-content">
                <div class="envios-detalhes-header">
                    <span class="envios-detalhes-title">${icons[canal]} ${nomes[canal]} - ${dataHoje}</span>
                    <button class="envios-detalhes-close" onclick="fecharDetalhesEnvios()">✕</button>
                </div>
                <div class="envios-detalhes-summary">
                    <span>${refsList.length} referências</span>
                    <span>${totalPecas} peças</span>
                </div>
                <div class="envios-detalhes-list">
                    ${listHtml}
                </div>
            </div>
        `;
    } catch (e) {
        console.error('[Detalhes] Erro:', e);
        document.querySelector('#envios-detalhes-modal .envios-detalhes-list').innerHTML = `
            <div class="resumo-dia-loading">
                <div style="font-size:48px;margin-bottom:16px">⚠️</div>
                <div>Erro ao carregar</div>
                <div style="font-size:12px;margin-top:8px">${e.message}</div>
            </div>
        `;
    }
}

function openExpedicaoDestino(destino){
    currentExpDestino = destino;
    hideAll();
    document.getElementById('app-expedicao').classList.add('active');
    pushState('app-expedicao');
    
    // Limpar busca de referências
    const refSearch = document.getElementById('ref-search');
    if (refSearch) {
        refSearch.value = '';
        document.getElementById('ref-search-clear').classList.remove('visible');
    }
    
    // Skeleton loading: mostrar estrutura visual enquanto carrega
    document.getElementById('exp-total-stats').innerHTML = '<div class="skeleton-stats"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-stat"></div></div>';
    document.getElementById('exp-total-progress').innerHTML = '<div class="skeleton skeleton-progress"></div>';
    document.getElementById('exp-items-list').innerHTML = '<div style="text-align:center;padding:20px 0 12px;color:rgba(255,255,255,0.35);font-size:13px">Carregando dados...</div><div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div><div class="skeleton skeleton-card"></div>';
    
    // Inicializar pull-to-refresh se ainda não foi
    if (!ptrInitialized) {
        setTimeout(() => {
            initPullToRefresh();
            ptrInitialized = true;
        }, 100);
    }
    
    // Usar dados do prefetch se disponível, senão buscar normalmente
    if (prefetchPromises[destino]) {
        console.log('[Destino] Usando prefetch para:', destino);
        prefetchPromises[destino].then(prefetchData => {
            if (prefetchData && prefetchData.items && prefetchData.items.length > 0) {
                const transformed = transformApiData(prefetchData);
                if (transformed.items && transformed.items.length > 0) {
                    renderExpedicao(destino, transformed);
                    return;
                }
            }
            // Fallback: buscar normalmente
            renderExpedicao(destino);
        }).catch(() => renderExpedicao(destino));
    } else {
        renderExpedicao(destino);
    }
}

async function renderExpedicao(destino, dadosPreCarregados = null){
    // Reset modos de visualização
    window.viewModeReferencias = false;
    window.viewModeCores = false;
    window.selectedCores = new Set();
    window.selectedGrupos = new Set();
    const coresList = document.getElementById('exp-cores-list');
    if (coresList) coresList.classList.remove('visible');
    const gruposList = document.getElementById('exp-grupos-list');
    if (gruposList) gruposList.classList.remove('visible');
    
    const titles = {
        showroom: '🏬 Showroom', 
        ecommerce: '🌐 E-commerce', 
        mostruario: '👗 Mostruário Isabella',
        ld: '📋 Leves Defeitos'
    };
    
    document.getElementById('exp-header-title').textContent = titles[destino] || 'Expedição';
    
    // Atualizar subtítulo com cápsula atual
    const config = COLECOES_CONFIG[capsulaAtual.colecao];
    const subHeader = document.getElementById('exp-header-sub');
    if(subHeader && config) {
        subHeader.textContent = `${capsulaAtual.num}ª Cápsula ${config.nome}`;
    }
    
    // Usar dados passados ou buscar da API/cache
    const dadosAPI = dadosPreCarregados || await getExpedicaoData(destino);
    
    // Extrair items e dados de produção
    const todosItems = dadosAPI.items || dadosAPI || [];
    const producaoData = dadosAPI.producao || null;
    const totaisAPI = dadosAPI.totais || null;
    
    const refsExcluidas = ['SHI26023', 'SAI26012'];
    let dadosFiltrados = todosItems.filter(item => !refsExcluidas.includes(item.ref));
    
    // ========================================
    // DADOS DE PRODUÇÃO (para Resumo Geral)
    // ========================================
    let totalReferencias = 0;
    let totalVariantes = 0;
    let previsaoPecas = 0;
    let pecasRecebidas = 0;
    
    if (producaoData && producaoData.items) {
        // Usar dados de produção da API
        const refsProducao = new Set(producaoData.items.map(i => i.ref));
        totalReferencias = refsProducao.size;
        totalVariantes = producaoData.items.length;
        previsaoPecas = producaoData.totalAReceber || 0;
    }
    
    // Peças recebidas vem do totais.enviado (API já retorna líquido)
    pecasRecebidas = totaisAPI?.enviado || 0;
    
    // Se não tem dados de produção, usar dados de expedição como fallback
    if (totalReferencias === 0 && dadosFiltrados.length > 0) {
        const refsUnicas = new Set(dadosFiltrados.map(i => i.ref));
        totalReferencias = refsUnicas.size;
        totalVariantes = dadosFiltrados.length;
        
        // Calcular previsão baseado em prod (fallback)
        dadosFiltrados.forEach(item => {
            const p = item.prod || {};
            previsaoPecas += (p.PP||0) + (p.P||0) + (p.M||0) + (p.G||0);
        });
        
        // Calcular recebidas
        dadosFiltrados.forEach(item => {
            const e = item.envShow || {};
            pecasRecebidas += (e.PP||0) + (e.P||0) + (e.M||0) + (e.G||0);
        });
    }
    
    // ========================================
    // PROGRESSO (para barra de progresso)
    // ========================================
    const pctTotal = previsaoPecas > 0 ? ((pecasRecebidas / previsaoPecas) * 100).toFixed(1) : 0;
    const colorTotal = pctTotal >= 100 ? 'green' : 'blue';
    
    // Data de atualização - usa timestamp salvo ou hora atual se não tiver
    const dataAtualizacao = ultimaAtualizacaoTimestamp || new Date();
    const updateText = 'Última atualização: ' + dataAtualizacao.toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
    
    // ========================================
    // RENDERIZAR RESUMO GERAL
    // ========================================
    // Guardar dados para toggle de visualização
    window.currentProducaoData = producaoData;
    window.currentDadosFiltrados = dadosFiltrados;
    window.currentDestino = destino;
    
    let statsHtml;
    if(destino === 'ld') {
        statsHtml = `
            <div class="exp-stat"><div class="exp-stat-value">-</div><div class="exp-stat-label">Leves Defeitos</div></div>
            <div class="exp-stat"><div class="exp-stat-value">0</div><div class="exp-stat-label">Peças Reservadas</div></div>
        `;
    } else {
        const isRefActive = window.viewModeReferencias === true;
        statsHtml = `
            <div class="exp-stat exp-stat-clickable ${isRefActive ? 'active' : ''}" id="stat-referencias" onclick="toggleViewReferencias()" style="cursor:pointer"><div class="exp-stat-value">${totalReferencias}</div><div class="exp-stat-label">Total de Referências</div></div>
            <div class="exp-stat exp-stat-clickable ${window.viewModeCores ? 'active' : ''}" id="stat-variantes" onclick="toggleViewCores()" style="cursor:pointer"><div class="exp-stat-value">${totalVariantes}</div><div class="exp-stat-label">Variantes de Cor</div></div>
            <div class="exp-stat"><div class="exp-stat-value">${previsaoPecas.toLocaleString('pt-BR')}</div><div class="exp-stat-label">Previsão de Peças a Enviar</div></div>
            <div class="exp-stat"><div class="exp-stat-value">${pecasRecebidas.toLocaleString('pt-BR')}</div><div class="exp-stat-label">Peças Enviadas</div></div>
        `;
    }
    document.getElementById('exp-total-stats').innerHTML = statsHtml;
    
    // ========================================
    // RENDERIZAR BARRA DE PROGRESSO
    // ========================================
    let progressHtml;
    if(destino === 'ld') {
        progressHtml = `
            <div class="exp-progress-row">
                <div style="text-align:center;padding:20px;color:var(--txt2)">
                    <div style="font-size:24px;margin-bottom:8px">📋</div>
                    <div>Leves Defeitos ainda não configurado</div>
                    <div style="font-size:12px;margin-top:4px">Quando a operação for criada, as peças serão debitadas do Showroom</div>
                </div>
            </div>
        `;
    } else {
        progressHtml = `
            <div class="exp-progress-row">
                <div class="exp-progress-header">
                    <span class="exp-progress-label">Total Enviado</span>
                    <span class="exp-progress-value">${pecasRecebidas.toLocaleString('pt-BR')} / ${previsaoPecas.toLocaleString('pt-BR')}</span>
                </div>
                <div class="exp-progress-bar">
                    <div class="exp-progress-fill ${colorTotal}" style="width:${Math.min(pctTotal,100)}%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <span id="exp-update-text" style="font-size:12px;color:#ffc107;font-weight:600;background:rgba(255,193,7,0.15);padding:4px 8px;border-radius:4px">🕐 ${updateText}</span>
                    <span style="font-size:12px;font-weight:600;color:var(--${colorTotal})">${pctTotal}%</span>
                </div>
            </div>
        `;
    }
    document.getElementById('exp-total-progress').innerHTML = progressHtml;

    // ========================================
    // RENDERIZAR RESUMO DE ENVIOS DO DIA
    // ========================================
    let canaisHtml = '';
    const enviosDoDia = dadosAPI.enviosDoDia;
    
    console.log('[PWA] dadosAPI.enviosDoDia:', enviosDoDia);
    console.log('[PWA] dadosAPI keys:', Object.keys(dadosAPI));
    
    // Guardar envios do dia globalmente para o resumo geral
    window.currentEnviosDoDia = enviosDoDia;
    
    if (destino !== 'ld' && enviosDoDia) {
        const dataHoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        
        // Mapear destino para campo do enviosDoDia
        const canalMap = {
            'showroom': { key: 'showroom', icon: '🏬', nome: 'Showroom' },
            'ecommerce': { key: 'ecommerce', icon: '🌐', nome: 'E-commerce' },
            'mostruario': { key: 'mostruario', icon: '👗', nome: 'Mostruário Isabella' }
        };
        
        const canalAtual = canalMap[destino];
        if (canalAtual) {
            const valorCanal = enviosDoDia[canalAtual.key] || 0;
            const valorDevolucoes = enviosDoDia.devolucoes || 0;
            
            canaisHtml = `
                <div class="exp-canais-resumo">
                    <div class="exp-canais-title">📦 Movimentações de Hoje (${dataHoje})</div>
                    <div class="exp-canal-row">
                        <div class="exp-canal-destaque clickable" onclick="verDetalhesEnviosCanal('${canalAtual.key}')">
                            <span class="exp-canal-icon-lg">${canalAtual.icon}</span>
                            <div class="exp-canal-info">
                                <span class="exp-canal-nome-lg">Enviadas</span>
                                <span class="exp-canal-valor-lg">${valorCanal.toLocaleString('pt-BR')} pç</span>
                            </div>
                            <span class="exp-canal-arrow">›</span>
                        </div>
                        <div class="exp-canal-destaque clickable devolucao" onclick="verDetalhesEnviosCanal('devolucoes')">
                            <span class="exp-canal-icon-lg">↩️</span>
                            <div class="exp-canal-info">
                                <span class="exp-canal-nome-lg">Devolvidas</span>
                                <span class="exp-canal-valor-lg">${valorDevolucoes.toLocaleString('pt-BR')} pç</span>
                            </div>
                            <span class="exp-canal-arrow">›</span>
                        </div>
                    </div>
                </div>
            `;
        }
    } else if (destino === 'ld' && enviosDoDia) {
        const dataHoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        const valorLd = enviosDoDia.ld || 0;
        
        canaisHtml = `
            <div class="exp-canais-resumo">
                <div class="exp-canais-title">📦 Envios de Hoje (${dataHoje})</div>
                <div class="exp-canal-destaque clickable" onclick="verDetalhesEnviosCanal('ld')">
                    <span class="exp-canal-icon-lg">📋</span>
                    <div class="exp-canal-info">
                        <span class="exp-canal-nome-lg">Leves Defeitos</span>
                        <span class="exp-canal-valor-lg">${valorLd.toLocaleString('pt-BR')} peças</span>
                    </div>
                    <span class="exp-canal-arrow">›</span>
                </div>
            </div>
        `;
    } else if (destino !== 'ld') {
        // Fallback se não tiver dados de envios do dia
        canaisHtml = `
            <div class="exp-canais-resumo">
                <div class="exp-canais-title">📦 Envios de Hoje</div>
                <div style="text-align:center;padding:12px;color:var(--txt2);font-size:12px">
                    Dados não disponíveis. Faça um refresh.
                </div>
            </div>
        `;
    }
    
    // Inserir após o progress (antes da lista)
    let canaisContainer = document.getElementById('exp-canais-container');
    if (!canaisContainer) {
        canaisContainer = document.createElement('div');
        canaisContainer.id = 'exp-canais-container';
        document.getElementById('exp-total-progress').insertAdjacentElement('afterend', canaisContainer);
    }
    canaisContainer.innerHTML = canaisHtml;

    // ========================================
    // RENDERIZAR LISTA DE REFERÊNCIAS
    // ========================================
    // Usar dados de produção para a lista (se disponível)
    let itemsParaLista = [];
    
    if (producaoData && producaoData.items && producaoData.items.length > 0) {
        // Usar dados de produção
        itemsParaLista = producaoData.items.map(item => {
            // Calcular total de peças
            const corte = item.corte || {};
            const totalProd = (corte.PP||0) + (corte.P||0) + (corte.M||0) + (corte.G||0) + (corte.GG||0);
            
            // Buscar dados de envio correspondente
            const envItem = dadosFiltrados.find(d => d.ref === item.ref && d.cor === item.cor);
            const envShow = envItem?.envShow || { PP: 0, P: 0, M: 0, G: 0, GG: 0 };
            
            return {
                ref: item.ref,
                desc: item.desc || '',
                cor: item.cor,
                prod: {
                    PP: corte.PP || 0,
                    P: corte.P || 0,
                    M: corte.M || 0,
                    G: corte.G || 0,
                    GG: corte.GG || 0
                },
                envShow: envShow
            };
        });
    } else {
        // Fallback: usar dados de expedição
        itemsParaLista = dadosFiltrados;
    }
    
    // Guardar itemsParaLista para toggle de visualização
    window.currentItemsParaLista = itemsParaLista;
    
    const items = itemsParaLista.map(item => {
        const p = item.prod || {};
        const e = item.envShow || {};
        const totalP = (p.PP||0)+(p.P||0)+(p.M||0)+(p.G||0);
        const totalE = (e.PP||0)+(e.P||0)+(e.M||0)+(e.G||0);
        if(totalP === 0) return '';
        
        let metaItem, envItem;
        if(destino === 'showroom'){
            const ecommTams = ['PP','P','M','G'].filter(t => p[t] > 0).length;
            const isabellaQty = p.P > 0 ? 1 : 0;
            metaItem = totalP - ecommTams - isabellaQty;
            envItem = totalE;
        } else if(destino === 'ecommerce'){
            metaItem = ['PP','P','M','G'].filter(t => p[t] > 0).length;
            envItem = (e.PP||0)+(e.P||0)+(e.M||0)+(e.G||0);
        } else if(destino === 'mostruario'){
            metaItem = p.P > 0 ? 1 : (['PP','M','G'].find(t => p[t] > 0) ? 1 : 0);
            envItem = (e.PP||0)+(e.P||0)+(e.M||0)+(e.G||0);
        } else if(destino === 'ld'){
            metaItem = 0;
            envItem = 0;
        }
        
        const pctItem = metaItem > 0 ? ((envItem / metaItem) * 100).toFixed(0) : 0;
        const colorItem = pctItem >= 100 ? 'green' : 'blue';
        
        let tamanhos;
        if(destino === 'showroom'){
            tamanhos = ['PP','P','M','G'].filter(t => p[t] > 0).map(t => {
                const prod = p[t] || 0;
                const env = e[t] || 0;
                const descEcomm = 1;
                const descIsabella = (t === 'P') ? 1 : 0;
                const meta = prod - descEcomm - descIsabella;
                const pct = meta > 0 ? Math.min((env/meta)*100, 100) : 0;
                const col = env >= meta ? 'green' : 'blue';
                return '<div class="exp-tam-row"><span class="exp-tam-label">'+t+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/'+meta+'</span></div>';
            }).join('');
        } else if(destino === 'ecommerce'){
            tamanhos = ['PP','P','M','G'].filter(t => p[t] > 0).map(t => {
                const env = e[t] || 0;
                const meta = 1;
                const pct = env >= meta ? 100 : 0;
                const col = env >= meta ? 'green' : 'blue';
                return '<div class="exp-tam-row"><span class="exp-tam-label">'+t+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/'+meta+'</span></div>';
            }).join('');
        } else if(destino === 'mostruario'){
            let tamEsperado = p.P > 0 ? 'P' : ['PP','M','G'].find(t => p[t] > 0) || null;
            if(tamEsperado){
                const env = e[tamEsperado] || 0;
                const meta = 1;
                const pct = env >= meta ? 100 : 0;
                const col = env >= meta ? 'green' : 'blue';
                tamanhos = '<div class="exp-tam-row"><span class="exp-tam-label">'+tamEsperado+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/'+meta+'</span></div>';
            } else {
                tamanhos = '<div class="exp-tam-row"><span class="exp-tam-label" style="color:var(--txt2)">Sem tamanho cortado</span></div>';
            }
        } else if(destino === 'ld'){
            tamanhos = '<div class="exp-tam-row"><span class="exp-tam-label" style="color:var(--txt2)">Sem leves defeitos</span></div>';
        }
        
        const descEscaped = (item.desc || '').replace(/'/g, "\\'");
        return '<div class="exp-item" onclick="openPhoto(\''+item.ref+'\',\''+descEscaped+'\')"><div class="exp-item-header"><div><div class="exp-item-ref">'+item.ref+' <span style="font-weight:400;color:var(--txt2);font-size:11px">('+totalP+' pçs)</span></div><div class="exp-item-name">'+(item.desc || '')+'</div><div class="exp-item-cor">🎨 '+item.cor+'</div></div><div class="exp-item-badge" style="color:var(--'+colorItem+')">'+pctItem+'%</div></div><div class="exp-tamanhos-grid">'+tamanhos+'</div></div>';
    }).join('');
    
    document.getElementById('exp-items-list').innerHTML = items;
}


function openModule(mod){
    currentMod=mod;
    document.getElementById('home').classList.remove('visible');document.getElementById('home').classList.add('hidden');
    hideAll();
    afterLogin(mod, sessionStorage.getItem('logged-user') || 'andre');
}
function showLoginScreen(mod){
    hideAll();
    document.getElementById('login-mod-icon').textContent=modIcons[mod]||'📊';
    document.getElementById('login-mod-title').textContent=modNames[mod]||mod;
    document.getElementById('login-screen').classList.add('active');
    document.getElementById('login-user').value='';
    document.getElementById('login-pw').value='';
    document.getElementById('login-error').textContent='';
    pushState('login');
    setTimeout(()=>document.getElementById('login-user').focus(),100);
}
function doLogin(){
    const user=document.getElementById('login-user').value.trim().toLowerCase();
    const pw=document.getElementById('login-pw').value;
    const u=USERS[user];
    if(!u||u.pw!==pw){document.getElementById('login-error').textContent='Usuário ou senha incorretos';document.getElementById('login-pw').value='';return}
    if(u.role!=='admin' && !u.access.includes(currentMod)){document.getElementById('login-error').textContent='Sem permissão para este módulo';return}
    currentUser=user;
    document.getElementById('login-error').textContent='';
    sessionStorage.setItem('auth-'+currentMod,user);
    if(!localStorage.getItem('bio-user')&&window.PublicKeyCredential){
        if(confirm('Olá, '+u.nome+'! Deseja ativar a biometria para login rápido?')){registerBiometric(user)}
    }
    afterLogin(currentMod,user);
}
// ===== BIOMETRIA =====
async function registerBiometric(user){
    try{
        const id=new TextEncoder().encode(user);
        const cred=await navigator.credentials.create({publicKey:{
            challenge:crypto.getRandomValues(new Uint8Array(32)),
            rp:{name:'Isa Paes',id:location.hostname},
            user:{id,name:user,displayName:USERS[user].nome},
            pubKeyCredParams:[{alg:-7,type:'public-key'},{alg:-257,type:'public-key'}],
            authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required',residentKey:'discouraged'},
            timeout:60000
        }});
        if(cred){localStorage.setItem('bio-user',user);localStorage.setItem('bio-cred-id',btoa(String.fromCharCode(...new Uint8Array(cred.rawId))))}
    }catch(e){console.log('Bio cancelado')}
}
async function tryBiometric(mod,user){
    try{
        const credId=localStorage.getItem('bio-cred-id');
        if(!credId){showLoginScreen(mod);return}
        const rawId=Uint8Array.from(atob(credId),c=>c.charCodeAt(0));
        const a=await navigator.credentials.get({publicKey:{
            challenge:crypto.getRandomValues(new Uint8Array(32)),
            allowCredentials:[{id:rawId,type:'public-key'}],
            userVerification:'required',timeout:60000
        }});
        if(a){
            currentUser=user;const u=USERS[user];
            if(u.role!=='admin' && !u.access.includes(mod)){alert('Sem permissão para este módulo');goHome();return}
            sessionStorage.setItem('auth-'+mod,user);afterLogin(mod,user);
        }else{showLoginScreen(mod)}
    }catch(e){showLoginScreen(mod)}
}
function afterLogin(mod,user){
    hideAll();currentUser=user;
    // Iniciar heartbeat e verificação de kick
    startHeartbeat();
    startKickCheck();
    if(mod==='comercial'){document.getElementById('sub-comercial').classList.add('active');pushState('sub-comercial')}
    else if(mod==='compras'){document.getElementById('sub-compras').classList.add('active');pushState('sub-compras')}
    else if(mod==='financeiro'){document.getElementById('dev-financeiro').classList.add('active');pushState('dev-financeiro')}
}
function openChannel(ch){
    if(currentUser){const u=USERS[currentUser];if(u&&u.role!=='admin'&&!u.channels.includes(ch)){alert('Sem permissão para este canal');return}}
    hideAll();
    if(ch==='showroom'){document.getElementById('app-comercial').classList.add('active');pushState('app-comercial')}
}
function openGeolocator(){
    hideAll();
    document.getElementById('geo-screen').classList.add('active');
    pushState('geo-screen');
    geoInit();
}
function openGeoFromComercial(){
    hideAll();
    document.getElementById('geo-screen').classList.add('active');
    pushState('geo-screen');
    geoInit();
}
function backToSub(){goBackTo('sub-comercial')}
function goHome(){goBackTo('home'); updateModulesVisibility();}

// =====================================================
// MÓDULO COMPRAS - Tela de fornecedores TC/AV
// =====================================================
let comprasData = null;
let comprasTab = 'TODOS';
let comprasDetailView = null;
let comprasColecaoFilter = '';
let comprasCapsulaFilter = '';

// Navegação: Coleção → Cápsula → Tela de dados
function openComprasColecao(estacao) {
    hideAll();
    if (estacao === 'inverno') {
        document.getElementById('sub-compras-inverno').classList.add('active');
        pushState('sub-compras-inverno');
        comprasLoadColecaoTotals('I26');
    } else if (estacao === 'verao') {
        document.getElementById('sub-compras-verao').classList.add('active');
        pushState('sub-compras-verao');
        comprasLoadColecaoTotals('V27');
    }
}

async function comprasLoadColecaoTotals(colecao) {
    const totalEl = document.getElementById('compras-total-' + colecao);
    
    // Usar cache se já temos os dados
    if (comprasData && comprasData.pedidos && comprasData.pedidos.length > 0) {
        comprasRenderColecaoTotals(colecao);
        return;
    }
    
    if (totalEl) totalEl.innerHTML = '🛒 Carregando compras...';
    
    // Buscar dados
    try {
        const url = `${API_CONFIG.baseUrl}/api/totvs/compras/resumo`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // 90s timeout
        const resp = await fetch(url, { 
            headers: { 'X-API-Key': API_CONFIG.apiKey },
            signal: controller.signal 
        });
        clearTimeout(timeoutId);
        comprasData = await resp.json();
        comprasRenderColecaoTotals(colecao);
    } catch (e) {
        console.log('[Compras] Erro ao carregar totais:', e.message);
        if (totalEl) totalEl.innerHTML = '⚠️ Erro ao carregar totais';
    }
}

function comprasRenderColecaoTotals(colecao) {
    if (!comprasData || !comprasData.pedidos) return;
    
    const pedidosCol = comprasData.pedidos.filter(p => p.colecao === colecao && p.statusCalculado !== 'Cancelado');
    const totalValor = pedidosCol.reduce((s, p) => s + (p.totalAmountOrder || 0), 0);
    const totalPedidos = pedidosCol.length;
    
    const totalEl = document.getElementById('compras-total-' + colecao);
    if (totalEl) {
        if (totalPedidos > 0) {
            totalEl.innerHTML = `🛒 R$ ${formatarValor(totalValor)} em ${totalPedidos} pedidos`;
        } else {
            totalEl.innerHTML = '🛒 Nenhum pedido vinculado';
        }
    }
    
    // Popular subtotais por cápsula
    for (let i = 1; i <= 5; i++) {
        const capEl = document.getElementById('compras-cap-' + colecao + '-' + i);
        if (!capEl) continue;
        
        const pedidosCap = pedidosCol.filter(p => p.capsula === String(i));
        if (pedidosCap.length > 0) {
            const capValor = pedidosCap.reduce((s, p) => s + (p.totalAmountOrder || 0), 0);
            capEl.innerHTML = `${pedidosCap.length} ped · R$ ${formatarValor(capValor)}`;
            capEl.style.color = 'var(--green)';
        } else {
            const labels = ['Primeira','Segunda','Terceira','Quarta','Quinta'];
            capEl.innerHTML = `${labels[i-1]} entrega`;
            capEl.style.color = '';
        }
    }
}

function backToCompras() {
    hideAll();
    document.getElementById('sub-compras').classList.add('active');
    pushState('sub-compras');
}

function comprasGoBack() {
    if (comprasColecaoFilter) {
        // Estava em coleção+cápsula → volta pra tela de cápsulas
        hideAll();
        const estacao = comprasColecaoFilter.startsWith('I') ? 'inverno' : 'verao';
        document.getElementById('sub-compras-' + estacao).classList.add('active');
        pushState('sub-compras-' + estacao);
    } else {
        // Overview → volta pra sub-compras
        hideAll();
        document.getElementById('sub-compras').classList.add('active');
        pushState('sub-compras');
    }
}

function openComprasCapsula(colecao, capsula) {
    comprasColecaoFilter = colecao;
    comprasCapsulaFilter = capsula;
    comprasDetailView = null;
    hideAll();
    document.getElementById('dev-compras').classList.add('active');
    pushState('dev-compras');
    comprasInit();
}

function openComprasOverview() {
    comprasColecaoFilter = '';
    comprasCapsulaFilter = '';
    comprasDetailView = null;
    hideAll();
    document.getElementById('dev-compras').classList.add('active');
    pushState('dev-compras');
    comprasInit();
}

function comprasClearFilter() {
    comprasColecaoFilter = '';
    comprasCapsulaFilter = '';
    comprasDetailView = null;
    comprasRender();
}

async function comprasInit() {
    if (comprasData) { comprasUpdateFilterInfo(); comprasRender(); return; }
    comprasRefresh();
}

function comprasUpdateFilterInfo() {
    const info = document.getElementById('compras-filtro-info');
    const label = document.getElementById('compras-filtro-label');
    const title = document.getElementById('compras-header-title');
    
    if (comprasColecaoFilter) {
        const icon = comprasColecaoFilter.startsWith('I') ? '❄️' : '☀️';
        const colNome = comprasColecaoFilter.startsWith('I') ? 'Inverno 20' + comprasColecaoFilter.substring(1) : 'Verão 20' + comprasColecaoFilter.substring(1);
        title.textContent = `${icon} ${colNome}`;
        label.textContent = `${comprasCapsulaFilter ? comprasCapsulaFilter + 'ª Cápsula' : 'Todas cápsulas'}`;
        info.style.display = 'flex';
    } else {
        title.textContent = '📊 Visão Geral';
        info.style.display = 'none';
    }
}

async function comprasRefresh() {
    const btn = document.getElementById('compras-refresh-btn');
    if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
    document.getElementById('compras-content').innerHTML = '<div style="text-align:center;padding:40px 0;color:var(--txt2)"><div style="font-size:28px;margin-bottom:8px">⏳</div>Carregando dados de compras...<br><span style="font-size:11px">(pode demorar até 60s — buscando OPs + pedidos + NFs)</span></div>';
    try {
        const url = `${API_CONFIG.baseUrl}/api/totvs/compras/resumo`;
        const resp = await fetch(url, { headers: { 'X-API-Key': API_CONFIG.apiKey } });
        comprasData = await resp.json();
        comprasDetailView = null;
        comprasUpdateFilterInfo();
        comprasRender();
    } catch (e) {
        document.getElementById('compras-content').innerHTML = `<div style="text-align:center;padding:40px 0;color:var(--red)"><div style="font-size:28px;margin-bottom:8px">⚠️</div>Erro ao carregar dados<br><span style="font-size:11px;color:var(--txt2)">${e.message}</span></div>`;
    } finally {
        if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; }
    }
}

function comprasSetTab(tab) {
    comprasTab = tab;
    comprasDetailView = null;
    document.querySelectorAll('.compras-tab').forEach(t => t.classList.remove('active'));
    const tabs = document.querySelectorAll('.compras-tab');
    if (tab === 'TODOS') tabs[0]?.classList.add('active');
    else if (tab === 'TC') tabs[1]?.classList.add('active');
    else if (tab === 'AV') tabs[2]?.classList.add('active');
    comprasRender();
}

function comprasRender() {
    if (!comprasData) return;
    const d = comprasData;
    
    // Filtrar pedidos por coleção/cápsula
    let pedidosFiltrados = d.pedidos || [];
    if (comprasColecaoFilter) {
        pedidosFiltrados = pedidosFiltrados.filter(p => p.colecao === comprasColecaoFilter);
    }
    if (comprasCapsulaFilter) {
        pedidosFiltrados = pedidosFiltrados.filter(p => p.capsula === comprasCapsulaFilter);
    }
    
    // KPIs recalculados com filtro
    const abertos = pedidosFiltrados.filter(p => p.statusCalculado === 'Aberto').length;
    const parciais = pedidosFiltrados.filter(p => p.statusCalculado === 'Parcial').length;
    const atrasados = pedidosFiltrados.filter(p => p.statusCalculado === 'Atrasado').length;
    const recebidos = pedidosFiltrados.filter(p => p.statusCalculado === 'Recebido').length;
    
    const setKpi = (id, val, color) => {
        const el = document.getElementById(id);
        if (el) { el.querySelector('.compras-kpi-val').textContent = val; el.querySelector('.compras-kpi-val').style.color = color; }
    };
    setKpi('kpi-abertos', abertos, '#eab308');
    setKpi('kpi-parciais', parciais, '#f97316');
    setKpi('kpi-atrasados', atrasados, '#ef4444');
    setKpi('kpi-recebidos', recebidos, '#10b981');
    
    // Timestamp
    const vInfo = d.version === 3 ? ` · v3 · ${d.totais?.ops || 0} OPs` : '';
    const filterInfo = comprasColecaoFilter ? ` · ${comprasColecaoFilter}${comprasCapsulaFilter ? ' C' + comprasCapsulaFilter : ''}` : '';
    if (d.timestamp) {
        const dt = new Date(d.timestamp);
        document.getElementById('compras-update-time').textContent = `${dt.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'})}${vInfo}${filterInfo} · ${pedidosFiltrados.length} ped`;
    }
    
    // Store filtered data for list/detail
    comprasData._filteredPedidos = pedidosFiltrados;
    
    if (comprasDetailView) {
        comprasRenderDetail();
    } else {
        comprasRenderList();
    }
}

function comprasRenderList() {
    const d = comprasData;
    const pedidosFiltrados = d._filteredPedidos || d.pedidos || [];
    const hasFilter = comprasColecaoFilter || comprasCapsulaFilter;
    
    // Recalcular fornecedores a partir dos pedidos filtrados
    let fornecedoresParaExibir;
    if (hasFilter) {
        // Reagrupar fornecedores com base nos pedidos filtrados
        const fornMap = {};
        for (const p of pedidosFiltrados) {
            if (p.statusCalculado === 'Cancelado') continue;
            if (!fornMap[p.supplierCode]) {
                fornMap[p.supplierCode] = {
                    supplierCode: p.supplierCode, supplierName: p.supplierName,
                    tipo: null, pedidos: 0, valorTotal: 0,
                    abertos: 0, atrasados: 0, recebidos: 0, parciais: 0,
                    tiposDetectados: new Set(), colecoes: new Set(), capsulas: new Set()
                };
            }
            const f = fornMap[p.supplierCode];
            f.pedidos++;
            f.valorTotal += p.totalAmountOrder || 0;
            if (p.statusCalculado === 'Aberto') f.abertos++;
            if (p.statusCalculado === 'Parcial') f.parciais++;
            if (p.statusCalculado === 'Atrasado') f.atrasados++;
            if (p.statusCalculado === 'Recebido') f.recebidos++;
            if (p.colecao) f.colecoes.add(p.colecao);
            if (p.capsula) f.capsulas.add(p.capsula);
            for (const item of (p.items || [])) {
                const t = item.tipoMaterial;
                if (t && t !== 'OUTROS') f.tiposDetectados.add(t);
            }
        }
        for (const f of Object.values(fornMap)) {
            const tipos = f.tiposDetectados;
            if (tipos.has('TC') && tipos.has('AV')) f.tipo = 'MISTO';
            else if (tipos.has('TC')) f.tipo = 'TC';
            else if (tipos.has('AV')) f.tipo = 'AV';
            else f.tipo = 'OUTROS';
            f.tiposDetectados = Array.from(tipos);
            f.colecoes = Array.from(f.colecoes);
            f.capsulas = Array.from(f.capsulas);
            f.valorTotal = Math.round(f.valorTotal * 100) / 100;
        }
        const arr = Object.values(fornMap).sort((a, b) => b.valorTotal - a.valorTotal);
        fornecedoresParaExibir = {
            tecidos: arr.filter(f => f.tipo === 'TC'),
            aviamentos: arr.filter(f => f.tipo === 'AV'),
            mistos: arr.filter(f => f.tipo === 'MISTO'),
            outros: arr.filter(f => f.tipo === 'OUTROS')
        };
    } else {
        fornecedoresParaExibir = d.fornecedores;
    }
    
    if (!fornecedoresParaExibir) { document.getElementById('compras-content').innerHTML = '<div class="compras-empty">Sem dados de fornecedores</div>'; return; }
    
    let html = '';
    
    // Filtro ativo — coleções cards (só sem filtro)
    if (!hasFilter && d.producao && d.producao.colecoes && comprasTab === 'TODOS') {
        const cols = Object.values(d.producao.colecoes);
        if (cols.length > 0) {
            html += `<div style="background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:8px">
                <div style="font-size:11px;color:var(--txt2);margin-bottom:8px;font-weight:600">PRODUÇÃO · COLEÇÕES ATIVAS</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap">`;
            for (const col of cols) {
                const pct = col.qty > 0 ? Math.round(col.finished / col.qty * 100) : 0;
                const icon = col.estacao === 'inverno' ? '❄️' : '☀️';
                html += `<div style="flex:1;min-width:120px;background:var(--bg);border-radius:8px;padding:8px;cursor:pointer" onclick="comprasColecaoFilter='${col.codigo}';comprasCapsulaFilter='';comprasUpdateFilterInfo();comprasRender()">
                    <div style="font-size:12px;font-weight:700;color:var(--txt)">${icon} ${col.codigo}</div>
                    <div style="font-size:10px;color:var(--txt2)">${col.ops} OPs · ${Math.round(col.qty)} pçs</div>
                    <div style="background:var(--card2);border-radius:4px;height:4px;margin-top:4px;overflow:hidden">
                        <div style="width:${pct}%;background:var(--green);height:100%;transition:width .5s"></div>
                    </div>
                    <div style="font-size:9px;color:var(--txt2);margin-top:2px">${pct}% finalizado</div>
                </div>`;
            }
            html += `</div></div>`;
        }
    }
    
    // Distribuição TC x AV (recalculada com filtro)
    const pedidosAtivos = pedidosFiltrados.filter(p => p.statusCalculado !== 'Cancelado');
    const tcPed = pedidosAtivos.filter(p => p.tipoPedido === 'TC');
    const avPed = pedidosAtivos.filter(p => p.tipoPedido === 'AV');
    const tcVal = tcPed.reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
    const avVal = avPed.reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
    
    if (comprasTab === 'TODOS') {
        const total = tcVal + avVal;
        const pctTC = total > 0 ? Math.round(tcVal / total * 100) : 50;
        html += `<div style="background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;margin-bottom:12px">
            <div style="font-size:11px;color:var(--txt2);margin-bottom:6px;font-weight:600">DISTRIBUIÇÃO DE COMPRAS</div>
            <div style="display:flex;border-radius:6px;overflow:hidden;height:8px;background:var(--bg)">
                <div style="width:${pctTC}%;background:#3b82f6;transition:width .5s"></div>
                <div style="width:${100-pctTC}%;background:#eab308;transition:width .5s"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px">
                <span style="color:#3b82f6">🧵 Tecidos: ${tcPed.length} ped · R$ ${formatarValor(tcVal)}</span>
                <span style="color:#eab308">🪡 Aviamentos: ${avPed.length} ped · R$ ${formatarValor(avVal)}</span>
            </div>
        </div>`;
    } else if (comprasTab === 'TC') {
        const tcAbertos = tcPed.filter(p => p.statusCalculado === 'Aberto').length;
        const tcAtrasados = tcPed.filter(p => p.statusCalculado === 'Atrasado').length;
        const tcRecebidos = tcPed.filter(p => p.statusCalculado === 'Recebido').length;
        const tcValAbertos = tcPed.filter(p => p.statusCalculado === 'Aberto' || p.statusCalculado === 'Parcial').reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
        const tcValReceb = tcPed.filter(p => p.statusCalculado === 'Recebido').reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
        html += `<div style="background:linear-gradient(135deg, #3b82f611, #3b82f605);border:1px solid #3b82f633;border-radius:10px;padding:12px;margin-bottom:12px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <span style="font-size:13px;font-weight:700;color:#3b82f6">🧵 Total em Tecidos</span>
                <span style="font-size:16px;font-weight:800;color:var(--txt)">R$ ${formatarValor(tcVal)}</span>
            </div>
            <div style="display:flex;gap:8px;font-size:11px;color:var(--txt2)">
                <span>${tcPed.length} pedidos</span>
                <span>·</span>
                <span style="color:#eab308">${tcAbertos} abertos</span>
                <span>·</span>
                <span style="color:#ef4444">${tcAtrasados} atrasados</span>
                <span>·</span>
                <span style="color:#10b981">${tcRecebidos} recebidos</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--txt2)">
                <span>Pendente: R$ ${formatarValor(tcValAbertos)}</span>
                <span>Recebido: R$ ${formatarValor(tcValReceb)}</span>
            </div>
        </div>`;
    } else if (comprasTab === 'AV') {
        const avAbertos = avPed.filter(p => p.statusCalculado === 'Aberto').length;
        const avAtrasados = avPed.filter(p => p.statusCalculado === 'Atrasado').length;
        const avRecebidos = avPed.filter(p => p.statusCalculado === 'Recebido').length;
        const avValAbertos = avPed.filter(p => p.statusCalculado === 'Aberto' || p.statusCalculado === 'Parcial').reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
        const avValReceb = avPed.filter(p => p.statusCalculado === 'Recebido').reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
        html += `<div style="background:linear-gradient(135deg, #eab30811, #eab30805);border:1px solid #eab30833;border-radius:10px;padding:12px;margin-bottom:12px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <span style="font-size:13px;font-weight:700;color:#eab308">🪡 Total em Aviamentos</span>
                <span style="font-size:16px;font-weight:800;color:var(--txt)">R$ ${formatarValor(avVal)}</span>
            </div>
            <div style="display:flex;gap:8px;font-size:11px;color:var(--txt2)">
                <span>${avPed.length} pedidos</span>
                <span>·</span>
                <span style="color:#eab308">${avAbertos} abertos</span>
                <span>·</span>
                <span style="color:#ef4444">${avAtrasados} atrasados</span>
                <span>·</span>
                <span style="color:#10b981">${avRecebidos} recebidos</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--txt2)">
                <span>Pendente: R$ ${formatarValor(avValAbertos)}</span>
                <span>Recebido: R$ ${formatarValor(avValReceb)}</span>
            </div>
        </div>`;
    }
    
    // Fornecedores filtrados por aba
    const renderSection = (titulo, icon, fornecedores, cssClass) => {
        if (fornecedores.length === 0) return '';
        let s = `<div class="compras-section-title">${icon} ${titulo} <span class="compras-badge">${fornecedores.length}</span></div>`;
        for (const f of fornecedores) {
            s += comprasRenderFornCard(f, cssClass);
        }
        return s;
    };
    
    if (comprasTab === 'TODOS') {
        html += renderSection('Tecidos', '🧵', fornecedoresParaExibir.tecidos || [], 'tc');
        html += renderSection('Aviamentos', '🪡', fornecedoresParaExibir.aviamentos || [], 'av');
        if ((fornecedoresParaExibir.mistos || []).length > 0) html += renderSection('Mistos', '🔀', fornecedoresParaExibir.mistos, 'misto');
        if ((fornecedoresParaExibir.outros || []).length > 0) html += renderSection('Outros', '📦', fornecedoresParaExibir.outros, 'outros');
    } else if (comprasTab === 'TC') {
        html += renderSection('Fornecedores de Tecido', '🧵', fornecedoresParaExibir.tecidos || [], 'tc');
        const mistoTC = (fornecedoresParaExibir.mistos || []).filter(f => f.tiposDetectados?.includes('TC'));
        if (mistoTC.length > 0) html += renderSection('Mistos (com tecidos)', '🔀', mistoTC, 'misto');
    } else if (comprasTab === 'AV') {
        html += renderSection('Fornecedores de Aviamento', '🪡', fornecedoresParaExibir.aviamentos || [], 'av');
        const mistoAV = (fornecedoresParaExibir.mistos || []).filter(f => f.tiposDetectados?.includes('AV'));
        if (mistoAV.length > 0) html += renderSection('Mistos (com aviamentos)', '🔀', mistoAV, 'misto');
    }
    
    if (!html) html = '<div class="compras-empty">Nenhum fornecedor encontrado para este filtro</div>';
    
    document.getElementById('compras-content').innerHTML = html;
}

function comprasRenderFornCard(f, cssClass) {
    const tipoLabel = f.tipo === 'TC' ? 'TECIDO' : f.tipo === 'AV' ? 'AVIAMENTO' : f.tipo === 'MISTO' ? 'MISTO' : 'OUTROS';
    const tipoColor = f.tipo === 'TC' ? '#3b82f6' : f.tipo === 'AV' ? '#eab308' : f.tipo === 'MISTO' ? '#a855f7' : 'var(--txt2)';
    const avatarIcon = f.tipo === 'TC' ? '🧵' : f.tipo === 'AV' ? '🪡' : f.tipo === 'MISTO' ? '🔀' : '📦';
    
    return `<div class="compras-forn-card" onclick="comprasOpenDetail(${f.supplierCode})">
        <div class="compras-forn-header">
            <div class="compras-forn-avatar ${cssClass}">${avatarIcon}</div>
            <div class="compras-forn-name">${f.supplierName || 'Sem nome'}</div>
            <span class="compras-forn-tipo" style="background:${tipoColor}22;color:${tipoColor}">${tipoLabel}</span>
        </div>
        <div class="compras-forn-stats">
            <div class="compras-forn-stat"><div class="compras-forn-stat-val" style="color:var(--txt)">${f.pedidos || 0}</div><div class="compras-forn-stat-lbl">Pedidos</div></div>
            <div class="compras-forn-stat"><div class="compras-forn-stat-val" style="color:#eab308">${f.abertos || 0}</div><div class="compras-forn-stat-lbl">Abertos</div></div>
            <div class="compras-forn-stat"><div class="compras-forn-stat-val" style="color:#ef4444">${f.atrasados || 0}</div><div class="compras-forn-stat-lbl">Atrasados</div></div>
            <div class="compras-forn-stat"><div class="compras-forn-stat-val" style="color:#10b981">${f.recebidos || 0}</div><div class="compras-forn-stat-lbl">Recebidos</div></div>
        </div>
        <div class="compras-forn-valor">
            <span>Total: <b style="color:var(--txt)">R$ ${formatarValor(f.valorTotal)}</b></span>
            ${(f.colecoes && f.colecoes.length > 0) ? '<span style="font-size:10px">' + f.colecoes.map(c => '<span style="background:var(--bg);padding:1px 5px;border-radius:4px;color:var(--txt2)">' + c + '</span>').join(' ') + '</span>' : '<span style="font-size:13px;color:var(--txt2)">›</span>'}
        </div>
    </div>`;
}

function comprasOpenDetail(supplierCode) {
    comprasDetailView = supplierCode;
    comprasRenderDetail();
}

function comprasCloseDetail() {
    comprasDetailView = null;
    comprasRenderList();
}

function comprasRenderDetail() {
    if (!comprasData || !comprasDetailView) return;
    const code = comprasDetailView;
    
    // Achar fornecedor e pedidos
    const allForn = [...(comprasData.fornecedores.tecidos||[]),...(comprasData.fornecedores.aviamentos||[]),...(comprasData.fornecedores.mistos||[]),...(comprasData.fornecedores.outros||[])];
    const forn = allForn.find(f => f.supplierCode === code);
    const pedidos = (comprasData._filteredPedidos || comprasData.pedidos || []).filter(p => p.supplierCode === code);
    
    if (!forn && pedidos.length === 0) { document.getElementById('compras-content').innerHTML = '<div class="compras-empty">Fornecedor não encontrado para este filtro</div>'; return; }
    const fornName = forn ? forn.supplierName : (pedidos[0]?.supplierName || 'Fornecedor');
    const fornTotal = pedidos.reduce((s,p) => s + (p.totalAmountOrder || 0), 0);
    
    let html = `<div class="compras-back-header" style="margin:-12px -16px 12px;padding:12px 16px">
        <button class="compras-back-btn" onclick="comprasCloseDetail()">←</button>
        <div style="flex:1;overflow:hidden">
            <div style="font-size:14px;font-weight:700;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${fornName}</div>
            <div style="font-size:11px;color:var(--txt2)">${pedidos.length} pedidos · R$ ${formatarValor(fornTotal)}${comprasColecaoFilter ? ' · ' + comprasColecaoFilter : ''}${comprasCapsulaFilter ? ' C' + comprasCapsulaFilter : ''}</div>
        </div>
    </div>`;
    
    // Status summary
    const byStatus = {};
    pedidos.forEach(p => { byStatus[p.statusCalculado] = (byStatus[p.statusCalculado]||0)+1; });
    html += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">`;
    for (const [st, count] of Object.entries(byStatus)) {
        const cls = st.toLowerCase().replace('í','i');
        html += `<span class="compras-pedido-status ${cls}" style="font-size:11px">${st}: ${count}</span>`;
    }
    html += `</div>`;
    
    // Pedidos
    for (const p of pedidos) {
        const cls = p.statusCalculado.toLowerCase().replace('í','i');
        const regDate = p.registrationDate ? new Date(p.registrationDate).toLocaleDateString('pt-BR') : '—';
        const dlDate = p.deliveryDeadlineDate ? new Date(p.deliveryDeadlineDate).toLocaleDateString('pt-BR') : '—';
        
        html += `<div class="compras-pedido-card">
            <div class="compras-pedido-header">
                <span class="compras-pedido-num">Pedido #${p.orderCode}${p.colecao ? ' <span style="font-size:9px;font-weight:400;color:var(--txt2);background:var(--bg);padding:1px 5px;border-radius:4px;margin-left:4px">' + p.colecao + (p.capsula ? ' C' + p.capsula : '') + '</span>' : ''}</span>
                <span class="compras-pedido-status ${cls}">${p.statusCalculado}</span>
            </div>
            <div class="compras-pedido-info">
                <span>📅 ${regDate}</span>
                <span>🚚 ${dlDate}</span>
                <span>R$ ${formatarValor(p.totalAmountOrder)}</span>
            </div>`;
        
        if (p.items && p.items.length > 0) {
            html += `<div class="compras-pedido-items">`;
            for (const item of p.items.slice(0, 5)) {
                const tipoIcon = item.tipoMaterial === 'TC' ? '🧵' : item.tipoMaterial === 'AV' ? '🪡' : '📦';
                const shortName = (item.referenceName || item.name || '').substring(0, 30);
                html += `<div class="compras-pedido-item">
                    <span class="compras-pedido-item-name">${tipoIcon} ${shortName}</span>
                    <span class="compras-pedido-item-qty">${item.colorName || ''} · ${item.quantidadePedida || item.quantity || 0} ${item.measuredUnit || ''}</span>
                </div>`;
            }
            if (p.items.length > 5) html += `<div style="font-size:10px;color:var(--txt2);text-align:center;padding:4px">+${p.items.length - 5} itens</div>`;
            html += `</div>`;
        }
        html += `</div>`;
    }
    
    if (pedidos.length === 0) html += '<div class="compras-empty">Nenhum pedido encontrado</div>';
    
    document.getElementById('compras-content').innerHTML = html;
}

function formatarValor(v) {
    if (v == null || isNaN(v)) return '0,00';
    return Number(v).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Atualiza visibilidade dos módulos baseado no acesso do usuário
function updateModulesVisibility() {
    if (!currentUser) return;
    
    const user = USERS[currentUser];
    if (!user || !user.access) {
        // Se não tem dados do usuário, esconder tudo por segurança
        document.querySelectorAll('.mod-btn').forEach(btn => btn.style.display = 'none');
        console.log('[Modules] Sem dados de acesso - módulos ocultos');
        return;
    }
    
    // Admin vê todos os módulos
    if (user.role === 'admin') {
        document.querySelectorAll('.mod-btn').forEach(btn => btn.style.display = '');
        console.log('[Modules] Admin - todos os módulos visíveis');
        return;
    }
    
    const accessMap = {
        'mod-comercial': 'comercial',
        'mod-compras': 'compras',
        'mod-expedicao': 'estoque', // Expedição usa acesso 'estoque'
        'mod-financeiro': 'financeiro'
    };
    
    for (const [btnId, accessKey] of Object.entries(accessMap)) {
        const btn = document.getElementById(btnId);
        if (btn) {
            if (user.access.includes(accessKey)) {
                btn.style.display = '';
            } else {
                btn.style.display = 'none';
            }
        }
    }
    
    console.log('[Modules] Visibilidade atualizada para:', user.access);
}

function goBackTo(target){
    // Remove entries from navHistory until we find target or reach bottom
    while(navHistory.length > 1 && navHistory[navHistory.length-1] !== target){
        navHistory.pop();
    }
    if(navHistory[navHistory.length-1] !== target){
        navHistory.push(target);
    }
    hideAll();
    if(target==='home'){currentMod=null;document.getElementById('home').classList.remove('hidden');document.getElementById('home').classList.add('visible');}
    else{var el=document.getElementById(target);if(el)el.classList.add('active');}
    history.replaceState({screen:target},'','');
    sessionStorage.setItem('current-screen',target);
}
function fC(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:0,maximumFractionDigits:0}).format(v)}
function fCF(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v)}
function fP(v){return(v*100).toFixed(1)+'%'}
document.querySelectorAll('.nav-btn').forEach(b=>{b.addEventListener('click',()=>{
document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(b.dataset.screen).classList.add('active');
// Salvar aba ativa
sessionStorage.setItem('last-tab', b.dataset.screen);
})});

// Restaurar aba ativa ao carregar
(function(){
    const lastTab = sessionStorage.getItem('last-tab');
    if(lastTab){
        const btn = document.querySelector(`.nav-btn[data-screen="${lastTab}"]`);
        const screen = document.getElementById(lastTab);
        if(btn && screen){
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            btn.classList.add('active');
            screen.classList.add('active');
        }
    }
})();
// Combinar P e F para buscar dados completos
const allProducts = [...P, ...F];
document.getElementById('topdia').innerHTML=R.slice(0,10).map((t,i)=>{
    const prod = allProducts.find(p => p.referencia === t.referencia) || {};
    const giroDia = prod.estoqueEnviado ? (t.pecas / prod.estoqueEnviado) : 0;
    return `<div class="product-item" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><div class="rank-number ${i<3?'rank-'+(i+1):'rank-default'}">${i+1}</div></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${prod.estoqueAtual || 0}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.pecas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Dia: </span><span class="product-stat-value">${fP(giroDia)}</span></div></div><div style="margin-top:8px"><span class="product-stat-label">Valor total: </span><span class="product-stat-value">${fCF(t.valor)}</span></div></div>`;
}).join('');
const tA=A.filter(x=>x.aceitacao>0).sort((a,b)=>b.aceitacao-a.aceitacao).slice(0,5);
document.getElementById('topA').innerHTML=tA.map((t,i)=>`<div class="product-item" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><span class="status-badge status-excelente">${fP(t.aceitacao)}</span></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${t.estoqueAtual}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.vendasLiquidas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Total: </span><span class="product-stat-value">${fP(t.giro || (t.vendasLiquidas/t.enviado))}</span></div></div><div class="product-stats" style="margin-top:4px"><div class="product-stat"><span class="product-stat-label">Devoluções: </span><span class="product-stat-value">${t.devolucoes || 0}</span></div></div></div>`).join('');
const tR=A.filter(x=>x.rejeicao>0).sort((a,b)=>b.rejeicao-a.rejeicao).slice(0,5);
document.getElementById('topR').innerHTML=tR.map((t,i)=>`<div class="product-item" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><span class="status-badge status-fraco">${fP(t.aceitacao)}</span></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${t.estoqueAtual}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.vendasLiquidas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Total: </span><span class="product-stat-value">${fP(t.giro || (t.vendasLiquidas/t.enviado))}</span></div></div><div class="product-stats" style="margin-top:4px"><div class="product-stat"><span class="product-stat-label">Devoluções: </span><span class="product-stat-value">${t.devolucoes || 0}</span></div></div></div>`).join('');
function gS(s){if(s.includes('Excelente'))return'status-excelente';if(s.includes('Bom'))return'status-bom';if(s.includes('Fraco'))return'status-fraco';return'status-regular'}
function gK(s){if(s.includes('Excelente'))return'excelente';if(s.includes('Bom'))return'bom';if(s.includes('Fraco'))return'fraco';return'regular'}
function gC(s){if(s.includes('Excelente'))return'card-excelente';if(s.includes('Bom'))return'card-bom';if(s.includes('Fraco'))return'card-fraco';return'card-regular'}
function rR(f='all'){let items=A;if(f!=='all')items=items.filter(x=>gK(x.status)===f);
document.getElementById('rc').innerHTML=items.map(t=>`<div class="product-item ${gC(t.status)}" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><span class="status-badge ${gS(t.status)}">${fP(t.aceitacao)}</span></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${t.estoqueAtual}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.vendasLiquidas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Total: </span><span class="product-stat-value">${fP(t.giro || (t.vendasLiquidas/t.enviado))}</span></div></div><div class="product-stats" style="margin-top:4px"><div class="product-stat"><span class="product-stat-label">Devoluções: </span><span class="product-stat-value">${t.devolucoes || 0}</span></div></div></div>`).join('')}
document.querySelectorAll('#rf .filter-pill').forEach(p=>{p.addEventListener('click',()=>{document.querySelectorAll('#rf .filter-pill').forEach(x=>x.classList.remove('active'));p.classList.add('active');rR(p.dataset.filter)})});rR();
function rP(s=''){let items=P;if(s){const q=s.toLowerCase();items=items.filter(x=>x.referencia.toLowerCase().includes(q)||x.descricao.toLowerCase().includes(q))}
document.getElementById('lp').innerHTML=items.map(t=>{const sc=t.status==='Excelente'?'status-excelente':'status-bom';return`<div class="product-item" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><div class="product-price">${fCF(t.preco)}</div></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${t.estoqueAtual}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.vendasLiquidas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Total: </span><span class="product-stat-value">${fP(t.giro)}</span></div></div><div style="margin-top:8px"><span class="status-badge ${sc}">${t.status}</span></div></div>`}).join('')}rP();
document.getElementById('lf').innerHTML=F.map(t=>`<div class="product-item" onclick="openPhoto('${t.referencia}','${t.descricao.replace(/'/g,"\\'")}')"><div class="product-header"><div><div class="product-ref">${t.referencia}</div><div class="product-name">${t.descricao}</div></div><div class="product-price">${fCF(t.preco)}</div></div><div class="product-stats"><div class="product-stat"><span class="product-stat-label">Estoque: </span><span class="product-stat-value">${t.estoqueAtual}</span></div><div class="product-stat"><span class="product-stat-label">Vendas: </span><span class="product-stat-value">${t.vendasLiquidas} pçs</span></div><div class="product-stat"><span class="product-stat-label">Giro Total: </span><span class="product-stat-value">${fP(t.giro)}</span></div></div><div style="margin-top:8px"><span class="status-badge status-fotos">📷 Fotos ISA</span></div></div>`).join('');
document.getElementById('sc')?.addEventListener('input',e=>rP(e.target.value));
// PWA Install
let deferredPrompt;
const ib=document.getElementById('installBanner');
const isStandalone=window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone;
if(!isStandalone){ib.classList.add('visible')}
window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    deferredPrompt=e;
    if(!isStandalone)ib.classList.add('visible');
});
function installApp(){
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(r=>{
            if(r.outcome==='accepted')ib.classList.remove('visible');
            deferredPrompt=null;
        });
    }else{
        // Fallback: instrução manual
        const ua=navigator.userAgent.toLowerCase();
        if(ua.includes('iphone')||ua.includes('ipad')){
            alert('Para instalar:\n\n1. Toque no botão Compartilhar ⬆️\n2. Selecione "Adicionar à Tela de Início"');
        }else{
            alert('Para instalar:\n\n1. Toque nos 3 pontinhos (⋮) do navegador\n2. Selecione "Instalar app" ou "Adicionar à tela inicial"');
        }
    }
}
window.addEventListener('appinstalled',()=>{ib.classList.remove('visible')});

if('serviceWorker' in navigator){
    var swUrl = '/inverno-2026/sw.js';
    
    // Detectar reload (pull-to-refresh ou F5) - limpar TUDO e recarregar limpo
    const isReload = performance.navigation?.type === 1 || performance.getEntriesByType?.('navigation')?.[0]?.type === 'reload';
    
    if (isReload) {
        console.log('[SW] Reload detectado - limpando caches...');
        // Limpar todos os caches do SW
        caches.keys().then(names => {
            return Promise.all(names.map(name => caches.delete(name)));
        }).then(() => {
            console.log('[SW] Caches limpos');
        });
    }
    
    navigator.serviceWorker.register(swUrl, {scope:'/inverno-2026/', updateViaCache: 'none'}).then(function(reg){
        console.log('[SW] Registrado');
        
        // Forçar verificação de atualização
        reg.update();
        
        // Se já tem um SW esperando, ativar
        if (reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
        
        // Quando houver nova versão
        reg.addEventListener('updatefound', function() {
            var newWorker = reg.installing;
            newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[SW] Nova versão pronta - ativando...');
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        });
    }).catch(function(err){
        console.log('[SW] Erro:', err);
    });
}

// ========== GEOLOCALIZADOR ==========
let geoMap,geoGeocoder,geoLocations=[],geoMarkers=[],geoCircles=[],geoShowRadius=true,geoApiKey='AIzaSyARGjgURb7_rNxQVkeV6AZ46XLk4UcPzhc',geoMapInitialized=false;

function geoInit(){
    if(!geoMapInitialized){
        geoLoadMaps();
    }else{
        geoUpdateUI();
        setTimeout(()=>{
            if(geoMap){
                google.maps.event.trigger(geoMap,'resize');
                if(geoMarkers.length>0)geoFitBounds();
            }
        },100);
    }
}

function geoLoadMaps(){
    if(window.google&&window.google.maps){
        geoInitMap();
        return;
    }
    const script=document.createElement('script');
    script.src=`https://maps.googleapis.com/maps/api/js?key=${geoApiKey}&callback=geoInitMap&libraries=geometry`;
    script.async=true;
    script.defer=true;
    script.onerror=()=>{
        geoShowToast('Erro ao carregar Google Maps.','error');
    };
    document.head.appendChild(script);
}

function geoInitMap(){
    geoMap=new google.maps.Map(document.getElementById('geoMap'),{
        center:{lat:-19.9167,lng:-43.9345}, // Belo Horizonte
        zoom:12,
        disableDefaultUI:false,
        zoomControl:true,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:true,
        gestureHandling:'greedy', // Permite arrastar com 1 dedo
        scrollwheel:true
    });
    geoGeocoder=new google.maps.Geocoder();
    geoMapInitialized=true;
    
    // Carregar locais da base (instantâneo, sem geocodificação)
    geoLocations = JSON.parse(JSON.stringify(GEO_BASE_LOCATIONS));
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 2;
    
    // Calcular conflitos
    geoLocations.forEach(loc => {
        loc.conflicts = geoCheckConflictsLocal(loc.lat, loc.lng, minDist, loc.id);
    });
    
    // Criar marcadores
    geoLocations.forEach((loc, i) => geoCreateMarker(loc, i));
    geoUpdateUI();
    
    // Ajustar zoom
    setTimeout(() => {
        google.maps.event.trigger(geoMap, 'resize');
        geoFitBounds();
    }, 300);
}

// Verificar conflitos sem usar Google Maps API
function geoCheckConflictsLocal(lat, lng, minDist, excludeId) {
    const conflicts = [];
    const toRad = x => x * Math.PI / 180;
    
    geoLocations.forEach(loc => {
        if (excludeId && loc.id === excludeId) return;
        
        // Fórmula de Haversine
        const R = 6371; // km
        const dLat = toRad(loc.lat - lat);
        const dLng = toRad(loc.lng - lng);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat)) * Math.cos(toRad(loc.lat)) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const dist = R * c;
        
        if (dist < minDist) {
            conflicts.push({id: loc.id, distance: dist.toFixed(2)});
        }
    });
    return conflicts;
}

function geoCreateMarker(loc,index){
    const isConflict=loc.conflicts&&loc.conflicts.length>0&&!loc.bypass;
    const isBypassed=loc.bypass&&loc.conflicts&&loc.conflicts.length>0;
    let color;
    if(isBypassed)color='#ffc107';
    else if(isConflict)color='#cc2936';
    else color='#50c878';
    
    // SVG do pin
    const pinSvg = {
        path: 'M12 0C7.58 0 4 3.58 4 8c0 5.25 8 13 8 13s8-7.75 8-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z',
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2,
        scale: 1.8,
        anchor: new google.maps.Point(12, 21)
    };
    
    const marker=new google.maps.Marker({
        position:{lat:loc.lat,lng:loc.lng},
        map:geoMap,
        title:loc.nome || loc.address,
        icon: pinSvg
    });
    marker.locationId=loc.id;
    geoMarkers.push(marker);
    const minDist=parseFloat(document.getElementById('geoMinDistance').value)||2;
    const circle=new google.maps.Circle({
        map:geoShowRadius?geoMap:null,
        center:{lat:loc.lat,lng:loc.lng},
        radius:minDist*1000,
        fillColor:'#e94560',
        fillOpacity:0.08,
        strokeColor:'#e94560',
        strokeOpacity:0.3,
        strokeWeight:1
    });
    circle.locationId=loc.id;
    geoCircles.push(circle);
    const infoWindow=new google.maps.InfoWindow({
        content:`<div style="color:#000;padding:8px;max-width:220px;"><strong>${index+1}. ${loc.address}</strong></div>`
    });
    marker.addListener('click',()=>infoWindow.open(geoMap,marker));
}

function geoUpdateUI(){
    const minDist=parseFloat(document.getElementById('geoMinDistance').value)||0.5;
    geoLocations.forEach(loc=>{loc.conflicts=geoCheckConflictsLocal(loc.lat,loc.lng,minDist,loc.id)});
    const total=geoLocations.length;
    const valid=geoLocations.filter(l=>l.conflicts.length===0||l.bypass).length;
    const conflicts=total-valid;
    document.getElementById('geoTotal').textContent=total;
    document.getElementById('geoValid').textContent=valid;
    document.getElementById('geoConflicts').textContent=conflicts;
    document.getElementById('geoLocsCount').textContent=`${total} locais`;
    const list=document.getElementById('geoLocsList');
    if(geoLocations.length===0){
        list.innerHTML='<div class="geo-empty"><div class="geo-empty-icon">🗺️</div><p>Adicione endereços para começar</p></div>';
        return;
    }
    list.innerHTML=geoLocations.map((loc,i)=>{
        const hasConflict=loc.conflicts&&loc.conflicts.length>0;
        let cardClass='',statusHtml='';
        if(hasConflict){cardClass='conflict';const dets=loc.conflicts.map(c=>c.distance+'km').join(', ');statusHtml=`<span class="geo-loc-status conflict">⚠️ ${loc.conflicts.length}: ${dets}</span>`}
        else{cardClass='valid';statusHtml='<span class="geo-loc-status ok">✓ OK</span>'}
        const displayName = loc.nome ? `<div class="geo-loc-name">${loc.nome}</div>` : '';
        return`<div class="geo-loc-card ${cardClass}" onclick="geoFocus(${loc.id})" style="cursor:pointer"><div class="geo-loc-marker">${i+1}</div><div class="geo-loc-info">${displayName}<div class="geo-loc-address">${loc.address}</div>${statusHtml}</div><div class="geo-loc-actions"><button class="geo-action-btn delete" onclick="event.stopPropagation();geoRemove(${loc.id})" title="Remover">×</button></div></div>`;
    }).join('');
    geoUpdateMarkers();
}

function geoUpdateMarkers(){
    geoMarkers.forEach(m=>m.setMap(null));
    geoCircles.forEach(c=>c.setMap(null));
    geoMarkers=[];geoCircles=[];
    geoLocations.forEach((loc,i)=>geoCreateMarker(loc,i));
}

function geoFocus(id){
    const loc=geoLocations.find(l=>l.id===id);
    if(loc){geoMap.setCenter({lat:loc.lat,lng:loc.lng});geoMap.setZoom(15)}
}

function geoToggleBypass(id){
    const loc=geoLocations.find(l=>l.id===id);
    if(loc){loc.bypass=!loc.bypass;geoSaveLocations();geoUpdateUI();geoShowToast(loc.bypass?'Bypass ativado':'Bypass desativado',loc.bypass?'warning':'success')}
}

function geoRemove(id){
    geoLocations=geoLocations.filter(l=>l.id!==id);
    geoSaveLocations();geoUpdateUI();
    geoShowToast('Local removido','success');
}

function geoClearAll(){
    if(geoLocations.length===0)return;
    if(confirm('Remover todos os locais?')){
        geoLocations=[];
        geoMarkers.forEach(m=>m.setMap(null));
        geoCircles.forEach(c=>c.setMap(null));
        geoMarkers=[];geoCircles=[];
        geoSaveLocations();geoUpdateUI();
        geoShowToast('Todos removidos','success');
    }
}

function geoToggleRadius(){
    const toggle=document.getElementById('geoShowRadius');
    geoShowRadius=!geoShowRadius;
    toggle.classList.toggle('active',geoShowRadius);
    geoCircles.forEach(c=>c.setMap(geoShowRadius?geoMap:null));
}

function geoFitBounds(){
    if(geoMarkers.length===0)return;
    const bounds=new google.maps.LatLngBounds();
    geoMarkers.forEach(m=>bounds.extend(m.getPosition()));
    geoMap.fitBounds(bounds);
    const listener=google.maps.event.addListener(geoMap,'idle',()=>{
        if(geoMap.getZoom()>15)geoMap.setZoom(15);
        google.maps.event.removeListener(listener);
    });
}

function geoSaveLocations(){localStorage.setItem('geo_locations',JSON.stringify(geoLocations))}

document.getElementById('geoMinDistance').addEventListener('change',()=>{
    geoUpdateUI();
    const minDist=parseFloat(document.getElementById('geoMinDistance').value)||2;
    geoCircles.forEach(c=>c.setRadius(minDist*1000));
});

function geoShowToast(msg,type='info'){
    const container=document.getElementById('geoToastContainer');
    const toast=document.createElement('div');
    toast.className=`geo-toast ${type}`;
    const icons={error:'❌',success:'✅',warning:'⚠️',info:'ℹ️'};
    toast.innerHTML=`<span class="geo-toast-icon">${icons[type]}</span><span class="geo-toast-msg">${msg}</span>`;
    container.appendChild(toast);
    setTimeout(()=>{toast.style.animation='geoToastIn .3s ease reverse';setTimeout(()=>toast.remove(),300)},3000);
}

// Base de endereços com coordenadas fixas
const GEO_BASE_LOCATIONS = [
    {id: 1, nome: 'Showroom ISA|PAES', address: 'R. Safira, 541 - Prado, Belo Horizonte - MG, 30411-127, Brasil', bairro: 'Prado', cidade: 'Belo Horizonte', estado: 'MG', pais: 'Brasil', cep: '30411-127', lat: -19.927388, lng: -43.963786, bypass: false, conflicts: []},
    {id: 2, nome: 'Fábrica ISA|PAES', address: 'R. Ituiutaba, 401 - Prado, Belo Horizonte - MG, 30411-023, Brasil', bairro: 'Prado', cidade: 'Belo Horizonte', estado: 'MG', pais: 'Brasil', cep: '30411-023', lat: -19.919356, lng: -43.960834, bypass: false, conflicts: []},
    {id: 3, nome: 'Outlet ISA|PAES', address: 'R. Cuiabá, 586 - Prado, Belo Horizonte - MG, 30411-213, Brasil', bairro: 'Prado', cidade: 'Belo Horizonte', estado: 'MG', pais: 'Brasil', cep: '30411-213', lat: -19.928356, lng: -43.963672, bypass: false, conflicts: []}
];

// Mostrar sugestões de busca
function geoShowSearchSuggestions() {
    const search = document.getElementById('geoSearchInput').value.toLowerCase().trim();
    const suggestions = document.getElementById('geoSearchSuggestions');
    
    if (!search || search.length < 1) {
        suggestions.classList.remove('active');
        return;
    }
    
    let html = '';
    
    // Sugestões de nomes de locais
    const nameMatches = GEO_BASE_LOCATIONS.filter(loc => 
        loc.nome.toLowerCase().includes(search)
    );
    if (nameMatches.length > 0) {
        nameMatches.forEach(loc => {
            const highlighted = loc.nome.replace(new RegExp(`(${search})`, 'gi'), '<strong>$1</strong>');
            html += `<div class="geo-suggestion-item" onclick="geoSelectSearchSuggestion('${loc.nome}')">📍 ${highlighted}<br><small>${loc.bairro}, ${loc.cidade}</small></div>`;
        });
    }
    
    // Sugestões de bairros únicos
    const bairros = [...new Set(GEO_BASE_LOCATIONS.map(l => l.bairro))].filter(b => b.toLowerCase().includes(search));
    bairros.forEach(bairro => {
        const highlighted = bairro.replace(new RegExp(`(${search})`, 'gi'), '<strong>$1</strong>');
        const count = GEO_BASE_LOCATIONS.filter(l => l.bairro === bairro).length;
        html += `<div class="geo-suggestion-item" onclick="geoSelectSearchSuggestion('${bairro}')">🏘️ ${highlighted}<br><small>Bairro • ${count} local(is)</small></div>`;
    });
    
    // Sugestões de cidades únicas
    const cidades = [...new Set(GEO_BASE_LOCATIONS.map(l => l.cidade))].filter(c => c.toLowerCase().includes(search));
    cidades.forEach(cidade => {
        const highlighted = cidade.replace(new RegExp(`(${search})`, 'gi'), '<strong>$1</strong>');
        const count = GEO_BASE_LOCATIONS.filter(l => l.cidade === cidade).length;
        html += `<div class="geo-suggestion-item" onclick="geoSelectSearchSuggestion('${cidade}')">🏙️ ${highlighted}<br><small>Cidade • ${count} local(is)</small></div>`;
    });
    
    // Sugestões de estados únicos
    const estados = [...new Set(GEO_BASE_LOCATIONS.map(l => l.estado))].filter(e => e.toLowerCase().includes(search));
    estados.forEach(estado => {
        const highlighted = estado.replace(new RegExp(`(${search})`, 'gi'), '<strong>$1</strong>');
        const count = GEO_BASE_LOCATIONS.filter(l => l.estado === estado).length;
        html += `<div class="geo-suggestion-item" onclick="geoSelectSearchSuggestion('${estado}')">🗺️ ${highlighted}<br><small>Estado • ${count} local(is)</small></div>`;
    });
    
    // Sugestões de CEPs
    const ceps = GEO_BASE_LOCATIONS.filter(l => l.cep.includes(search));
    ceps.forEach(loc => {
        const highlighted = loc.cep.replace(new RegExp(`(${search})`, 'gi'), '<strong>$1</strong>');
        html += `<div class="geo-suggestion-item" onclick="geoSelectSearchSuggestion('${loc.cep}')">📮 ${highlighted}<br><small>CEP • ${loc.nome}</small></div>`;
    });
    
    if (html) {
        suggestions.innerHTML = html;
        suggestions.classList.add('active');
    } else {
        suggestions.classList.remove('active');
    }
}

// Selecionar sugestão de busca
function geoSelectSearchSuggestion(nome) {
    document.getElementById('geoSearchInput').value = nome;
    document.getElementById('geoSearchSuggestions').classList.remove('active');
    geoFilterLocations();
}

// Filtrar locais
function geoFilterLocations() {
    const search = document.getElementById('geoSearchInput').value.toLowerCase().trim();
    const suggestions = document.getElementById('geoSearchSuggestions');
    
    // Esconder sugestões
    if (suggestions) suggestions.classList.remove('active');
    
    // Limpar modo verificação se ativo
    if (geoVerifyMode) {
        geoClearVerify();
    }
    
    if (!search) {
        geoLocations = JSON.parse(JSON.stringify(GEO_BASE_LOCATIONS));
    } else {
        geoLocations = GEO_BASE_LOCATIONS.filter(loc => 
            loc.nome.toLowerCase().includes(search) ||
            loc.bairro.toLowerCase().includes(search) ||
            loc.cidade.toLowerCase().includes(search) ||
            loc.estado.toLowerCase().includes(search) ||
            loc.cep.includes(search) ||
            loc.address.toLowerCase().includes(search)
        ).map(loc => JSON.parse(JSON.stringify(loc)));
    }
    
    // Recalcular conflitos
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    geoLocations.forEach(loc => {
        loc.conflicts = geoCheckConflictsLocal(loc.lat, loc.lng, minDist, loc.id);
    });
    
    // Atualizar marcadores
    geoMarkers.forEach(m => m.setMap(null));
    geoCircles.forEach(c => c.setMap(null));
    geoMarkers = [];
    geoCircles = [];
    geoLocations.forEach((loc, i) => geoCreateMarker(loc, i));
    geoUpdateUI();
    
    if (geoLocations.length > 0) {
        geoFitBounds();
    }
}

// Selecionar sugestão
function geoSelectSuggestion(nome) {
    document.getElementById('geoSearchInput').value = nome;
    document.getElementById('geoSuggestions').classList.remove('active');
    geoFilterLocations();
}

// Fechar sugestões ao clicar fora
document.addEventListener('click', function(e) {
    const searchSuggestions = document.getElementById('geoSearchSuggestions');
    const searchInput = document.getElementById('geoSearchInput');
    if (searchSuggestions && !searchSuggestions.contains(e.target) && e.target !== searchInput) {
        searchSuggestions.classList.remove('active');
    }
});

// Marcador temporário para verificação
let geoVerifyMarker = null;
let geoVerifyMode = false;

// Verificar novo endereço
async function geoVerifyAddress() {
    const input = document.getElementById('geoVerifyInput');
    const btn = document.getElementById('geoVerifyBtn');
    const result = document.getElementById('geoVerifyResult');
    let address = input.value.trim();
    
    if (!address) {
        result.innerHTML = '<span class="error">Digite um endereço</span>';
        result.className = 'geo-verify-result error';
        return;
    }
    
    // Adicionar Belo Horizonte como preferência se não especificado
    if (!address.toLowerCase().includes('belo horizonte') && !address.toLowerCase().includes('bh') && !address.toLowerCase().includes(', mg')) {
        address += ', Belo Horizonte, MG';
    }
    
    btn.disabled = true;
    btn.textContent = '...';
    result.innerHTML = 'Buscando endereço...';
    result.className = 'geo-verify-result';
    
    try {
        // Geocodificar o endereço
        const geocodeResult = await new Promise((resolve, reject) => {
            geoGeocoder.geocode({address: address}, (results, status) => {
                if (status === 'OK' && results[0]) {
                    resolve({
                        address: results[0].formatted_address,
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng()
                    });
                } else {
                    reject(new Error('Endereço não encontrado'));
                }
            });
        });
        
        // Remover marcador anterior
        if (geoVerifyMarker) {
            geoVerifyMarker.setMap(null);
        }
        
        // Verificar proximidade com locais da base
        const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
        const nearby = [];
        
        // Resetar locais e calcular distâncias
        geoLocations = JSON.parse(JSON.stringify(GEO_BASE_LOCATIONS));
        
        geoLocations.forEach(loc => {
            const dist = geoCalcDistance(geocodeResult.lat, geocodeResult.lng, loc.lat, loc.lng);
            loc.distToVerify = dist;
            loc.isNearby = dist <= minDist;
            if (loc.isNearby) {
                nearby.push({nome: loc.nome, dist: dist});
            }
        });
        
        // Cor do pin: vermelho neon se há conflito, verde neon se OK
        const pinColor = nearby.length > 0 ? '#ff0055' : '#00e676';
        
        // Adicionar marcador para o endereço verificado com cor fluorescente
        geoVerifyMarker = new google.maps.Marker({
            position: {lat: geocodeResult.lat, lng: geocodeResult.lng},
            map: geoMap,
            title: 'Endereço verificado',
            icon: {
                path: 'M12 0C7.58 0 4 3.58 4 8c0 5.25 8 13 8 13s8-7.75 8-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z',
                fillColor: pinColor,
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                scale: 2.2,
                anchor: new google.maps.Point(12, 21)
            },
            zIndex: 9999
        });
        
        geoVerifyMode = true;
        
        // Atualizar marcadores com cores baseadas na proximidade
        geoMarkers.forEach(m => m.setMap(null));
        geoCircles.forEach(c => c.setMap(null));
        geoMarkers = [];
        geoCircles = [];
        geoLocations.forEach((loc, i) => geoCreateMarkerVerify(loc, i));
        geoUpdateUIVerify();
        
        // Mostrar resultado com endereço encontrado
        let resultHtml = `<div style="font-size:11px;color:var(--txt2);margin-bottom:8px">📍 Encontrado: ${geocodeResult.address}</div>`;
        
        if (nearby.length > 0) {
            nearby.sort((a, b) => a.dist - b.dist);
            resultHtml += `<strong>⚠️ ${nearby.length} local(is) dentro de ${minDist}km!</strong>`;
            result.innerHTML = resultHtml;
            result.className = 'geo-verify-result warning';
        } else {
            // Mostrar o local mais próximo mesmo que fora do raio
            const closest = geoLocations.reduce((a, b) => a.distToVerify < b.distToVerify ? a : b);
            resultHtml += `<strong>✅ Nenhum local dentro de ${minDist}km!</strong>`;
            resultHtml += `<div style="font-size:11px;color:var(--txt2);margin-top:4px">Local mais próximo: ${closest.nome} (${geoFormatDistance(closest.distToVerify)})</div>`;
            result.innerHTML = resultHtml;
            result.className = 'geo-verify-result success';
        }
        
        // Mostrar botão de limpar
        document.getElementById('geoClearVerifyBtn').style.display = 'block';
        
        // Centralizar no endereço verificado com zoom adequado
        geoMap.setCenter({lat: geocodeResult.lat, lng: geocodeResult.lng});
        geoMap.setZoom(15);
        
    } catch (err) {
        result.innerHTML = `<span class="error">❌ ${err.message}</span>`;
        result.className = 'geo-verify-result error';
    }
    
    btn.disabled = false;
    btn.textContent = 'Verificar';
}

// Formatar distância (km ou m)
function geoFormatDistance(distKm) {
    if (distKm >= 1) {
        return distKm.toFixed(1) + ' km';
    } else {
        return Math.round(distKm * 1000) + 'm';
    }
}

// Criar marcador no modo verificação (verde = longe, vermelho = perto)
function geoCreateMarkerVerify(loc, index) {
    const isNearby = loc.isNearby;
    const color = isNearby ? '#cc2936' : '#50c878';
    
    const pinSvg = {
        path: 'M12 0C7.58 0 4 3.58 4 8c0 5.25 8 13 8 13s8-7.75 8-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z',
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2,
        scale: 1.8,
        anchor: new google.maps.Point(12, 21)
    };
    
    const marker = new google.maps.Marker({
        position: {lat: loc.lat, lng: loc.lng},
        map: geoMap,
        title: loc.nome || loc.address,
        icon: pinSvg
    });
    marker.locationId = loc.id;
    geoMarkers.push(marker);
    
    // Círculo de raio
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    const circle = new google.maps.Circle({
        map: geoShowRadius ? geoMap : null,
        center: {lat: loc.lat, lng: loc.lng},
        radius: minDist * 1000,
        fillColor: color,
        fillOpacity: 0.1,
        strokeColor: color,
        strokeOpacity: 0.4,
        strokeWeight: 1
    });
    geoCircles.push(circle);
}

// Atualizar UI no modo verificação
function geoUpdateUIVerify() {
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    const nearby = geoLocations.filter(l => l.isNearby);
    const far = geoLocations.filter(l => !l.isNearby);
    
    // Atualizar estatísticas
    document.getElementById('geoTotal').textContent = geoLocations.length;
    document.getElementById('geoValid').textContent = far.length;
    document.getElementById('geoConflicts').textContent = nearby.length;
    
    // Atualizar lista
    const list = document.getElementById('geoLocsList');
    const countEl = document.getElementById('geoLocsCount');
    countEl.textContent = `${geoLocations.length} locais`;
    
    if (geoLocations.length === 0) {
        list.innerHTML = '<div class="geo-empty"><div class="geo-empty-icon">🗺️</div><p>Nenhum local na base</p></div>';
        return;
    }
    
    // Ordenar: próximos primeiro
    const sorted = [...geoLocations].sort((a, b) => {
        if (a.isNearby && !b.isNearby) return -1;
        if (!a.isNearby && b.isNearby) return 1;
        return (a.distToVerify || 0) - (b.distToVerify || 0);
    });
    
    list.innerHTML = sorted.map((loc, i) => {
        const isNearby = loc.isNearby;
        const distFormatted = geoFormatDistance(loc.distToVerify);
        const statusClass = isNearby ? 'conflict' : 'valid';
        const statusIcon = isNearby ? '⚠️' : '✓';
        const statusText = isNearby ? 'CONFLITO' : 'OK';
        
        return `<div class="geo-loc-card ${statusClass}" onclick="geoFocusVerify(${loc.id})" style="cursor:pointer">
            <div class="geo-loc-marker" style="background:${isNearby ? '#cc2936' : '#50c878'}">${statusIcon}</div>
            <div class="geo-loc-info">
                <div class="geo-loc-name">${loc.nome || 'Sem nome'}</div>
                <div class="geo-loc-address">${loc.address}</div>
            </div>
            <div class="geo-loc-dist">
                <div class="geo-loc-dist-value">${distFormatted}</div>
                <div class="geo-loc-dist-status ${statusClass}">- ${statusText}</div>
            </div>
        </div>`;
    }).join('');
}

// Focar em um local no modo verificação
function geoFocusVerify(id) {
    const loc = geoLocations.find(l => l.id === id);
    if (loc) {
        geoMap.setCenter({lat: loc.lat, lng: loc.lng});
        geoMap.setZoom(17);
    }
}

// Limpar verificação
function geoClearVerify() {
    if (geoVerifyMarker) {
        geoVerifyMarker.setMap(null);
        geoVerifyMarker = null;
    }
    document.getElementById('geoVerifyInput').value = '';
    document.getElementById('geoVerifyResult').innerHTML = '';
    document.getElementById('geoVerifyResult').className = 'geo-verify-result';
    document.getElementById('geoClearVerifyBtn').style.display = 'none';
    geoVerifyMode = false;
    
    // Restaurar visualização normal
    geoLocations = JSON.parse(JSON.stringify(GEO_BASE_LOCATIONS));
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    geoLocations.forEach(loc => {
        loc.conflicts = geoCheckConflictsLocal(loc.lat, loc.lng, minDist, loc.id);
    });
    
    geoMarkers.forEach(m => m.setMap(null));
    geoCircles.forEach(c => c.setMap(null));
    geoMarkers = [];
    geoCircles = [];
    geoLocations.forEach((loc, i) => geoCreateMarker(loc, i));
    geoUpdateUI();
    if (geoLocations.length > 0) geoFitBounds();
}

// Calcular distância entre dois pontos (Haversine)
function geoCalcDistance(lat1, lng1, lat2, lng2) {
    const toRad = x => x * Math.PI / 180;
    const R = 6371; // km
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Mostrar todos os locais e popular filtros
function geoShowAll() {
    // Limpar verificação se estiver ativa
    if (geoVerifyMarker) {
        geoVerifyMarker.setMap(null);
        geoVerifyMarker = null;
    }
    document.getElementById('geoVerifyInput').value = '';
    document.getElementById('geoVerifyResult').innerHTML = '';
    document.getElementById('geoVerifyResult').className = 'geo-verify-result';
    const clearBtn = document.getElementById('geoClearVerifyBtn');
    if (clearBtn) clearBtn.style.display = 'none';
    geoVerifyMode = false;
    
    // Limpar busca
    document.getElementById('geoSearchInput').value = '';
    
    // Resetar filtros
    document.getElementById('geoFilterBairro').value = '';
    document.getElementById('geoFilterCidade').value = '';
    document.getElementById('geoFilterEstado').value = '';
    document.getElementById('geoFilterPais').value = '';
    
    // Carregar todos os locais
    geoLocations = JSON.parse(JSON.stringify(GEO_BASE_LOCATIONS));
    
    // Popular selects de filtro
    geoPopulateFilters();
    
    // Calcular conflitos
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    geoLocations.forEach(loc => {
        loc.conflicts = geoCheckConflictsLocal(loc.lat, loc.lng, minDist, loc.id);
    });
    
    // Atualizar marcadores
    geoMarkers.forEach(m => m.setMap(null));
    geoCircles.forEach(c => c.setMap(null));
    geoMarkers = [];
    geoCircles = [];
    geoLocations.forEach((loc, i) => geoCreateMarker(loc, i));
    geoUpdateUI();
    
    if (geoLocations.length > 0) {
        geoFitBounds();
    }
    
    geoShowToast(`${geoLocations.length} local(is) carregado(s)`, 'success');
}

// Popular selects de filtro com valores únicos
function geoPopulateFilters() {
    const bairros = [...new Set(GEO_BASE_LOCATIONS.map(l => l.bairro).filter(Boolean))].sort();
    const cidades = [...new Set(GEO_BASE_LOCATIONS.map(l => l.cidade).filter(Boolean))].sort();
    const estados = [...new Set(GEO_BASE_LOCATIONS.map(l => l.estado).filter(Boolean))].sort();
    const paises = [...new Set(GEO_BASE_LOCATIONS.map(l => l.pais).filter(Boolean))].sort();
    
    const bairroSelect = document.getElementById('geoFilterBairro');
    const cidadeSelect = document.getElementById('geoFilterCidade');
    const estadoSelect = document.getElementById('geoFilterEstado');
    const paisSelect = document.getElementById('geoFilterPais');
    
    bairroSelect.innerHTML = '<option value="">Todos os Bairros</option>' + bairros.map(b => `<option value="${b}">${b}</option>`).join('');
    cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>' + cidades.map(c => `<option value="${c}">${c}</option>`).join('');
    estadoSelect.innerHTML = '<option value="">Todos os Estados</option>' + estados.map(e => `<option value="${e}">${e}</option>`).join('');
    paisSelect.innerHTML = '<option value="">Todos os Países</option>' + paises.map(p => `<option value="${p}">${p}</option>`).join('');
}

// Aplicar filtros selecionados
function geoApplyFilters() {
    const bairro = document.getElementById('geoFilterBairro').value;
    const cidade = document.getElementById('geoFilterCidade').value;
    const estado = document.getElementById('geoFilterEstado').value;
    const pais = document.getElementById('geoFilterPais').value;
    
    // Filtrar locais
    geoLocations = GEO_BASE_LOCATIONS.filter(loc => {
        if (bairro && loc.bairro !== bairro) return false;
        if (cidade && loc.cidade !== cidade) return false;
        if (estado && loc.estado !== estado) return false;
        if (pais && loc.pais !== pais) return false;
        return true;
    }).map(loc => JSON.parse(JSON.stringify(loc)));
    
    // Calcular conflitos
    const minDist = parseFloat(document.getElementById('geoMinDistance').value) || 0.5;
    geoLocations.forEach(loc => {
        loc.conflicts = geoCheckConflictsLocal(loc.lat, loc.lng, minDist, loc.id);
    });
    
    // Atualizar marcadores
    geoMarkers.forEach(m => m.setMap(null));
    geoCircles.forEach(c => c.setMap(null));
    geoMarkers = [];
    geoCircles = [];
    geoLocations.forEach((loc, i) => geoCreateMarker(loc, i));
    geoUpdateUI();
    
    if (geoLocations.length > 0) {
        geoFitBounds();
    }
}

// Toggle tela cheia do mapa
function geoToggleFullscreen() {
    const mapSection = document.querySelector('.geo-map-section');
    const btn = document.getElementById('geoFullscreenBtn');
    
    mapSection.classList.toggle('fullscreen');
    
    if (mapSection.classList.contains('fullscreen')) {
        btn.textContent = '✕';
        btn.title = 'Sair da tela cheia';
    } else {
        btn.textContent = '⛶';
        btn.title = 'Tela cheia';
    }
    
    // Redimensionar mapa
    setTimeout(() => {
        if (geoMap) {
            google.maps.event.trigger(geoMap, 'resize');
            if (geoMarkers.length > 0) geoFitBounds();
        }
    }, 100);
}

// Sair da tela cheia com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const mapSection = document.querySelector('.geo-map-section');
        if (mapSection && mapSection.classList.contains('fullscreen')) {
            geoToggleFullscreen();
        }
    }
});

// ========== PHOTO MODAL ==========
// ===== FOTOS DE PRODUTOS VIA GOOGLE DRIVE =====
// Pasta "Inverno" contém subpastas: "1ª Cápsula", "2ª Cápsula", etc.
const DRIVE_INVERNO_FOLDER_ID = '1U4BQ-8FnZlACrDSBQKMgnwtNMXOHNV3t';
const DRIVE_API_KEY = geoApiKey;

// Cache de fotos no localStorage
function getPhotoCache() {
    try {
        // Limpar cache v1 antigo
        if (localStorage.getItem('photo-cache')) {
            localStorage.removeItem('photo-cache');
            console.log('[PHOTOS] Cache v1 antigo removido');
        }
        const cache = localStorage.getItem('photo-cache-v2');
        if (cache) {
            const parsed = JSON.parse(cache);
            // Cache válido por 1h (para detectar fotos novas rápido)
            if (parsed.ts && (Date.now() - parsed.ts) < 3600000) {
                return parsed.data;
            }
            console.log('[PHOTOS] Cache v2 expirado, será recarregado');
        }
    } catch(e) {
        console.log('[PHOTOS] Erro ao ler cache:', e);
    }
    return {};
}

function setPhotoCache(data) {
    try {
        localStorage.setItem('photo-cache-v2', JSON.stringify({ ts: Date.now(), data }));
    } catch(e) {}
}

let photoCache = getPhotoCache();

// Buscar fotos de todas as cápsulas
async function loadAllPhotos() {
    // Cache só é válido se tiver pelo menos 10 fotos (evita cache com lixo)
    if (Object.keys(photoCache).length >= 10) {
        console.log('[PHOTOS] Cache válido:', Object.keys(photoCache).length, 'fotos');
        return;
    }
    
    if (Object.keys(photoCache).length > 0) {
        console.log('[PHOTOS] Cache com poucas fotos (' + Object.keys(photoCache).length + '), recarregando...');
        photoCache = {};
    }
    try {
        console.log('[PHOTOS] Buscando fotos de todas as cápsulas...');
        
        // IDs conhecidos das pastas de cápsulas
        const knownFolders = [
            { id: '1GncZpD2wlJBDe-lGpe7TC6UsTx3c2frW', name: '1ª Cápsula' },
            { id: '1BGXAj6Li73C6rDhA7-Kk1g-TpnD7KAfr', name: '2ª Cápsula' },
            { id: '1ai8ld7H1fgIGRr0lXaQf0wFCtorT3H3q', name: '3ª Cápsula' },
            { id: '1uABK9gd2jrwNosCb6RFSsdPSR8apfMrU', name: '4ª Cápsula' },
            { id: '1AbZ1htTR8gB64UyZovkx9K6Q3tM5xxel', name: '5ª Cápsula' }
        ];
        
        // Tentar descobrir subpastas automaticamente
        let autoFolders = [];
        try {
            const folderQuery = encodeURIComponent(`'${DRIVE_INVERNO_FOLDER_ID}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`);
            const foldersUrl = `https://www.googleapis.com/drive/v3/files?q=${folderQuery}&fields=files(id,name)&key=${DRIVE_API_KEY}`;
            const foldersResp = await fetch(foldersUrl);
            if (foldersResp.ok) {
                const foldersData = await foldersResp.json();
                autoFolders = (foldersData.files || []).map(f => ({ id: f.id, name: f.name }));
                console.log('[PHOTOS] Subpastas auto-descobertas:', autoFolders.map(f => f.name));
            }
        } catch(e) {
            console.log('[PHOTOS] Auto-descoberta falhou:', e.message);
        }
        
        // Mesclar: auto-descobertas + conhecidas (sem duplicatas)
        const knownIds = new Set(knownFolders.map(f => f.id));
        const folderIds = [...knownFolders];
        for (const af of autoFolders) {
            if (!knownIds.has(af.id)) {
                folderIds.push(af);
            }
        }
        console.log('[PHOTOS] Total de pastas a buscar:', folderIds.map(f => f.name));
        
        // Buscar fotos de cada pasta
        const cache = {};
        for (const folder of folderIds) {
            let pageToken = '';
            let folderCount = 0;
            do {
                const fileQuery = encodeURIComponent(`'${folder.id}' in parents and trashed=false and mimeType contains 'image/'`);
                let url = `https://www.googleapis.com/drive/v3/files?q=${fileQuery}&fields=files(id,name),nextPageToken&pageSize=1000&key=${DRIVE_API_KEY}`;
                if (pageToken) url += `&pageToken=${pageToken}`;
                const resp = await fetch(url);
                if (!resp.ok) {
                    console.error('[PHOTOS] Erro pasta "' + folder.name + '":', resp.status, await resp.text());
                    break;
                }
                const data = await resp.json();
                (data.files || []).forEach(f => {
                    const ref = f.name.replace(/\.[^.]+$/, '').toUpperCase();
                    cache[ref] = f.id;
                    folderCount++;
                });
                pageToken = data.nextPageToken || '';
            } while (pageToken);
            console.log('[PHOTOS] Pasta "' + folder.name + '": ' + folderCount + ' fotos');
        }
        
        if (Object.keys(cache).length > 0) {
            photoCache = cache;
            setPhotoCache(cache);
            console.log('[PHOTOS] Cache carregado:', Object.keys(cache).length, 'fotos no total');
        } else {
            console.warn('[PHOTOS] Nenhuma foto encontrada! Verificar compartilhamento das pastas.');
        }
    } catch(e) {
        console.error('[PHOTOS] Erro ao carregar fotos:', e);
    }
}

// Forçar recarregamento do cache (usado no pull-to-refresh)
async function reloadPhotos() {
    localStorage.removeItem('photo-cache-v2');
    photoCache = {};
    await loadAllPhotos();
}

// Iniciar carregamento ao abrir o app (não bloqueia)
(async function() {
    console.log('[PHOTOS] Iniciando sistema de fotos v4.3.0...');
    console.log('[PHOTOS] API Key:', DRIVE_API_KEY ? 'presente' : 'AUSENTE');
    console.log('[PHOTOS] Pasta Inverno:', DRIVE_INVERNO_FOLDER_ID);
    try {
        await loadAllPhotos();
    } catch(e) {
        console.error('[PHOTOS] Erro fatal ao carregar fotos:', e);
    }
})();

function getPhotoUrl(ref) {
    const fileId = photoCache[ref.toUpperCase()];
    if (fileId) {
        return `https://lh3.googleusercontent.com/d/${fileId}=s1200`;
    }
    return null;
}

function openPhoto(ref, desc){
    const modal = document.getElementById('photo-modal');
    const img = document.getElementById('photo-modal-img');
    const noimg = document.getElementById('photo-modal-noimg');
    const refEl = document.getElementById('photo-modal-ref');
    const descEl = document.getElementById('photo-modal-desc');
    
    refEl.textContent = ref;
    descEl.textContent = desc;
    
    const photoUrl = getPhotoUrl(ref);
    if(photoUrl){
        img.src = photoUrl;
        img.style.display = 'block';
        noimg.style.display = 'none';
        img.onerror = function() {
            img.style.display = 'none';
            noimg.style.display = 'block';
            noimg.textContent = '📷 Erro ao carregar foto';
        };
    } else {
        img.style.display = 'none';
        noimg.style.display = 'block';
        noimg.textContent = '📷 Foto não encontrada';
    }
    
    modal.classList.add('active');
    // Push state para o botão voltar nativo fechar a foto
    history.pushState({photo: true}, '', '');
}

function closePhoto(fromPopstate){
    const modal = document.getElementById('photo-modal');
    if(!modal.classList.contains('active')) return;
    modal.classList.remove('active');
    const img = document.getElementById('photo-modal-img');
    img.style.transform = '';
    _photoZoom = {scale:1, x:0, y:0};
    // Se não veio do popstate, consumir o pushState do openPhoto
    if(!fromPopstate){
        _handlingPop = true;
        history.back();
        setTimeout(function(){ _handlingPop = false; }, 200);
    }
}

// ===== PINCH-TO-ZOOM NA FOTO =====
let _photoZoom = {scale:1, x:0, y:0};
let _photoTouch = {startDist:0, startScale:1, startX:0, startY:0, lastX:0, lastY:0, isPinching:false, isDragging:false};

function _getTouchDist(t1, t2){
    return Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
}

function _getTouchCenter(t1, t2){
    return {x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2};
}

function _applyPhotoTransform(){
    const img = document.getElementById('photo-modal-img');
    img.style.transform = `translate(${_photoZoom.x}px, ${_photoZoom.y}px) scale(${_photoZoom.scale})`;
}

function _initPhotoZoom(){
    const modal = document.getElementById('photo-modal');
    if(!modal) return;

    modal.addEventListener('click', function(e){
        if(e.target === this && !_photoTouch.isPinching && !_photoTouch.isDragging) closePhoto();
    });

    modal.addEventListener('touchstart', function(e){
        if(e.touches.length === 2){
            e.preventDefault();
            _photoTouch.isPinching = true;
            _photoTouch.startDist = _getTouchDist(e.touches[0], e.touches[1]);
            _photoTouch.startScale = _photoZoom.scale;
            const c = _getTouchCenter(e.touches[0], e.touches[1]);
            _photoTouch.startX = c.x - _photoZoom.x;
            _photoTouch.startY = c.y - _photoZoom.y;
        } else if(e.touches.length === 1 && _photoZoom.scale > 1){
            _photoTouch.isDragging = true;
            _photoTouch.lastX = e.touches[0].clientX;
            _photoTouch.lastY = e.touches[0].clientY;
        }
    }, {passive: false});

    modal.addEventListener('touchmove', function(e){
        if(e.touches.length === 2 && _photoTouch.isPinching){
            e.preventDefault();
            const dist = _getTouchDist(e.touches[0], e.touches[1]);
            let newScale = _photoTouch.startScale * (dist / _photoTouch.startDist);
            newScale = Math.max(1, Math.min(newScale, 5));
            _photoZoom.scale = newScale;
            const c = _getTouchCenter(e.touches[0], e.touches[1]);
            _photoZoom.x = c.x - _photoTouch.startX;
            _photoZoom.y = c.y - _photoTouch.startY;
            _applyPhotoTransform();
        } else if(e.touches.length === 1 && _photoTouch.isDragging && _photoZoom.scale > 1){
            e.preventDefault();
            const dx = e.touches[0].clientX - _photoTouch.lastX;
            const dy = e.touches[0].clientY - _photoTouch.lastY;
            _photoZoom.x += dx;
            _photoZoom.y += dy;
            _photoTouch.lastX = e.touches[0].clientX;
            _photoTouch.lastY = e.touches[0].clientY;
            _applyPhotoTransform();
        }
    }, {passive: false});

    modal.addEventListener('touchend', function(e){
        if(e.touches.length < 2) _photoTouch.isPinching = false;
        if(e.touches.length === 0){
            _photoTouch.isDragging = false;
            if(_photoZoom.scale <= 1){
                _photoZoom = {scale:1, x:0, y:0};
                _applyPhotoTransform();
            }
        }
    });

    // Double tap para zoom rápido
    let _lastTap = 0;
    modal.addEventListener('touchend', function(e){
        if(e.target.classList.contains('photo-modal-close')) return;
        const now = Date.now();
        if(now - _lastTap < 300 && e.changedTouches.length === 1){
            e.preventDefault();
            if(_photoZoom.scale > 1){
                _photoZoom = {scale:1, x:0, y:0};
            } else {
                _photoZoom.scale = 2.5;
                const rect = document.getElementById('photo-modal-img').getBoundingClientRect();
                const tx = e.changedTouches[0].clientX;
                const ty = e.changedTouches[0].clientY;
                _photoZoom.x = (rect.left + rect.width/2 - tx) * 1.5;
                _photoZoom.y = (rect.top + rect.height/2 - ty) * 1.5;
            }
            _applyPhotoTransform();
        }
        _lastTap = now;
    });
    
    console.log('[PHOTOS] Pinch-to-zoom inicializado');
}
</script>

<!-- PHOTO MODAL -->
<div class="photo-modal" id="photo-modal">
    <button class="photo-modal-close" onclick="closePhoto()">✕</button>
    <img class="photo-modal-img" id="photo-modal-img" src="" alt="Foto do produto">
    <div class="photo-modal-noimg" id="photo-modal-noimg" style="display:none"></div>
    <div class="photo-modal-info">
        <div class="photo-modal-ref" id="photo-modal-ref"></div>
        <div class="photo-modal-desc" id="photo-modal-desc"></div>
    </div>
</div>
<script>_initPhotoZoom();</script>

<!-- Debug Panel -->
<button class="debug-toggle" id="debug-toggle" onclick="toggleDebugPanel()">🐛</button>
<div class="debug-panel" id="debug-panel">
    <div class="debug-header" id="debug-header">
        <span>🐛 Debug Console</span>
        <div class="debug-header-buttons">
            <button onclick="clearDebugLogs()">Limpar</button>
            <button class="close-btn" onclick="closeDebugPanel()">✕</button>
        </div>
    </div>
    <div class="debug-logs" id="debug-logs"></div>
</div>

<script>
// =====================================================
// DEBUG MODE - Ativado pressionando ⚙️ por 5 segundos
// =====================================================
let debugPressTimer = null;
let debugModeEnabled = false;

function startDebugPress() {
    debugPressTimer = setTimeout(function() {
        enableDebugMode();
    }, 5000);
}

function endDebugPress() {
    if (debugPressTimer) {
        clearTimeout(debugPressTimer);
        debugPressTimer = null;
    }
}

function enableDebugMode() {
    debugModeEnabled = true;
    document.getElementById('debug-toggle').classList.add('visible');
    if (navigator.vibrate) navigator.vibrate(200);
    alert('🐛 Debug Mode Ativado!\n\nO modo debug será desativado ao fechar o app.');
    console.log('[Debug] Modo debug ativado');
}

function disableDebugMode() {
    debugModeEnabled = false;
    document.getElementById('debug-toggle').classList.remove('visible');
    document.getElementById('debug-panel').classList.remove('active');
}

document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && debugModeEnabled) {
        disableDebugMode();
    }
});

let debugDragging = false;
let debugDragOffsetY = 0;

function initDebugDrag() {
    const panel = document.getElementById('debug-panel');
    const header = document.getElementById('debug-header');
    
    header.addEventListener('touchstart', (e) => {
        debugDragging = true;
        debugDragOffsetY = e.touches[0].clientY - panel.getBoundingClientRect().top;
    }, { passive: true });
    
    document.addEventListener('touchmove', (e) => {
        if (!debugDragging) return;
        const newTop = e.touches[0].clientY - debugDragOffsetY;
        const maxTop = window.innerHeight - 100;
        panel.style.top = Math.max(50, Math.min(newTop, maxTop)) + 'px';
        panel.style.bottom = 'auto';
    }, { passive: true });
    
    document.addEventListener('touchend', () => { debugDragging = false; });
}

initDebugDrag();

function toggleDebugPanel() {
    document.getElementById('debug-panel').classList.toggle('active');
}

function closeDebugPanel() {
    document.getElementById('debug-panel').classList.remove('active');
}

// Interceptar console.log para mostrar no painel
(function() {
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    function addDebugLog(msg, type = 'log') {
        const logsDiv = document.getElementById('debug-logs');
        if (!logsDiv) return;
        
        const time = new Date().toLocaleTimeString('pt-BR');
        const div = document.createElement('div');
        div.className = 'debug-log ' + type;
        
        let text = '';
        for (let i = 0; i < arguments.length - 1; i++) {
            const arg = arguments[i];
            if (typeof arg === 'object') {
                try { text += JSON.stringify(arg, null, 2) + ' '; }
                catch(e) { text += String(arg) + ' '; }
            } else {
                text += String(arg) + ' ';
            }
        }
        
        div.textContent = `[${time}] ${text}`;
        logsDiv.appendChild(div);
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }
    
    console.log = function() {
        originalLog.apply(console, arguments);
        addDebugLog.apply(null, [...arguments, 'log']);
    };
    
    console.error = function() {
        originalError.apply(console, arguments);
        addDebugLog.apply(null, [...arguments, 'error']);
    };
    
    console.warn = function() {
        originalWarn.apply(console, arguments);
        addDebugLog.apply(null, [...arguments, 'warn']);
    };
    
    // Capturar erros globais
    window.onerror = function(msg, url, line) {
        addDebugLog(`ERROR: ${msg} (linha ${line})`, 'error');
    };
    
    window.onunhandledrejection = function(e) {
        addDebugLog(`PROMISE ERROR: ${e.reason}`, 'error');
    };
})();

function clearDebugLogs() {
    document.getElementById('debug-logs').innerHTML = '';
}

// =====================================================
// BUSCA DE REFERÊNCIAS
// =====================================================
function filtrarReferencias(termo) {
    var clearBtn = document.getElementById('ref-search-clear');
    if (clearBtn) clearBtn.classList.toggle('visible', termo.length > 0);
    
    // Pegar todos os cards de expedição
    var items = document.querySelectorAll('.exp-item');
    
    if (!termo || termo.trim() === '') {
        // Mostrar todos
        items.forEach(function(item) {
            item.style.display = '';
        });
        return;
    }
    
    // Normalizar termo (minúsculo e sem espaços extras)
    termo = termo.toLowerCase().trim();
    var primeiroMatch = null;
    
    items.forEach(function(item) {
        // Pegar referência e descrição do card
        var refEl = item.querySelector('.exp-item-ref');
        var descEl = item.querySelector('.exp-item-name');
        var corEl = item.querySelector('.exp-item-cor');
        
        var refText = refEl ? refEl.textContent.toLowerCase() : '';
        var descText = descEl ? descEl.textContent.toLowerCase() : '';
        var corText = corEl ? corEl.textContent.toLowerCase() : '';
        
        // Verificar se o termo está em algum campo
        if (refText.includes(termo) || descText.includes(termo) || corText.includes(termo)) {
            item.style.display = '';
            if (!primeiroMatch) primeiroMatch = item;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Scroll até o primeiro resultado encontrado
    if (primeiroMatch) {
        setTimeout(function() {
            primeiroMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            primeiroMatch.classList.add('highlight');
            setTimeout(function() { 
                primeiroMatch.classList.remove('highlight'); 
            }, 2000);
        }, 100);
    }
}

function limparBuscaReferencia() {
    var input = document.getElementById('ref-search');
    if (input) {
        input.value = '';
        filtrarReferencias('');
    }
    input.focus();
}

// =====================================================
// TOGGLE VIEW REFERÊNCIAS (agrupa cards por ref)
// =====================================================
window.viewModeReferencias = false;
window.viewModeCores = false;
window.selectedCores = new Set();
window.selectedGrupos = new Set();

// Mapa de prefixo da referência → nome do grupo
const GRUPOS_MAP = {
    'AC': 'Acessório',
    'BD': 'Body',
    'BL': 'Blusa',
    'BZ': 'Blazer',
    'CA': 'Camisa',
    'CJ': 'Conjunto',
    'CL': 'Calça',
    'CO': 'Colete',
    'JA': 'Jaqueta',
    'JQ': 'Jaqueta',
    'MA': 'Macaquinho',
    'MC': 'Macaquinho',
    'SA': 'Saia',
    'SH': 'Short',
    'VE': 'Vestido',
    'TR': 'Tricot',
    'CR': 'Cropped',
    'RE': 'Regata',
    'TO': 'Top',
    'PA': 'Pantalona',
    'MI': 'Macacão',
    'BO': 'Bolsa'
};

function getGrupo(ref) {
    if (!ref) return 'Outros';
    const prefixo = ref.substring(0, 2).toUpperCase();
    return GRUPOS_MAP[prefixo] || 'Outros';
}

function toggleViewReferencias() {
    console.log('[Toggle] Clicou em Referências');
    window.viewModeReferencias = !window.viewModeReferencias;
    window.selectedGrupos.clear();
    
    // Desativar modo cores se ativar referências
    if (window.viewModeReferencias) {
        window.viewModeCores = false;
        window.selectedCores.clear();
        const btnCor = document.getElementById('stat-variantes');
        if (btnCor) btnCor.classList.remove('active');
        document.getElementById('exp-cores-list').classList.remove('visible');
    }
    
    const btnRef = document.getElementById('stat-referencias');
    if (btnRef) btnRef.classList.toggle('active', window.viewModeReferencias);
    
    // Mostrar/esconder lista de grupos
    const gruposList = document.getElementById('exp-grupos-list');
    if (window.viewModeReferencias) {
        renderGruposList();
        gruposList.classList.add('visible');
    } else {
        gruposList.classList.remove('visible');
    }
    
    try {
        renderListaCards();
    } catch(e) {
        console.error('[Toggle] Erro ao renderizar:', e);
    }
}

function toggleViewCores() {
    console.log('[Toggle] Clicou em Variantes de Cor');
    window.viewModeCores = !window.viewModeCores;
    window.selectedCores.clear();
    
    // Desativar modo referências se ativar cores
    if (window.viewModeCores) {
        window.viewModeReferencias = false;
        window.selectedGrupos.clear();
        const btnRef = document.getElementById('stat-referencias');
        if (btnRef) btnRef.classList.remove('active');
        document.getElementById('exp-grupos-list').classList.remove('visible');
    }
    
    const btnCor = document.getElementById('stat-variantes');
    if (btnCor) btnCor.classList.toggle('active', window.viewModeCores);
    
    // Mostrar/esconder lista de cores
    const coresList = document.getElementById('exp-cores-list');
    if (window.viewModeCores) {
        renderCoresList();
        coresList.classList.add('visible');
    } else {
        coresList.classList.remove('visible');
    }
    
    try {
        renderListaCards();
    } catch(e) {
        console.error('[Toggle] Erro ao renderizar:', e);
    }
}

function renderCoresList() {
    const itemsParaLista = window.currentItemsParaLista || [];
    
    // Contar referências por cor
    const coresMap = new Map();
    for (const item of itemsParaLista) {
        const cor = item.cor || 'SEM COR';
        if (!coresMap.has(cor)) {
            coresMap.set(cor, 0);
        }
        coresMap.set(cor, coresMap.get(cor) + 1);
    }
    
    // Ordenar por nome da cor
    const coresOrdenadas = Array.from(coresMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    
    let html = '';
    for (const [cor, count] of coresOrdenadas) {
        const isActive = window.selectedCores.has(cor);
        const corEscaped = cor.replace(/'/g, "\\'");
        html += `<div class="exp-cor-pill ${isActive ? 'active' : ''}" onclick="selecionarCor('${corEscaped}')">${cor}<span class="cor-count">(${count})</span></div>`;
    }
    
    document.getElementById('exp-cores-list').innerHTML = html;
}

function selecionarCor(cor) {
    if (window.selectedCores.has(cor)) {
        window.selectedCores.delete(cor);
    } else {
        window.selectedCores.add(cor);
    }
    
    renderCoresList();
    renderListaCards();
}

function renderGruposList() {
    const itemsParaLista = window.currentItemsParaLista || [];
    
    // Contar referências únicas por grupo
    const gruposMap = new Map();
    const refsVistas = new Set();
    
    for (const item of itemsParaLista) {
        const grupo = getGrupo(item.ref);
        if (!gruposMap.has(grupo)) {
            gruposMap.set(grupo, 0);
        }
        // Contar refs únicas, não variantes de cor
        if (!refsVistas.has(item.ref)) {
            refsVistas.add(item.ref);
            gruposMap.set(grupo, gruposMap.get(grupo) + 1);
        }
    }
    
    // Ordenar por nome do grupo
    const gruposOrdenados = Array.from(gruposMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    
    let html = '';
    for (const [grupo, count] of gruposOrdenados) {
        const isActive = window.selectedGrupos.has(grupo);
        const grupoEscaped = grupo.replace(/'/g, "\\'");
        html += `<div class="exp-cor-pill ${isActive ? 'active' : ''}" onclick="selecionarGrupo('${grupoEscaped}')">${grupo}<span class="cor-count">(${count})</span></div>`;
    }
    
    document.getElementById('exp-grupos-list').innerHTML = html;
}

function selecionarGrupo(grupo) {
    if (window.selectedGrupos.has(grupo)) {
        window.selectedGrupos.delete(grupo);
    } else {
        window.selectedGrupos.add(grupo);
    }
    
    renderGruposList();
    renderListaCards();
}

function renderListaCards() {
    const destino = window.currentDestino;
    const itemsParaLista = window.currentItemsParaLista || [];
    
    console.log('[RenderCards] Destino:', destino, 'Items:', itemsParaLista.length);
    
    if (!destino || itemsParaLista.length === 0) {
        console.log('[RenderCards] Sem dados para renderizar');
        return;
    }
    
    let itemsToRender = [];
    
    if (window.viewModeReferencias) {
        // MODO REFERÊNCIAS: agrupar por ref
        const refsMap = new Map();
        
        for (const item of itemsParaLista) {
            const p = item.prod || {};
            const e = item.envShow || {};
            
            if (!refsMap.has(item.ref)) {
                refsMap.set(item.ref, {
                    ref: item.ref,
                    desc: item.desc || '',
                    cor: null,
                    coresCount: 1,
                    prod: { PP: p.PP||0, P: p.P||0, M: p.M||0, G: p.G||0, GG: p.GG||0 },
                    envShow: { PP: e.PP||0, P: e.P||0, M: e.M||0, G: e.G||0, GG: e.GG||0 }
                });
            } else {
                const existing = refsMap.get(item.ref);
                existing.coresCount++;
                existing.prod.PP += p.PP||0;
                existing.prod.P += p.P||0;
                existing.prod.M += p.M||0;
                existing.prod.G += p.G||0;
                existing.prod.GG += p.GG||0;
                existing.envShow.PP += e.PP||0;
                existing.envShow.P += e.P||0;
                existing.envShow.M += e.M||0;
                existing.envShow.G += e.G||0;
                existing.envShow.GG += e.GG||0;
            }
        }
        
        itemsToRender = Array.from(refsMap.values()).sort((a, b) => a.ref.localeCompare(b.ref));
    } else {
        // MODO NORMAL: mostrar todas as variantes
        itemsToRender = itemsParaLista;
    }
    
    // Filtrar por cores selecionadas (se no modo cores)
    if (window.viewModeCores && window.selectedCores.size > 0) {
        itemsToRender = itemsToRender.filter(item => window.selectedCores.has(item.cor || 'SEM COR'));
    }
    
    // Filtrar por grupos selecionados (se no modo referências)
    if (window.viewModeReferencias && window.selectedGrupos.size > 0) {
        itemsToRender = itemsToRender.filter(item => window.selectedGrupos.has(getGrupo(item.ref)));
    }
    
    console.log('[RenderCards] Itens a renderizar:', itemsToRender.length);
    
    // Renderizar cards
    let html = '';
    for (const item of itemsToRender) {
        const p = item.prod || {};
        const e = item.envShow || {};
        const totalP = (p.PP||0)+(p.P||0)+(p.M||0)+(p.G||0);
        const totalE = (e.PP||0)+(e.P||0)+(e.M||0)+(e.G||0);
        
        if(totalP === 0) continue;
        
        let metaItem = 0, envItem = 0;
        if(destino === 'showroom'){
            const ecommTams = ['PP','P','M','G'].filter(t => p[t] > 0).length;
            const isabellaQty = p.P > 0 ? 1 : 0;
            metaItem = totalP - ecommTams - isabellaQty;
            envItem = totalE;
        } else if(destino === 'ecommerce'){
            metaItem = ['PP','P','M','G'].filter(t => p[t] > 0).length;
            envItem = totalE;
        } else if(destino === 'mostruario'){
            metaItem = p.P > 0 ? 1 : (['PP','M','G'].find(t => p[t] > 0) ? 1 : 0);
            envItem = totalE;
        }
        
        const pctItem = metaItem > 0 ? ((envItem / metaItem) * 100).toFixed(0) : 0;
        const colorItem = pctItem >= 100 ? 'green' : 'blue';
        
        // Tamanhos
        let tamanhos = '';
        if(destino === 'showroom'){
            tamanhos = ['PP','P','M','G'].filter(t => p[t] > 0).map(t => {
                const prod = p[t] || 0;
                const env = e[t] || 0;
                const meta = prod - 1 - (t === 'P' ? 1 : 0);
                const pct = meta > 0 ? Math.min((env/meta)*100, 100) : 0;
                const col = env >= meta ? 'green' : 'blue';
                return '<div class="exp-tam-row"><span class="exp-tam-label">'+t+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/'+meta+'</span></div>';
            }).join('');
        } else if(destino === 'ecommerce'){
            tamanhos = ['PP','P','M','G'].filter(t => p[t] > 0).map(t => {
                const env = e[t] || 0;
                const pct = env >= 1 ? 100 : 0;
                const col = env >= 1 ? 'green' : 'blue';
                return '<div class="exp-tam-row"><span class="exp-tam-label">'+t+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/1</span></div>';
            }).join('');
        } else if(destino === 'mostruario'){
            const tamEsperado = p.P > 0 ? 'P' : ['PP','M','G'].find(t => p[t] > 0) || null;
            if(tamEsperado){
                const env = e[tamEsperado] || 0;
                const pct = env >= 1 ? 100 : 0;
                const col = env >= 1 ? 'green' : 'blue';
                tamanhos = '<div class="exp-tam-row"><span class="exp-tam-label">'+tamEsperado+'</span><div class="exp-tam-bar"><div class="exp-tam-fill '+col+'" style="width:'+pct+'%"></div></div><span class="exp-tam-val">'+env+'/1</span></div>';
            }
        }
        
        const descEscaped = (item.desc || '').replace(/'/g, "\\'");
        
        // Cor ou contagem de cores
        let corHtml = '';
        if (window.viewModeReferencias && item.coresCount) {
            corHtml = '<div class="exp-item-cor">🎨 ' + item.coresCount + ' ' + (item.coresCount === 1 ? 'cor' : 'cores') + '</div>';
        } else if (item.cor) {
            corHtml = '<div class="exp-item-cor">🎨 ' + item.cor + '</div>';
        }
        
        html += '<div class="exp-item" onclick="openPhoto(\''+item.ref+'\',\''+descEscaped+'\')"><div class="exp-item-header"><div><div class="exp-item-ref">'+item.ref+' <span style="font-weight:400;color:var(--txt2);font-size:11px">('+totalP+' pçs)</span></div><div class="exp-item-name">'+(item.desc || '')+'</div>'+corHtml+'</div><div class="exp-item-badge" style="color:var(--'+colorItem+')">'+pctItem+'%</div></div><div class="exp-tamanhos-grid">'+tamanhos+'</div></div>';
    }
    
    document.getElementById('exp-items-list').innerHTML = html;
    console.log('[RenderCards] Renderizado com sucesso');
}

// =====================================================
// GESTÃO DE USUÁRIOS (Admin)
// =====================================================
let usersData = [];

function backFromUsers() {
    goBackTo('changepw-screen');
}

async function openUsers() {
    hideAll();
    document.getElementById('users-screen').classList.add('active');
    pushState('users-screen');
    
    // Garantir que nosso heartbeat foi enviado antes de carregar
    await sendHeartbeatNow();
    
    await loadUsers();
    await loadActiveSessions();
}

// Sessões ativas
let activeSessions = {};

async function loadActiveSessions() {
    try {
        console.log('[Sessions] Buscando sessões ativas...');
        const response = await fetch(`${API_CONFIG.baseUrl}/sessions/active`, {
            headers: { 'X-API-Key': API_CONFIG.apiKey }
        });
        console.log('[Sessions] Response status:', response.status);
        const data = await response.json();
        console.log('[Sessions] Dados recebidos:', JSON.stringify(data));
        activeSessions = data.sessions || {};
        console.log('[Sessions] Sessões ativas:', data.count, 'IDs:', Object.keys(activeSessions));
        renderUsers(); // Re-renderizar com status online
    } catch (e) {
        console.log('[Sessions] Erro ao carregar sessões:', e.message);
    }
}

async function kickUser(userId, nome) {
    if (!confirm(`Deseja desconectar ${nome} (@${userId})?\n\nO usuário será forçado a fazer login novamente.`)) return;
    
    try {
        console.log('[Kick] Derrubando usuário:', userId);
        const response = await fetch(`${API_CONFIG.baseUrl}/sessions/kick`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-API-Key': API_CONFIG.apiKey 
            },
            body: JSON.stringify({ userId })
        });
        
        const data = await response.json();
        console.log('[Kick] Resposta:', response.status, JSON.stringify(data));
        
        if (data.success) {
            alert(`✅ ${nome} foi desconectado! O usuário será removido em até 10 segundos.`);
            await loadActiveSessions();
        } else {
            alert(`❌ Erro: ${data.error || 'Resposta inesperada do servidor'}`);
        }
    } catch (e) {
        console.log('[Kick] Erro:', e.message);
        alert(`❌ Erro: ${e.message}`);
    }
}

// Heartbeat - envia a cada 2 minutos para registrar que está online
let heartbeatInterval = null;

function startHeartbeat() {
    if (heartbeatInterval) return;
    
    const sendHeartbeat = async () => {
        if (!currentUser) {
            console.log('[Heartbeat] Sem usuário logado');
            return;
        }
        try {
            console.log('[Heartbeat] Enviando para:', currentUser);
            const resp = await fetch(`${API_CONFIG.baseUrl}/sessions/heartbeat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-API-Key': API_CONFIG.apiKey },
                body: JSON.stringify({ userId: currentUser })
            });
            console.log('[Heartbeat] Resposta:', resp.status);
        } catch (e) {
            console.log('[Heartbeat] Erro:', e.message);
        }
    };
    
    sendHeartbeat(); // Enviar imediatamente
    heartbeatInterval = setInterval(sendHeartbeat, 2 * 60 * 1000); // A cada 2 minutos
}

// Função para enviar heartbeat avulso (usado ao abrir gestão)
async function sendHeartbeatNow() {
    if (!currentUser) return;
    try {
        console.log('[Heartbeat] Enviando heartbeat agora para:', currentUser);
        const resp = await fetch(`${API_CONFIG.baseUrl}/sessions/heartbeat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-API-Key': API_CONFIG.apiKey },
            body: JSON.stringify({ userId: currentUser })
        });
        const data = await resp.json();
        console.log('[Heartbeat] Resposta:', resp.status, JSON.stringify(data));
    } catch (e) {
        console.log('[Heartbeat] Erro:', e.message);
    }
}

function stopHeartbeat() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}

// Verificar se foi derrubado - a cada 30 segundos
let kickCheckInterval = null;

function startKickCheck() {
    if (kickCheckInterval) return;
    
    const checkKick = async () => {
        if (!currentUser) return;
        try {
            const response = await fetch(`${API_CONFIG.baseUrl}/sessions/check-kick?userId=${currentUser}`);
            const data = await response.json();
            console.log('[KickCheck] Verificação:', JSON.stringify(data));
            
            if (data.kicked) {
                stopKickCheck();
                stopHeartbeat();
                alert('⚠️ Você foi desconectado pelo administrador.');
                doLogout();
            }
        } catch (e) {
            console.log('[KickCheck] Erro:', e.message);
        }
    };
    
    checkKick(); // Verificar imediatamente
    kickCheckInterval = setInterval(checkKick, 10 * 1000); // A cada 10 segundos
}

function stopKickCheck() {
    if (kickCheckInterval) {
        clearInterval(kickCheckInterval);
        kickCheckInterval = null;
    }
}

async function loadUsers() {
    const listEl = document.getElementById('users-list');
    listEl.innerHTML = '<div class="users-loading">Carregando...</div>';
    
    // Garantir que temos o usuário atual
    let userId = currentUser;
    if (!userId) {
        userId = sessionStorage.getItem('logged-user');
        console.log('[Users] currentUser vazio, usando sessionStorage:', userId);
    }
    
    console.log('[Users] Carregando usuários...');
    console.log('[Users] userId para requisição:', userId);
    console.log('[Users] API Key:', API_CONFIG.apiKey ? 'presente' : 'AUSENTE');
    console.log('[Users] URL:', `${API_CONFIG.baseUrl}/api/users`);
    
    if (!userId) {
        listEl.innerHTML = '<div class="users-loading" style="color:var(--red)">Erro: Usuário não identificado. Faça login novamente.</div>';
        return;
    }
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const response = await fetch(`${API_CONFIG.baseUrl}/api/users`, {
            headers: { 
                'X-API-Key': API_CONFIG.apiKey,
                'X-User-Id': userId
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('[Users] Response status:', response.status);
        
        const data = await response.json();
        console.log('[Users] Resposta:', data);
        
        if (data.error) {
            listEl.innerHTML = `<div class="users-loading" style="color:var(--red)">${data.error}</div>`;
            return;
        }
        
        usersData = data.users || [];
        renderUsers();
    } catch (e) {
        console.error('[Users] Erro:', e);
        let errorMsg = 'Erro ao carregar usuários';
        if (e.name === 'AbortError') {
            errorMsg = 'Tempo limite excedido. Verifique sua conexão.';
        } else if (e.message.includes('fetch')) {
            errorMsg = 'Erro de conexão. Verifique se o servidor está acessível.';
        } else {
            errorMsg = e.message;
        }
        listEl.innerHTML = `<div class="users-loading" style="color:var(--red)">${errorMsg}</div>`;
    }
}

function renderUsers() {
    const listEl = document.getElementById('users-list');
    
    if (usersData.length === 0) {
        listEl.innerHTML = '<div class="users-loading">Nenhum usuário cadastrado</div>';
        return;
    }
    
    const html = usersData.map(user => {
        const accessTags = (user.access || []).map(a => {
            const icons = { comercial: '📊', estoque: '📦', compras: '🛒', financeiro: '💰', usuarios: '👥' };
            return `<span class="user-card-tag">${icons[a] || ''} ${a}</span>`;
        }).join('');
        
        const channelTags = (user.channels || []).map(c => {
            const icons = { showroom: '🏬', ecommerce: '🌐', mostruario: '👗', ld: '📋' };
            return `<span class="user-card-tag">${icons[c] || ''} ${c}</span>`;
        }).join('');
        
        const isCurrentUser = user.id === currentUser;
        const isOnline = activeSessions[user.id];
        const onlineInfo = isOnline ? `<span class="user-online-badge">🟢 Online${isOnline.minutesAgo > 0 ? ` (${isOnline.minutesAgo}min)` : ''}</span>` : '<span class="user-offline-badge">⚫ Offline</span>';
        
        return `
            <div class="user-card">
                <div class="user-card-header">
                    <div class="user-card-info">
                        <div class="user-card-nome">${user.nome}${isCurrentUser ? ' (você)' : ''} ${onlineInfo}</div>
                        <div class="user-card-id">@${user.id}</div>
                    </div>
                    <span class="user-card-badge ${user.role}">${user.role === 'admin' ? 'Admin' : 'Usuário'}</span>
                </div>
                <div class="user-card-access">${accessTags}${channelTags}</div>
                <div class="user-card-actions">
                    <button class="user-card-btn edit" onclick="editUser('${user.id}')">✏️ Editar</button>
                    ${!isCurrentUser && isOnline ? `<button class="user-card-btn kick" onclick="kickUser('${user.id}', '${user.nome}')">🚫 Derrubar</button>` : ''}
                    ${!isCurrentUser ? `<button class="user-card-btn delete" onclick="deleteUser('${user.id}', '${user.nome}')">🗑️ Excluir</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    listEl.innerHTML = html;
}

function openUserForm(userId = null) {
    const modal = document.getElementById('user-form-modal');
    const title = document.getElementById('user-form-title');
    const idInput = document.getElementById('user-form-id');
    const editingIdInput = document.getElementById('user-form-editing-id');
    
    // Limpar formulário
    document.getElementById('user-form-id').value = '';
    document.getElementById('user-form-nome').value = '';
    document.getElementById('user-form-pw').value = '';
    document.querySelector('input[name="user-role"][value="user"]').checked = true;
    document.getElementById('user-form-error').textContent = '';
    
    // Resetar checkboxes
    ['comercial', 'estoque', 'compras', 'financeiro', 'usuarios'].forEach(a => {
        document.getElementById('access-' + a).checked = a === 'comercial';
    });
    ['showroom', 'ecommerce', 'mostruario', 'ld'].forEach(c => {
        document.getElementById('channel-' + c).checked = c === 'showroom';
    });
    
    if (userId) {
        // Modo edição
        const user = usersData.find(u => u.id === userId);
        if (!user) return;
        
        title.textContent = 'Editar Usuário';
        editingIdInput.value = userId;
        idInput.value = user.id;
        idInput.disabled = true;
        document.getElementById('user-form-nome').value = user.nome;
        document.querySelector(`input[name="user-role"][value="${user.role}"]`).checked = true;
        
        // Marcar acessos
        ['comercial', 'estoque', 'compras', 'financeiro', 'usuarios'].forEach(a => {
            document.getElementById('access-' + a).checked = (user.access || []).includes(a);
        });
        ['showroom', 'ecommerce', 'mostruario', 'ld'].forEach(c => {
            document.getElementById('channel-' + c).checked = (user.channels || []).includes(c);
        });
    } else {
        // Modo criação
        title.textContent = 'Novo Usuário';
        editingIdInput.value = '';
        idInput.disabled = false;
    }
    
    modal.classList.add('active');
    history.pushState({userForm: true}, '', '');
}

function closeUserForm(fromPopstate) {
    const modal = document.getElementById('user-form-modal');
    if (!modal.classList.contains('active')) return;
    modal.classList.remove('active');
    if (!fromPopstate) {
        // Substituir o estado do pushState sem navegar (não dispara popstate)
        history.replaceState({screen: navHistory[navHistory.length - 1]}, '', '');
    }
}

function editUser(userId) {
    openUserForm(userId);
}

async function saveUser() {
    const errorEl = document.getElementById('user-form-error');
    errorEl.textContent = '';
    
    const editingId = document.getElementById('user-form-editing-id').value;
    const isEditing = !!editingId;
    
    const id = document.getElementById('user-form-id').value.trim().toLowerCase();
    const nome = document.getElementById('user-form-nome').value.trim();
    const pw = document.getElementById('user-form-pw').value;
    const role = document.querySelector('input[name="user-role"]:checked').value;
    
    // Coletar acessos
    const access = [];
    ['comercial', 'estoque', 'compras', 'financeiro', 'usuarios'].forEach(a => {
        if (document.getElementById('access-' + a).checked) access.push(a);
    });
    
    // Coletar canais
    const channels = [];
    ['showroom', 'ecommerce', 'mostruario', 'ld'].forEach(c => {
        if (document.getElementById('channel-' + c).checked) channels.push(c);
    });
    
    // Validações
    if (!id || !nome) {
        errorEl.textContent = 'Preencha login e nome';
        return;
    }
    
    if (!isEditing && !pw) {
        errorEl.textContent = 'Preencha a senha';
        return;
    }
    
    if (access.length === 0) {
        errorEl.textContent = 'Selecione pelo menos um módulo';
        return;
    }
    
    if (channels.length === 0) {
        errorEl.textContent = 'Selecione pelo menos um canal';
        return;
    }
    
    try {
        const url = isEditing 
            ? `${API_CONFIG.baseUrl}/api/users/${editingId}`
            : `${API_CONFIG.baseUrl}/api/users`;
        
        const body = { nome, role, access, channels };
        if (!isEditing) body.id = id;
        if (pw) body.pw = pw;
        
        const userId = currentUser || sessionStorage.getItem('logged-user') || '';
        
        const response = await fetch(url, {
            method: isEditing ? 'PUT' : 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-API-Key': API_CONFIG.apiKey,
                'X-User-Id': userId
            },
            body: JSON.stringify(body)
        });
        
        const data = await response.json();
        
        if (data.error) {
            errorEl.textContent = data.error;
            return;
        }
        
        closeUserForm();
        await loadUsers();
        
    } catch (e) {
        console.error('[Users] Erro ao salvar:', e);
        errorEl.textContent = 'Erro ao salvar usuário';
    }
}

async function deleteUser(userId, nome) {
    if (!confirm(`Excluir usuário "${nome}"?`)) return;
    
    const currentUserId = currentUser || sessionStorage.getItem('logged-user') || '';
    
    try {
        const response = await fetch(`${API_CONFIG.baseUrl}/api/users/${userId}`, {
            method: 'DELETE',
            headers: { 
                'X-API-Key': API_CONFIG.apiKey,
                'X-User-Id': currentUserId
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        await loadUsers();
        
    } catch (e) {
        console.error('[Users] Erro ao excluir:', e);
        alert('Erro ao excluir usuário');
    }
}
</script>

</body></html>